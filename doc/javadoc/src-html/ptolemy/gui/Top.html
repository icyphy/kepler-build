<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>/* Top-level window with a menubar and status bar.<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span> Copyright (c) 1998-2016 The Regents of the University of California.<a name="line.3"></a>
<span class="sourceLineNo">004</span> All rights reserved.<a name="line.4"></a>
<span class="sourceLineNo">005</span> Permission is hereby granted, without written agreement and without<a name="line.5"></a>
<span class="sourceLineNo">006</span> license or royalty fees, to use, copy, modify, and distribute this<a name="line.6"></a>
<span class="sourceLineNo">007</span> software and its documentation for any purpose, provided that the above<a name="line.7"></a>
<span class="sourceLineNo">008</span> copyright notice and the following two paragraphs appear in all copies<a name="line.8"></a>
<span class="sourceLineNo">009</span> of this software.<a name="line.9"></a>
<span class="sourceLineNo">010</span><a name="line.10"></a>
<span class="sourceLineNo">011</span> IN NO EVENT SHALL THE UNIVERSITY OF CALIFORNIA BE LIABLE TO ANY PARTY<a name="line.11"></a>
<span class="sourceLineNo">012</span> FOR DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES<a name="line.12"></a>
<span class="sourceLineNo">013</span> ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF<a name="line.13"></a>
<span class="sourceLineNo">014</span> THE UNIVERSITY OF CALIFORNIA HAS BEEN ADVISED OF THE POSSIBILITY OF<a name="line.14"></a>
<span class="sourceLineNo">015</span> SUCH DAMAGE.<a name="line.15"></a>
<span class="sourceLineNo">016</span><a name="line.16"></a>
<span class="sourceLineNo">017</span> THE UNIVERSITY OF CALIFORNIA SPECIFICALLY DISCLAIMS ANY WARRANTIES,<a name="line.17"></a>
<span class="sourceLineNo">018</span> INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF<a name="line.18"></a>
<span class="sourceLineNo">019</span> MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE SOFTWARE<a name="line.19"></a>
<span class="sourceLineNo">020</span> PROVIDED HEREUNDER IS ON AN "AS IS" BASIS, AND THE UNIVERSITY OF<a name="line.20"></a>
<span class="sourceLineNo">021</span> CALIFORNIA HAS NO OBLIGATION TO PROVIDE MAINTENANCE, SUPPORT, UPDATES,<a name="line.21"></a>
<span class="sourceLineNo">022</span> ENHANCEMENTS, OR MODIFICATIONS.<a name="line.22"></a>
<span class="sourceLineNo">023</span><a name="line.23"></a>
<span class="sourceLineNo">024</span> PT_COPYRIGHT_VERSION_2<a name="line.24"></a>
<span class="sourceLineNo">025</span> COPYRIGHTENDKEY<a name="line.25"></a>
<span class="sourceLineNo">026</span> */<a name="line.26"></a>
<span class="sourceLineNo">027</span>package ptolemy.gui;<a name="line.27"></a>
<span class="sourceLineNo">028</span><a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.awt.BorderLayout;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import java.awt.Color;<a name="line.30"></a>
<span class="sourceLineNo">031</span>import java.awt.Component;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import java.awt.Dimension;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import java.awt.EventQueue;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import java.awt.FileDialog;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import java.awt.Frame;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import java.awt.KeyboardFocusManager;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import java.awt.Toolkit;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import java.awt.Window;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import java.awt.event.ActionEvent;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import java.awt.event.ActionListener;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import java.awt.event.KeyEvent;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import java.awt.event.WindowAdapter;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import java.awt.event.WindowEvent;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import java.awt.event.WindowFocusListener;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import java.awt.print.PageFormat;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import java.awt.print.Pageable;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import java.awt.print.Printable;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import java.awt.print.PrinterException;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import java.awt.print.PrinterJob;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import java.io.BufferedReader;<a name="line.50"></a>
<span class="sourceLineNo">051</span>import java.io.File;<a name="line.51"></a>
<span class="sourceLineNo">052</span>import java.io.FileReader;<a name="line.52"></a>
<span class="sourceLineNo">053</span>import java.io.FileWriter;<a name="line.53"></a>
<span class="sourceLineNo">054</span>import java.io.FilenameFilter;<a name="line.54"></a>
<span class="sourceLineNo">055</span>import java.io.IOException;<a name="line.55"></a>
<span class="sourceLineNo">056</span>import java.lang.reflect.Field;<a name="line.56"></a>
<span class="sourceLineNo">057</span>import java.net.URL;<a name="line.57"></a>
<span class="sourceLineNo">058</span>import java.util.ArrayList;<a name="line.58"></a>
<span class="sourceLineNo">059</span>import java.util.Collections;<a name="line.59"></a>
<span class="sourceLineNo">060</span>import java.util.Iterator;<a name="line.60"></a>
<span class="sourceLineNo">061</span>import java.util.LinkedList;<a name="line.61"></a>
<span class="sourceLineNo">062</span>import java.util.List;<a name="line.62"></a>
<span class="sourceLineNo">063</span>import java.util.Map;<a name="line.63"></a>
<span class="sourceLineNo">064</span>import java.util.Timer;<a name="line.64"></a>
<span class="sourceLineNo">065</span>import java.util.TimerTask;<a name="line.65"></a>
<span class="sourceLineNo">066</span>import java.util.WeakHashMap;<a name="line.66"></a>
<span class="sourceLineNo">067</span><a name="line.67"></a>
<span class="sourceLineNo">068</span>import javax.print.PrintService;<a name="line.68"></a>
<span class="sourceLineNo">069</span>import javax.print.attribute.Attribute;<a name="line.69"></a>
<span class="sourceLineNo">070</span>import javax.print.attribute.HashPrintRequestAttributeSet;<a name="line.70"></a>
<span class="sourceLineNo">071</span>import javax.print.attribute.PrintRequestAttributeSet;<a name="line.71"></a>
<span class="sourceLineNo">072</span>import javax.print.attribute.standard.Destination;<a name="line.72"></a>
<span class="sourceLineNo">073</span>import javax.swing.AbstractAction;<a name="line.73"></a>
<span class="sourceLineNo">074</span>import javax.swing.JFileChooser;<a name="line.74"></a>
<span class="sourceLineNo">075</span>import javax.swing.JFrame;<a name="line.75"></a>
<span class="sourceLineNo">076</span>import javax.swing.JMenu;<a name="line.76"></a>
<span class="sourceLineNo">077</span>import javax.swing.JMenuBar;<a name="line.77"></a>
<span class="sourceLineNo">078</span>import javax.swing.JMenuItem;<a name="line.78"></a>
<span class="sourceLineNo">079</span>import javax.swing.JOptionPane;<a name="line.79"></a>
<span class="sourceLineNo">080</span>import javax.swing.KeyStroke;<a name="line.80"></a>
<span class="sourceLineNo">081</span>import javax.swing.SwingUtilities;<a name="line.81"></a>
<span class="sourceLineNo">082</span>import javax.swing.filechooser.FileFilter;<a name="line.82"></a>
<span class="sourceLineNo">083</span><a name="line.83"></a>
<span class="sourceLineNo">084</span>import ptolemy.util.MessageHandler;<a name="line.84"></a>
<span class="sourceLineNo">085</span>import ptolemy.util.StatusHandler;<a name="line.85"></a>
<span class="sourceLineNo">086</span>import ptolemy.util.StringUtilities;<a name="line.86"></a>
<span class="sourceLineNo">087</span><a name="line.87"></a>
<span class="sourceLineNo">088</span>///////////////////////////////////////////////////////////////////<a name="line.88"></a>
<span class="sourceLineNo">089</span>//// Top<a name="line.89"></a>
<span class="sourceLineNo">090</span><a name="line.90"></a>
<span class="sourceLineNo">091</span>/**<a name="line.91"></a>
<span class="sourceLineNo">092</span> This is a top-level window with a menubar and an optional status bar.<a name="line.92"></a>
<span class="sourceLineNo">093</span> Derived classes should add components to the content pane using a<a name="line.93"></a>
<span class="sourceLineNo">094</span> line like:<a name="line.94"></a>
<span class="sourceLineNo">095</span> &lt;pre&gt;<a name="line.95"></a>
<span class="sourceLineNo">096</span> getContentPane().add(component, BorderLayout.CENTER);<a name="line.96"></a>
<span class="sourceLineNo">097</span> &lt;/pre&gt;<a name="line.97"></a>
<span class="sourceLineNo">098</span> Derived classes may wish to modify the menus.  The File<a name="line.98"></a>
<span class="sourceLineNo">099</span> and Help menus are exposed as protected members.<a name="line.99"></a>
<span class="sourceLineNo">100</span> The File menu items in the _fileMenuItems protected array are,<a name="line.100"></a>
<span class="sourceLineNo">101</span> in order, Open File, Open URL, New, Save, Save As, Print, Close, and Exit.<a name="line.101"></a>
<span class="sourceLineNo">102</span> The Help menu items in the _helpMenuItems protected array are,<a name="line.102"></a>
<span class="sourceLineNo">103</span> in order, About and Help.<a name="line.103"></a>
<span class="sourceLineNo">104</span> &lt;p&gt;<a name="line.104"></a>
<span class="sourceLineNo">105</span> A derived class can use the insert() methods of JMenu<a name="line.105"></a>
<span class="sourceLineNo">106</span> to insert a menu item defined by an Action or a JMenuItem<a name="line.106"></a>
<span class="sourceLineNo">107</span> into a specified position in the menu.<a name="line.107"></a>
<span class="sourceLineNo">108</span> Derived classes can also insert separators using the<a name="line.108"></a>
<span class="sourceLineNo">109</span> insertSeparator() method of JMenu.<a name="line.109"></a>
<span class="sourceLineNo">110</span> In principle, derived classes can also remove menu items<a name="line.110"></a>
<span class="sourceLineNo">111</span> using the remove() methods of JMenu; however, we discourage this.<a name="line.111"></a>
<span class="sourceLineNo">112</span> A basic principle of user interface design is habituation, where<a name="line.112"></a>
<span class="sourceLineNo">113</span> there is considerable value in having menus that have consistent<a name="line.113"></a>
<span class="sourceLineNo">114</span> contents and layout throughout the application (Microsoft, for<a name="line.114"></a>
<span class="sourceLineNo">115</span> example, violates this principle with adaptive menus).<a name="line.115"></a>
<span class="sourceLineNo">116</span> &lt;p&gt;<a name="line.116"></a>
<span class="sourceLineNo">117</span> Instead of removing items from the menu, they can be disabled.<a name="line.117"></a>
<span class="sourceLineNo">118</span> For example, to disable the "Save" item in the File menu, do<a name="line.118"></a>
<span class="sourceLineNo">119</span> &lt;pre&gt;<a name="line.119"></a>
<span class="sourceLineNo">120</span> _fileMenuItems[3].setEnabled(false);<a name="line.120"></a>
<span class="sourceLineNo">121</span> &lt;/pre&gt;<a name="line.121"></a>
<span class="sourceLineNo">122</span> &lt;p&gt;<a name="line.122"></a>
<span class="sourceLineNo">123</span> Some menu items are provided, but are disabled by default.<a name="line.123"></a>
<span class="sourceLineNo">124</span> The "New" item, for example, can be enabled with<a name="line.124"></a>
<span class="sourceLineNo">125</span> &lt;pre&gt;<a name="line.125"></a>
<span class="sourceLineNo">126</span> _fileMenuItems[2].setEnabled(true);<a name="line.126"></a>
<span class="sourceLineNo">127</span> &lt;/pre&gt;<a name="line.127"></a>
<span class="sourceLineNo">128</span> A derived class that enables this menu item can populate the menu with<a name="line.128"></a>
<span class="sourceLineNo">129</span> submenu items.  This particular entry in the _fileMenuItems[2]<a name="line.129"></a>
<span class="sourceLineNo">130</span> is a JMenu, not just a JMenuItem, so it can have menu items<a name="line.130"></a>
<span class="sourceLineNo">131</span> added to it.<a name="line.131"></a>
<span class="sourceLineNo">132</span> &lt;p&gt;<a name="line.132"></a>
<span class="sourceLineNo">133</span> A derived class can add an entirely new menu (many do that).<a name="line.133"></a>
<span class="sourceLineNo">134</span> However, at this time, the JMenuBar interface does not support<a name="line.134"></a>
<span class="sourceLineNo">135</span> putting a new menu into an arbitrary position.  For this reason,<a name="line.135"></a>
<span class="sourceLineNo">136</span> derived classes should insert new menus into the menu bar only<a name="line.136"></a>
<span class="sourceLineNo">137</span> in the _addMenus() protected method.  This ensures that the File<a name="line.137"></a>
<span class="sourceLineNo">138</span> menu is always the rightmost menu, and the Help menu is always<a name="line.138"></a>
<span class="sourceLineNo">139</span> the leftmost menu.  The _addMenus() method is called when the window<a name="line.139"></a>
<span class="sourceLineNo">140</span> is first packed.<a name="line.140"></a>
<span class="sourceLineNo">141</span><a name="line.141"></a>
<span class="sourceLineNo">142</span> @author Edward A. Lee and Steve Neuendorffer<a name="line.142"></a>
<span class="sourceLineNo">143</span> @version $Id$<a name="line.143"></a>
<span class="sourceLineNo">144</span> @since Ptolemy II 1.0<a name="line.144"></a>
<span class="sourceLineNo">145</span> @Pt.ProposedRating Yellow (eal)<a name="line.145"></a>
<span class="sourceLineNo">146</span> @Pt.AcceptedRating Yellow (janneck)<a name="line.146"></a>
<span class="sourceLineNo">147</span> */<a name="line.147"></a>
<span class="sourceLineNo">148</span>@SuppressWarnings("serial")<a name="line.148"></a>
<span class="sourceLineNo">149</span>public abstract class Top extends JFrame<a name="line.149"></a>
<span class="sourceLineNo">150</span>        implements WindowFocusListener, StatusHandler {<a name="line.150"></a>
<span class="sourceLineNo">151</span><a name="line.151"></a>
<span class="sourceLineNo">152</span>    /** Construct an empty top-level frame with the default status<a name="line.152"></a>
<span class="sourceLineNo">153</span>     *  bar.  After constructing this, it is necessary to call<a name="line.153"></a>
<span class="sourceLineNo">154</span>     *  pack() to have the menus added, and then setVisible(true)<a name="line.154"></a>
<span class="sourceLineNo">155</span>     *  to make the frame appear.  It may also be desirable to<a name="line.155"></a>
<span class="sourceLineNo">156</span>     *  call centerOnScreen().  This can be done after<a name="line.156"></a>
<span class="sourceLineNo">157</span>     *  pack() and before setVisible().<a name="line.157"></a>
<span class="sourceLineNo">158</span>     */<a name="line.158"></a>
<span class="sourceLineNo">159</span>    public Top() {<a name="line.159"></a>
<span class="sourceLineNo">160</span>        this(new StatusBar());<a name="line.160"></a>
<span class="sourceLineNo">161</span>    }<a name="line.161"></a>
<span class="sourceLineNo">162</span><a name="line.162"></a>
<span class="sourceLineNo">163</span>    /** Construct an empty top-level frame with the specified status<a name="line.163"></a>
<span class="sourceLineNo">164</span>     *  bar.  After constructing this,<a name="line.164"></a>
<span class="sourceLineNo">165</span>     *  it is necessary to call pack() to have the menus added, and<a name="line.165"></a>
<span class="sourceLineNo">166</span>     *  then setVisible(true) to make the frame appear.  It may also<a name="line.166"></a>
<span class="sourceLineNo">167</span>     *  be desirable to call centerOnScreen().  This can be done after<a name="line.167"></a>
<span class="sourceLineNo">168</span>     *  pack() and before setVisible().<a name="line.168"></a>
<span class="sourceLineNo">169</span>     *  @param statusBar A status bar, or null to not insert one.<a name="line.169"></a>
<span class="sourceLineNo">170</span>     */<a name="line.170"></a>
<span class="sourceLineNo">171</span>    public Top(StatusBar statusBar) {<a name="line.171"></a>
<span class="sourceLineNo">172</span>        super();<a name="line.172"></a>
<span class="sourceLineNo">173</span><a name="line.173"></a>
<span class="sourceLineNo">174</span>        _statusBar = statusBar;<a name="line.174"></a>
<span class="sourceLineNo">175</span><a name="line.175"></a>
<span class="sourceLineNo">176</span>        // Ensure that user is prompted before closing if the data<a name="line.176"></a>
<span class="sourceLineNo">177</span>        // has been modified.<a name="line.177"></a>
<span class="sourceLineNo">178</span>        setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);<a name="line.178"></a>
<span class="sourceLineNo">179</span>        addWindowListener(new CloseWindowAdapter());<a name="line.179"></a>
<span class="sourceLineNo">180</span><a name="line.180"></a>
<span class="sourceLineNo">181</span>        getContentPane().setLayout(new BorderLayout());<a name="line.181"></a>
<span class="sourceLineNo">182</span><a name="line.182"></a>
<span class="sourceLineNo">183</span>        _fileMenuListener = new FileMenuListener();<a name="line.183"></a>
<span class="sourceLineNo">184</span>        _helpMenuListener = new HelpMenuListener();<a name="line.184"></a>
<span class="sourceLineNo">185</span>        _historyMenuListener = new HistoryMenuListener();<a name="line.185"></a>
<span class="sourceLineNo">186</span><a name="line.186"></a>
<span class="sourceLineNo">187</span>        // Make this the default context for modal messages.<a name="line.187"></a>
<span class="sourceLineNo">188</span>        UndeferredGraphicalMessageHandler.setContext(this);<a name="line.188"></a>
<span class="sourceLineNo">189</span><a name="line.189"></a>
<span class="sourceLineNo">190</span>        // If we are on a Mac, initialize the quit menu<a name="line.190"></a>
<span class="sourceLineNo">191</span>        // so that Command-Q saves data.<a name="line.191"></a>
<span class="sourceLineNo">192</span>        if (PtGUIUtilities.macOSLookAndFeel()) {<a name="line.192"></a>
<span class="sourceLineNo">193</span>            _macInitializer();<a name="line.193"></a>
<span class="sourceLineNo">194</span>        }<a name="line.194"></a>
<span class="sourceLineNo">195</span><a name="line.195"></a>
<span class="sourceLineNo">196</span>        addWindowFocusListener(this);<a name="line.196"></a>
<span class="sourceLineNo">197</span>    }<a name="line.197"></a>
<span class="sourceLineNo">198</span><a name="line.198"></a>
<span class="sourceLineNo">199</span>    ///////////////////////////////////////////////////////////////////<a name="line.199"></a>
<span class="sourceLineNo">200</span>    ////                         public methods                    ////<a name="line.200"></a>
<span class="sourceLineNo">201</span><a name="line.201"></a>
<span class="sourceLineNo">202</span>    /** Open a dialog with basic information about this window.<a name="line.202"></a>
<span class="sourceLineNo">203</span>     *  Derived classes may override {@link #_about()}.<a name="line.203"></a>
<span class="sourceLineNo">204</span>     */<a name="line.204"></a>
<span class="sourceLineNo">205</span>    public final void about() {<a name="line.205"></a>
<span class="sourceLineNo">206</span>        // Under Mac OS X, the "About" menu choice invokes this method.<a name="line.206"></a>
<span class="sourceLineNo">207</span>        _about();<a name="line.207"></a>
<span class="sourceLineNo">208</span>    }<a name="line.208"></a>
<span class="sourceLineNo">209</span><a name="line.209"></a>
<span class="sourceLineNo">210</span>    /** Center the window on the screen.  This must be called after the<a name="line.210"></a>
<span class="sourceLineNo">211</span>     *  window is populated with its contents, since it depends on the size<a name="line.211"></a>
<span class="sourceLineNo">212</span>     *  being known. If this method is called from a thread that is not<a name="line.212"></a>
<span class="sourceLineNo">213</span>     *  the AWT event dispatch thread, then its execution is deferred<a name="line.213"></a>
<span class="sourceLineNo">214</span>     *  and performed in that thread.<a name="line.214"></a>
<span class="sourceLineNo">215</span>     */<a name="line.215"></a>
<span class="sourceLineNo">216</span>    public void centerOnScreen() {<a name="line.216"></a>
<span class="sourceLineNo">217</span>        Runnable doCenter = new CenterOnScreenRunnable();<a name="line.217"></a>
<span class="sourceLineNo">218</span><a name="line.218"></a>
<span class="sourceLineNo">219</span>        deferIfNecessary(doCenter);<a name="line.219"></a>
<span class="sourceLineNo">220</span>    }<a name="line.220"></a>
<span class="sourceLineNo">221</span><a name="line.221"></a>
<span class="sourceLineNo">222</span>    /** Close the window, prompting the user to save changes if there<a name="line.222"></a>
<span class="sourceLineNo">223</span>     *  have been any.  Derived classes should override the protected<a name="line.223"></a>
<span class="sourceLineNo">224</span>     *  method _close(), not this one. This method returns immediately<a name="line.224"></a>
<span class="sourceLineNo">225</span>     *  if it is called outside the swing UI thread, deferring the action<a name="line.225"></a>
<span class="sourceLineNo">226</span>     *  so that it is executed in the swing thread.<a name="line.226"></a>
<span class="sourceLineNo">227</span>     */<a name="line.227"></a>
<span class="sourceLineNo">228</span>    public final void close() {<a name="line.228"></a>
<span class="sourceLineNo">229</span>        if (_debugClosing) {<a name="line.229"></a>
<span class="sourceLineNo">230</span>            System.out.println("Top.close() : " + this.getName());<a name="line.230"></a>
<span class="sourceLineNo">231</span>        }<a name="line.231"></a>
<span class="sourceLineNo">232</span><a name="line.232"></a>
<span class="sourceLineNo">233</span>        Runnable doClose = new CloseWindowRunnable();<a name="line.233"></a>
<span class="sourceLineNo">234</span><a name="line.234"></a>
<span class="sourceLineNo">235</span>        deferIfNecessary(doClose);<a name="line.235"></a>
<span class="sourceLineNo">236</span>    }<a name="line.236"></a>
<span class="sourceLineNo">237</span><a name="line.237"></a>
<span class="sourceLineNo">238</span>    /** If this method is called in the AWT event dispatch thread,<a name="line.238"></a>
<span class="sourceLineNo">239</span>     *  then simply execute the specified action.  Otherwise,<a name="line.239"></a>
<span class="sourceLineNo">240</span>     *  if there are already deferred actions, then add the specified<a name="line.240"></a>
<span class="sourceLineNo">241</span>     *  one to the list.  Otherwise, create a list of deferred actions,<a name="line.241"></a>
<span class="sourceLineNo">242</span>     *  if necessary, and request that the list be processed in the<a name="line.242"></a>
<span class="sourceLineNo">243</span>     *  event dispatch thread.<a name="line.243"></a>
<span class="sourceLineNo">244</span>     *  &lt;p&gt;<a name="line.244"></a>
<span class="sourceLineNo">245</span>     *  Note that it does not work nearly as well to simply schedule<a name="line.245"></a>
<span class="sourceLineNo">246</span>     *  the action yourself on the event thread because if there are a<a name="line.246"></a>
<span class="sourceLineNo">247</span>     *  large number of actions, then the event thread will not be able<a name="line.247"></a>
<span class="sourceLineNo">248</span>     *  to keep up.  By grouping these actions, we avoid this problem.<a name="line.248"></a>
<span class="sourceLineNo">249</span>     *  @param action The Runnable object to execute.<a name="line.249"></a>
<span class="sourceLineNo">250</span>     */<a name="line.250"></a>
<span class="sourceLineNo">251</span>    public static void deferIfNecessary(Runnable action) {<a name="line.251"></a>
<span class="sourceLineNo">252</span>        // NOTE: This is a static version of a method in PlotBox, but<a name="line.252"></a>
<span class="sourceLineNo">253</span>        // we do not want to create cross dependencies between these<a name="line.253"></a>
<span class="sourceLineNo">254</span>        // packages.<a name="line.254"></a>
<span class="sourceLineNo">255</span>        // In swing, updates to showing graphics must be done in the<a name="line.255"></a>
<span class="sourceLineNo">256</span>        // event thread.  If we are in the event thread, then proceed.<a name="line.256"></a>
<span class="sourceLineNo">257</span>        // Otherwise, queue a request or add to a pending request.<a name="line.257"></a>
<span class="sourceLineNo">258</span>        if (EventQueue.isDispatchThread()) {<a name="line.258"></a>
<span class="sourceLineNo">259</span>            action.run();<a name="line.259"></a>
<span class="sourceLineNo">260</span>        } else {<a name="line.260"></a>
<span class="sourceLineNo">261</span>            synchronized (_deferredActions) {<a name="line.261"></a>
<span class="sourceLineNo">262</span>                // Add the specified action to the list of actions to perform.<a name="line.262"></a>
<span class="sourceLineNo">263</span>                _deferredActions.add(action);<a name="line.263"></a>
<span class="sourceLineNo">264</span><a name="line.264"></a>
<span class="sourceLineNo">265</span>                // If it hasn't already been requested, request that actions<a name="line.265"></a>
<span class="sourceLineNo">266</span>                // be performed in the event dispatch thread.<a name="line.266"></a>
<span class="sourceLineNo">267</span>                if (!_actionsDeferred) {<a name="line.267"></a>
<span class="sourceLineNo">268</span>                    Runnable doActions = new DeferredActionsRunnable();<a name="line.268"></a>
<span class="sourceLineNo">269</span><a name="line.269"></a>
<span class="sourceLineNo">270</span>                    // NOTE: Using invokeAndWait() here risks causing<a name="line.270"></a>
<span class="sourceLineNo">271</span>                    // deadlock.  Don't do it!<a name="line.271"></a>
<span class="sourceLineNo">272</span>                    SwingUtilities.invokeLater(doActions);<a name="line.272"></a>
<span class="sourceLineNo">273</span>                    _actionsDeferred = true;<a name="line.273"></a>
<span class="sourceLineNo">274</span>                }<a name="line.274"></a>
<span class="sourceLineNo">275</span>            }<a name="line.275"></a>
<span class="sourceLineNo">276</span>        }<a name="line.276"></a>
<span class="sourceLineNo">277</span>    }<a name="line.277"></a>
<span class="sourceLineNo">278</span><a name="line.278"></a>
<span class="sourceLineNo">279</span>    /** Dispose of this frame.<a name="line.279"></a>
<span class="sourceLineNo">280</span>     *     Override this dispose() method to unattach any listeners that may keep<a name="line.280"></a>
<span class="sourceLineNo">281</span>     *  this model from getting garbage collected.  This method invokes the<a name="line.281"></a>
<span class="sourceLineNo">282</span>     *  dispose() method of the superclass,<a name="line.282"></a>
<span class="sourceLineNo">283</span>     *  {@link javax.swing.JFrame}.<a name="line.283"></a>
<span class="sourceLineNo">284</span>     */<a name="line.284"></a>
<span class="sourceLineNo">285</span>    @Override<a name="line.285"></a>
<span class="sourceLineNo">286</span>    public void dispose() {<a name="line.286"></a>
<span class="sourceLineNo">287</span>        if (_debugClosing) {<a name="line.287"></a>
<span class="sourceLineNo">288</span>            System.out.println("Top.dispose() : " + this.getName());<a name="line.288"></a>
<span class="sourceLineNo">289</span>        }<a name="line.289"></a>
<span class="sourceLineNo">290</span><a name="line.290"></a>
<span class="sourceLineNo">291</span>        removeWindowFocusListener(this);<a name="line.291"></a>
<span class="sourceLineNo">292</span><a name="line.292"></a>
<span class="sourceLineNo">293</span>        // Deal with help menu action listeners<a name="line.293"></a>
<span class="sourceLineNo">294</span>        /*int c =*/MemoryCleaner.removeActionListeners(_historyMenu);<a name="line.294"></a>
<span class="sourceLineNo">295</span>        //System.out.println("_historyMenu: "+c);<a name="line.295"></a>
<span class="sourceLineNo">296</span>        if (_historyMenu != null) {<a name="line.296"></a>
<span class="sourceLineNo">297</span>            _historyMenusAndListeners.remove(_historyMenu);<a name="line.297"></a>
<span class="sourceLineNo">298</span>        }<a name="line.298"></a>
<span class="sourceLineNo">299</span>        _historyMenuListener = null;<a name="line.299"></a>
<span class="sourceLineNo">300</span><a name="line.300"></a>
<span class="sourceLineNo">301</span>        // Don't call removeWindowListeners here because Tableau.setFrame()<a name="line.301"></a>
<span class="sourceLineNo">302</span>        // adds a WindowListener to windowsClosed events and that listener<a name="line.302"></a>
<span class="sourceLineNo">303</span>        // handles closing the plots associated with a model.<a name="line.303"></a>
<span class="sourceLineNo">304</span>        //MemoryCleaner.removeWindowListeners(this);<a name="line.304"></a>
<span class="sourceLineNo">305</span><a name="line.305"></a>
<span class="sourceLineNo">306</span>        // Deal with file menu action listeners<a name="line.306"></a>
<span class="sourceLineNo">307</span>        /*c =*/MemoryCleaner.removeActionListeners(_fileMenu);<a name="line.307"></a>
<span class="sourceLineNo">308</span>        //System.out.println("_fileMenu: "+c);<a name="line.308"></a>
<span class="sourceLineNo">309</span>        for (JMenuItem menuItem : _fileMenuItems) {<a name="line.309"></a>
<span class="sourceLineNo">310</span>            /*c =*/MemoryCleaner.removeActionListeners(menuItem);<a name="line.310"></a>
<span class="sourceLineNo">311</span>            //System.out.println("_fileMenuItems["+i+"]: "+c);<a name="line.311"></a>
<span class="sourceLineNo">312</span>        }<a name="line.312"></a>
<span class="sourceLineNo">313</span>        _fileMenuListener = null;<a name="line.313"></a>
<span class="sourceLineNo">314</span><a name="line.314"></a>
<span class="sourceLineNo">315</span>        // Deal with help menu action listeners<a name="line.315"></a>
<span class="sourceLineNo">316</span>        /*c =*/MemoryCleaner.removeActionListeners(_helpMenu);<a name="line.316"></a>
<span class="sourceLineNo">317</span>        //System.out.println("_helpMenu: "+c);<a name="line.317"></a>
<span class="sourceLineNo">318</span>        for (JMenuItem menuItem : _helpMenuItems) {<a name="line.318"></a>
<span class="sourceLineNo">319</span>            /*c =*/MemoryCleaner.removeActionListeners(menuItem);<a name="line.319"></a>
<span class="sourceLineNo">320</span>            //System.out.println("_helpMenuItems["+i+"]: "+c);<a name="line.320"></a>
<span class="sourceLineNo">321</span>        }<a name="line.321"></a>
<span class="sourceLineNo">322</span>        _helpMenuListener = null;<a name="line.322"></a>
<span class="sourceLineNo">323</span><a name="line.323"></a>
<span class="sourceLineNo">324</span>        /*c =*/MemoryCleaner.removeActionListeners(_menubar);<a name="line.324"></a>
<span class="sourceLineNo">325</span>        //System.out.println("_menubar: "+c);<a name="line.325"></a>
<span class="sourceLineNo">326</span>        _menubar.removeAll();<a name="line.326"></a>
<span class="sourceLineNo">327</span><a name="line.327"></a>
<span class="sourceLineNo">328</span>        // ensure reference to this is removed<a name="line.328"></a>
<span class="sourceLineNo">329</span>        UndeferredGraphicalMessageHandler.setContext(null);<a name="line.329"></a>
<span class="sourceLineNo">330</span><a name="line.330"></a>
<span class="sourceLineNo">331</span>        // I'm not sure exactly why this works but it does!<a name="line.331"></a>
<span class="sourceLineNo">332</span>        // I think it has to do with the KeyboardFocusManager<a name="line.332"></a>
<span class="sourceLineNo">333</span>        // holding onto the last focused component, so clearing and<a name="line.333"></a>
<span class="sourceLineNo">334</span>        // cycling seems to free up the reference to this window.<a name="line.334"></a>
<span class="sourceLineNo">335</span>        KeyboardFocusManager focusManager = KeyboardFocusManager<a name="line.335"></a>
<span class="sourceLineNo">336</span>                .getCurrentKeyboardFocusManager();<a name="line.336"></a>
<span class="sourceLineNo">337</span>        focusManager.clearGlobalFocusOwner();<a name="line.337"></a>
<span class="sourceLineNo">338</span>        focusManager.downFocusCycle();<a name="line.338"></a>
<span class="sourceLineNo">339</span><a name="line.339"></a>
<span class="sourceLineNo">340</span>        // Avoid a leak under RHEL and Java 1.8.0_55<a name="line.340"></a>
<span class="sourceLineNo">341</span>        // See https://wiki.eecs.berkeley.edu/ptexternal/Main/Main/MemoryLeaks#LinuxBltSubRegion<a name="line.341"></a>
<span class="sourceLineNo">342</span>        // http://oracle.developer-works.com/article/5359339/How+to+realy+unregister+listeners+%28or+how+%22great%22+swing+leaks+memory%29<a name="line.342"></a>
<span class="sourceLineNo">343</span>        focusManager.setGlobalCurrentFocusCycleRoot(null);<a name="line.343"></a>
<span class="sourceLineNo">344</span><a name="line.344"></a>
<span class="sourceLineNo">345</span>        // Set any AbstractActions to null.  This is not strictly necessary,<a name="line.345"></a>
<span class="sourceLineNo">346</span>        // but it helps free up memory more quickly.  By doing this here,<a name="line.346"></a>
<span class="sourceLineNo">347</span>        // we no longer require people to update dispose() by hand.<a name="line.347"></a>
<span class="sourceLineNo">348</span>        Class myClass = getClass();<a name="line.348"></a>
<span class="sourceLineNo">349</span>        // Loop through classes up to the parent class of Top.<a name="line.349"></a>
<span class="sourceLineNo">350</span>        while (myClass != JFrame.class) {<a name="line.350"></a>
<span class="sourceLineNo">351</span>            Field[] fields = myClass.getDeclaredFields();<a name="line.351"></a>
<span class="sourceLineNo">352</span>            for (Field field : fields) {<a name="line.352"></a>
<span class="sourceLineNo">353</span>                try {<a name="line.353"></a>
<span class="sourceLineNo">354</span>                    // Loop through the class hierarchy of each field.<a name="line.354"></a>
<span class="sourceLineNo">355</span>                    // If the class is assignable from AbstractAction, then<a name="line.355"></a>
<span class="sourceLineNo">356</span>                    // set it to null.<a name="line.356"></a>
<span class="sourceLineNo">357</span>                    Class superclass = field.getType();<a name="line.357"></a>
<span class="sourceLineNo">358</span>                    while (superclass != null &amp;&amp; superclass != Object.class) {<a name="line.358"></a>
<span class="sourceLineNo">359</span>                        if (superclass.isAssignableFrom(AbstractAction.class)) {<a name="line.359"></a>
<span class="sourceLineNo">360</span>                            try {<a name="line.360"></a>
<span class="sourceLineNo">361</span>                                field.setAccessible(true);<a name="line.361"></a>
<span class="sourceLineNo">362</span>                                field.set(this, null);<a name="line.362"></a>
<span class="sourceLineNo">363</span>                            } catch (SecurityException ex) {<a name="line.363"></a>
<span class="sourceLineNo">364</span>                                if (!_printedSecurityExceptionMessage) {<a name="line.364"></a>
<span class="sourceLineNo">365</span>                                    _printedSecurityExceptionMessage = true;<a name="line.365"></a>
<span class="sourceLineNo">366</span>                                    System.out.println("Warning: Failed set "<a name="line.366"></a>
<span class="sourceLineNo">367</span>                                            + field<a name="line.367"></a>
<span class="sourceLineNo">368</span>                                            + " accessible while disposing. "<a name="line.368"></a>
<span class="sourceLineNo">369</span>                                            + "(applets and -sandbox always causes this)");<a name="line.369"></a>
<span class="sourceLineNo">370</span>                                }<a name="line.370"></a>
<span class="sourceLineNo">371</span>                            }<a name="line.371"></a>
<span class="sourceLineNo">372</span>                            break;<a name="line.372"></a>
<span class="sourceLineNo">373</span>                        }<a name="line.373"></a>
<span class="sourceLineNo">374</span>                        superclass = superclass.getSuperclass();<a name="line.374"></a>
<span class="sourceLineNo">375</span>                    }<a name="line.375"></a>
<span class="sourceLineNo">376</span>                } catch (IllegalAccessException ex) {<a name="line.376"></a>
<span class="sourceLineNo">377</span>                    throw new RuntimeException(<a name="line.377"></a>
<span class="sourceLineNo">378</span>                            "Failed to get or set field " + field, ex);<a name="line.378"></a>
<span class="sourceLineNo">379</span>                }<a name="line.379"></a>
<span class="sourceLineNo">380</span>            }<a name="line.380"></a>
<span class="sourceLineNo">381</span>            myClass = myClass.getSuperclass();<a name="line.381"></a>
<span class="sourceLineNo">382</span>        }<a name="line.382"></a>
<span class="sourceLineNo">383</span><a name="line.383"></a>
<span class="sourceLineNo">384</span>        getContentPane().removeAll();<a name="line.384"></a>
<span class="sourceLineNo">385</span>        _disposed = true;<a name="line.385"></a>
<span class="sourceLineNo">386</span><a name="line.386"></a>
<span class="sourceLineNo">387</span>        java.awt.image.BufferStrategy bufferStrategy = getBufferStrategy();<a name="line.387"></a>
<span class="sourceLineNo">388</span>        if (bufferStrategy != null) {<a name="line.388"></a>
<span class="sourceLineNo">389</span>            bufferStrategy.dispose();<a name="line.389"></a>
<span class="sourceLineNo">390</span>        }<a name="line.390"></a>
<span class="sourceLineNo">391</span><a name="line.391"></a>
<span class="sourceLineNo">392</span>        // Sigh.  Under Mac OS X, we need to deal with the peers by hand.<a name="line.392"></a>
<span class="sourceLineNo">393</span>        // This code is left commented out because it is Mac-specific and<a name="line.393"></a>
<span class="sourceLineNo">394</span>        // accessing ComponentPeer produces a warning.<a name="line.394"></a>
<span class="sourceLineNo">395</span><a name="line.395"></a>
<span class="sourceLineNo">396</span>        // See https://wiki.eecs.berkeley.edu/ptexternal/Main/Main/MemoryLeaks#CPlatformWindow<a name="line.396"></a>
<span class="sourceLineNo">397</span>        // See http://stackoverflow.com/questions/19781877/mac-os-java-7-jdialog-dispose-memory-leak<a name="line.397"></a>
<span class="sourceLineNo">398</span><a name="line.398"></a>
<span class="sourceLineNo">399</span>        // java.awt.peer.ComponentPeer peer = getPeer();<a name="line.399"></a>
<span class="sourceLineNo">400</span><a name="line.400"></a>
<span class="sourceLineNo">401</span>        super.dispose();<a name="line.401"></a>
<span class="sourceLineNo">402</span><a name="line.402"></a>
<span class="sourceLineNo">403</span>        // if (peer != null) {<a name="line.403"></a>
<span class="sourceLineNo">404</span>        //     try {<a name="line.404"></a>
<span class="sourceLineNo">405</span>        //         Class&lt;?&gt; componentPeerClass = Class.forName("sun.lwawt.LWComponentPeer");<a name="line.405"></a>
<span class="sourceLineNo">406</span>        //         Field target = componentPeerClass.getDeclaredField("target");<a name="line.406"></a>
<span class="sourceLineNo">407</span>        //         target.setAccessible(true);<a name="line.407"></a>
<span class="sourceLineNo">408</span>        //         target.set(peer, null);<a name="line.408"></a>
<span class="sourceLineNo">409</span><a name="line.409"></a>
<span class="sourceLineNo">410</span>        //         Field window = peer.getClass().getDeclaredField("platformWindow");<a name="line.410"></a>
<span class="sourceLineNo">411</span>        //         window.setAccessible(true);<a name="line.411"></a>
<span class="sourceLineNo">412</span><a name="line.412"></a>
<span class="sourceLineNo">413</span>        //         Object platformWindow = window.get(peer);<a name="line.413"></a>
<span class="sourceLineNo">414</span>        //         target = platformWindow.getClass().getDeclaredField("target");<a name="line.414"></a>
<span class="sourceLineNo">415</span>        //         target.setAccessible(true);<a name="line.415"></a>
<span class="sourceLineNo">416</span>        //         target.set(platformWindow, null);<a name="line.416"></a>
<span class="sourceLineNo">417</span><a name="line.417"></a>
<span class="sourceLineNo">418</span>        //     } catch (Throwable throwable) {<a name="line.418"></a>
<span class="sourceLineNo">419</span>        //         if (_debugClosing) {<a name="line.419"></a>
<span class="sourceLineNo">420</span>        //             throwable.printStackTrace();<a name="line.420"></a>
<span class="sourceLineNo">421</span>        //         }<a name="line.421"></a>
<span class="sourceLineNo">422</span>        //     }<a name="line.422"></a>
<span class="sourceLineNo">423</span>        // }<a name="line.423"></a>
<span class="sourceLineNo">424</span>    }<a name="line.424"></a>
<span class="sourceLineNo">425</span><a name="line.425"></a>
<span class="sourceLineNo">426</span>    /** Exit the application after querying the user to save data.<a name="line.426"></a>
<span class="sourceLineNo">427</span>     *  Derived classes should override {@link #_exit()}.<a name="line.427"></a>
<span class="sourceLineNo">428</span>     *  @return False if the use cancelled a saving a modified buffer,<a name="line.428"></a>
<span class="sourceLineNo">429</span>     *  true otherwise.<a name="line.429"></a>
<span class="sourceLineNo">430</span>     */<a name="line.430"></a>
<span class="sourceLineNo">431</span>    public final boolean exit() {<a name="line.431"></a>
<span class="sourceLineNo">432</span>        // Under Mac OS X, Command-q invokes this method.<a name="line.432"></a>
<span class="sourceLineNo">433</span>        if (_debugClosing) {<a name="line.433"></a>
<span class="sourceLineNo">434</span>            System.out.println("Top.exit() : " + this.getName());<a name="line.434"></a>
<span class="sourceLineNo">435</span>        }<a name="line.435"></a>
<span class="sourceLineNo">436</span>        _exit();<a name="line.436"></a>
<span class="sourceLineNo">437</span>        if (_exitResult == _CANCELED) {<a name="line.437"></a>
<span class="sourceLineNo">438</span>            return false;<a name="line.438"></a>
<span class="sourceLineNo">439</span>        }<a name="line.439"></a>
<span class="sourceLineNo">440</span>        return true;<a name="line.440"></a>
<span class="sourceLineNo">441</span>    }<a name="line.441"></a>
<span class="sourceLineNo">442</span><a name="line.442"></a>
<span class="sourceLineNo">443</span>    /** Return true if the window is set to be centered when pack() is called.<a name="line.443"></a>
<span class="sourceLineNo">444</span>     *  @return True if the window will be centered when pack is called.<a name="line.444"></a>
<span class="sourceLineNo">445</span>     *  @see #setCentering(boolean)<a name="line.445"></a>
<span class="sourceLineNo">446</span>     */<a name="line.446"></a>
<span class="sourceLineNo">447</span>    public boolean getCentering() {<a name="line.447"></a>
<span class="sourceLineNo">448</span>        return _centering;<a name="line.448"></a>
<span class="sourceLineNo">449</span>    }<a name="line.449"></a>
<span class="sourceLineNo">450</span><a name="line.450"></a>
<span class="sourceLineNo">451</span>    /** Return the size of the contents of this window.<a name="line.451"></a>
<span class="sourceLineNo">452</span>     *  @return The size of the contents.<a name="line.452"></a>
<span class="sourceLineNo">453</span>     */<a name="line.453"></a>
<span class="sourceLineNo">454</span>    public Dimension getContentSize() {<a name="line.454"></a>
<span class="sourceLineNo">455</span>        return getContentPane().getSize();<a name="line.455"></a>
<span class="sourceLineNo">456</span>    }<a name="line.456"></a>
<span class="sourceLineNo">457</span><a name="line.457"></a>
<span class="sourceLineNo">458</span>    /** If called before the first time pack() is called, this<a name="line.458"></a>
<span class="sourceLineNo">459</span>     *  method will prevent the appearance of a menu bar. This is<a name="line.459"></a>
<span class="sourceLineNo">460</span>     *  rarely desirable, but some subclasses of Top have to<a name="line.460"></a>
<span class="sourceLineNo">461</span>     *  contain panels that are not swing components. Such<a name="line.461"></a>
<span class="sourceLineNo">462</span>     *  components do not work with menus (the menu seems to<a name="line.462"></a>
<span class="sourceLineNo">463</span>     *  appear behind the component instead of in front of it).<a name="line.463"></a>
<span class="sourceLineNo">464</span>     *  Call this to prevent a menu bar.<a name="line.464"></a>
<span class="sourceLineNo">465</span>     */<a name="line.465"></a>
<span class="sourceLineNo">466</span>    public void hideMenuBar() {<a name="line.466"></a>
<span class="sourceLineNo">467</span>        _hideMenuBar = true;<a name="line.467"></a>
<span class="sourceLineNo">468</span>    }<a name="line.468"></a>
<span class="sourceLineNo">469</span><a name="line.469"></a>
<span class="sourceLineNo">470</span>    /** Return true if this frame has been disposed.<a name="line.470"></a>
<span class="sourceLineNo">471</span>     *  It is possible for the dispose() method to be called directly.<a name="line.471"></a>
<span class="sourceLineNo">472</span>     *  This may conflict with another dispose call<a name="line.472"></a>
<span class="sourceLineNo">473</span>     *  in a window listener or somewhere else.  Before Top<a name="line.473"></a>
<span class="sourceLineNo">474</span>     *  calls super.dispose() (and thus triggering listeners) this<a name="line.474"></a>
<span class="sourceLineNo">475</span>     *  boolean is set to true so listeners can check and make sure<a name="line.475"></a>
<span class="sourceLineNo">476</span>     *  they aren't calling dispose for a second (or third) time.<a name="line.476"></a>
<span class="sourceLineNo">477</span>     *  @return true if this frame has been disposed.<a name="line.477"></a>
<span class="sourceLineNo">478</span>     */<a name="line.478"></a>
<span class="sourceLineNo">479</span>    public boolean isDisposed() {<a name="line.479"></a>
<span class="sourceLineNo">480</span>        return _disposed;<a name="line.480"></a>
<span class="sourceLineNo">481</span>    }<a name="line.481"></a>
<span class="sourceLineNo">482</span><a name="line.482"></a>
<span class="sourceLineNo">483</span>    /** Return true if the menu of this window has been populated.<a name="line.483"></a>
<span class="sourceLineNo">484</span>     *  The menu is populated as a side effect of the first invocation to<a name="line.484"></a>
<span class="sourceLineNo">485</span>     *  the pack() method.<a name="line.485"></a>
<span class="sourceLineNo">486</span>     *  @return True if the menu bar has been populated.<a name="line.486"></a>
<span class="sourceLineNo">487</span>     */<a name="line.487"></a>
<span class="sourceLineNo">488</span>    public synchronized boolean isMenuPopulated() {<a name="line.488"></a>
<span class="sourceLineNo">489</span>        return _menuPopulated;<a name="line.489"></a>
<span class="sourceLineNo">490</span>    }<a name="line.490"></a>
<span class="sourceLineNo">491</span><a name="line.491"></a>
<span class="sourceLineNo">492</span>    /** Return true if the data associated with this window has been<a name="line.492"></a>
<span class="sourceLineNo">493</span>     *  modified since it was first read or last saved.  This returns<a name="line.493"></a>
<span class="sourceLineNo">494</span>     *  the value set by calls to setModified(), or false if that method<a name="line.494"></a>
<span class="sourceLineNo">495</span>     *  has not been called.<a name="line.495"></a>
<span class="sourceLineNo">496</span>     *  @return True if the data has been modified.<a name="line.496"></a>
<span class="sourceLineNo">497</span>     */<a name="line.497"></a>
<span class="sourceLineNo">498</span>    public boolean isModified() {<a name="line.498"></a>
<span class="sourceLineNo">499</span>        return _modified;<a name="line.499"></a>
<span class="sourceLineNo">500</span>    }<a name="line.500"></a>
<span class="sourceLineNo">501</span><a name="line.501"></a>
<span class="sourceLineNo">502</span>    /** Size this window to its preferred size and make it<a name="line.502"></a>
<span class="sourceLineNo">503</span>     *  displayable, and override the base class to populate the menu<a name="line.503"></a>
<span class="sourceLineNo">504</span>     *  bar if the menus have not already been populated.  If the<a name="line.504"></a>
<span class="sourceLineNo">505</span>     *  window size has not been set (by some derived class), then<a name="line.505"></a>
<span class="sourceLineNo">506</span>     *  this will center the window on the screen. This is<a name="line.506"></a>
<span class="sourceLineNo">507</span>     *  done here rather than in the constructor so that derived<a name="line.507"></a>
<span class="sourceLineNo">508</span>     *  classes are assured that their constructors have been fully<a name="line.508"></a>
<span class="sourceLineNo">509</span>     *  executed when _addMenus() is called. If this method is called<a name="line.509"></a>
<span class="sourceLineNo">510</span>     *  outside the AWT event thread, then its execution is deferred and<a name="line.510"></a>
<span class="sourceLineNo">511</span>     *  performed in that thread.<a name="line.511"></a>
<span class="sourceLineNo">512</span>     */<a name="line.512"></a>
<span class="sourceLineNo">513</span>    @Override<a name="line.513"></a>
<span class="sourceLineNo">514</span>    public void pack() {<a name="line.514"></a>
<span class="sourceLineNo">515</span>        Runnable doPack = new DoPackRunnable();<a name="line.515"></a>
<span class="sourceLineNo">516</span><a name="line.516"></a>
<span class="sourceLineNo">517</span>        deferIfNecessary(doPack);<a name="line.517"></a>
<span class="sourceLineNo">518</span>    }<a name="line.518"></a>
<span class="sourceLineNo">519</span><a name="line.519"></a>
<span class="sourceLineNo">520</span>    /** Report a message to the user by displaying it in a status bar,<a name="line.520"></a>
<span class="sourceLineNo">521</span>     *  if there is one. If this method is called outside the AWT event<a name="line.521"></a>
<span class="sourceLineNo">522</span>     *  thread, then its execution is deferred and performed in that thread.<a name="line.522"></a>
<span class="sourceLineNo">523</span>     *  @param message The message to report.<a name="line.523"></a>
<span class="sourceLineNo">524</span>     */<a name="line.524"></a>
<span class="sourceLineNo">525</span>    public void report(final String message) {<a name="line.525"></a>
<span class="sourceLineNo">526</span>        Runnable doReport = new StatusBarMessageRunnable(message);<a name="line.526"></a>
<span class="sourceLineNo">527</span><a name="line.527"></a>
<span class="sourceLineNo">528</span>        deferIfNecessary(doReport);<a name="line.528"></a>
<span class="sourceLineNo">529</span>    }<a name="line.529"></a>
<span class="sourceLineNo">530</span><a name="line.530"></a>
<span class="sourceLineNo">531</span>    /** Report a Throwable, which is usually an Exception but can also<a name="line.531"></a>
<span class="sourceLineNo">532</span>     *  be an Error. If this method is called outside the AWT event<a name="line.532"></a>
<span class="sourceLineNo">533</span>     *  thread, then its execution is deferred and performed in that thread.<a name="line.533"></a>
<span class="sourceLineNo">534</span>     *  This pops up a window with the option of examining the stack<a name="line.534"></a>
<span class="sourceLineNo">535</span>     *  trace, and reports the specified message in the status bar, if<a name="line.535"></a>
<span class="sourceLineNo">536</span>     *  there is one.<a name="line.536"></a>
<span class="sourceLineNo">537</span>     *  @param message The message.<a name="line.537"></a>
<span class="sourceLineNo">538</span>     *  @param throwable The Throwable to report.<a name="line.538"></a>
<span class="sourceLineNo">539</span>     */<a name="line.539"></a>
<span class="sourceLineNo">540</span>    public void report(final String message, final Throwable throwable) {<a name="line.540"></a>
<span class="sourceLineNo">541</span>        Runnable doReport = new StatusBarMessageReportRunnable(message,<a name="line.541"></a>
<span class="sourceLineNo">542</span>                throwable);<a name="line.542"></a>
<span class="sourceLineNo">543</span><a name="line.543"></a>
<span class="sourceLineNo">544</span>        deferIfNecessary(doReport);<a name="line.544"></a>
<span class="sourceLineNo">545</span>    }<a name="line.545"></a>
<span class="sourceLineNo">546</span><a name="line.546"></a>
<span class="sourceLineNo">547</span>    /** Report a Throwable, which is usually an Exception but can also<a name="line.547"></a>
<span class="sourceLineNo">548</span>     *        be an Error.  This displays a message in a dialog by<a name="line.548"></a>
<span class="sourceLineNo">549</span>     *  calling the two-argument version with an empty string as the<a name="line.549"></a>
<span class="sourceLineNo">550</span>     *  first argument.  If this method is called outside the AWT event<a name="line.550"></a>
<span class="sourceLineNo">551</span>     *  thread, then its execution is deferred and performed in that thread.<a name="line.551"></a>
<span class="sourceLineNo">552</span>     *  @param throwable The Throwable to report<a name="line.552"></a>
<span class="sourceLineNo">553</span>     *  @see #report(String, Throwable)<a name="line.553"></a>
<span class="sourceLineNo">554</span>     */<a name="line.554"></a>
<span class="sourceLineNo">555</span>    public void report(Throwable throwable) {<a name="line.555"></a>
<span class="sourceLineNo">556</span>        report("", throwable);<a name="line.556"></a>
<span class="sourceLineNo">557</span>    }<a name="line.557"></a>
<span class="sourceLineNo">558</span><a name="line.558"></a>
<span class="sourceLineNo">559</span>    /** Set background color.  This overrides the base class to set the<a name="line.559"></a>
<span class="sourceLineNo">560</span>     *  background of the status bar. If this method is called outside<a name="line.560"></a>
<span class="sourceLineNo">561</span>     *  the AWT event thread, then its execution is deferred and<a name="line.561"></a>
<span class="sourceLineNo">562</span>     *  performed in that thread.<a name="line.562"></a>
<span class="sourceLineNo">563</span>     *  @param background The background color.<a name="line.563"></a>
<span class="sourceLineNo">564</span>     */<a name="line.564"></a>
<span class="sourceLineNo">565</span>    @Override<a name="line.565"></a>
<span class="sourceLineNo">566</span>    public void setBackground(final Color background) {<a name="line.566"></a>
<span class="sourceLineNo">567</span>        _statusBarBackground = background;<a name="line.567"></a>
<span class="sourceLineNo">568</span>        Runnable doSet = new SetBackgroundRunnable();<a name="line.568"></a>
<span class="sourceLineNo">569</span><a name="line.569"></a>
<span class="sourceLineNo">570</span>        deferIfNecessary(doSet);<a name="line.570"></a>
<span class="sourceLineNo">571</span>    }<a name="line.571"></a>
<span class="sourceLineNo">572</span><a name="line.572"></a>
<span class="sourceLineNo">573</span>    /** Specify whether or not to center the window on the screen when<a name="line.573"></a>
<span class="sourceLineNo">574</span>     *  packing it.  The default is true.<a name="line.574"></a>
<span class="sourceLineNo">575</span>     *  @param centering Set to false to disable centering.<a name="line.575"></a>
<span class="sourceLineNo">576</span>     *  @see #getCentering()<a name="line.576"></a>
<span class="sourceLineNo">577</span>     */<a name="line.577"></a>
<span class="sourceLineNo">578</span>    public void setCentering(boolean centering) {<a name="line.578"></a>
<span class="sourceLineNo">579</span>        _centering = centering;<a name="line.579"></a>
<span class="sourceLineNo">580</span>    }<a name="line.580"></a>
<span class="sourceLineNo">581</span><a name="line.581"></a>
<span class="sourceLineNo">582</span>    /**<a name="line.582"></a>
<span class="sourceLineNo">583</span>     * Set the initial default directory.  If this method is not<a name="line.583"></a>
<span class="sourceLineNo">584</span>     * called, then the initial default directory will be the value of<a name="line.584"></a>
<span class="sourceLineNo">585</span>     * the user.dir Java property, which is typically the current<a name="line.585"></a>
<span class="sourceLineNo">586</span>     * working directory.  This method allows external configuration<a name="line.586"></a>
<span class="sourceLineNo">587</span>     * to determine the initial/default opening/saving directory to<a name="line.587"></a>
<span class="sourceLineNo">588</span>     * use for file dialogs.  (Used in Kepler)<a name="line.588"></a>
<span class="sourceLineNo">589</span>     * @param dir the initial directory to use for file dialogs<a name="line.589"></a>
<span class="sourceLineNo">590</span>     */<a name="line.590"></a>
<span class="sourceLineNo">591</span>    public static void setDirectory(File dir) {<a name="line.591"></a>
<span class="sourceLineNo">592</span>        _directory = dir;<a name="line.592"></a>
<span class="sourceLineNo">593</span>    }<a name="line.593"></a>
<span class="sourceLineNo">594</span><a name="line.594"></a>
<span class="sourceLineNo">595</span>    /** Record whether the data associated with this window has been<a name="line.595"></a>
<span class="sourceLineNo">596</span>     *  modified since it was first read or last saved.  If you call<a name="line.596"></a>
<span class="sourceLineNo">597</span>     *  this with a true argument, then subsequent attempts to close<a name="line.597"></a>
<span class="sourceLineNo">598</span>     *  the window will trigger a dialog box to confirm the closing.<a name="line.598"></a>
<span class="sourceLineNo">599</span>     *  @param modified Indicator of whether the data has been modified.<a name="line.599"></a>
<span class="sourceLineNo">600</span>     */<a name="line.600"></a>
<span class="sourceLineNo">601</span>    public void setModified(boolean modified) {<a name="line.601"></a>
<span class="sourceLineNo">602</span>        _modified = modified;<a name="line.602"></a>
<span class="sourceLineNo">603</span>    }<a name="line.603"></a>
<span class="sourceLineNo">604</span><a name="line.604"></a>
<span class="sourceLineNo">605</span>    /** Override the base class to deiconify<a name="line.605"></a>
<span class="sourceLineNo">606</span>     *  the window, if necessary. If this method is called<a name="line.606"></a>
<span class="sourceLineNo">607</span>     *  outside the AWT event thread, then its execution is deferred and<a name="line.607"></a>
<span class="sourceLineNo">608</span>     *  performed in that thread.<a name="line.608"></a>
<span class="sourceLineNo">609</span>     */<a name="line.609"></a>
<span class="sourceLineNo">610</span>    @Override<a name="line.610"></a>
<span class="sourceLineNo">611</span>    public void show() {<a name="line.611"></a>
<span class="sourceLineNo">612</span>        Runnable doShow = new ShowWindowRunnable();<a name="line.612"></a>
<span class="sourceLineNo">613</span><a name="line.613"></a>
<span class="sourceLineNo">614</span>        deferIfNecessary(doShow);<a name="line.614"></a>
<span class="sourceLineNo">615</span>    }<a name="line.615"></a>
<span class="sourceLineNo">616</span><a name="line.616"></a>
<span class="sourceLineNo">617</span>    /** Display the specified message in the status bar.<a name="line.617"></a>
<span class="sourceLineNo">618</span>     *  This message will be displayed for a maximum of MAXIMUM_STATUS_MESSAGE_TIME<a name="line.618"></a>
<span class="sourceLineNo">619</span>     *  (default 30 seconds).<a name="line.619"></a>
<span class="sourceLineNo">620</span>     *  If there is no status bar, print to standard out.<a name="line.620"></a>
<span class="sourceLineNo">621</span>     *  @param message The message.<a name="line.621"></a>
<span class="sourceLineNo">622</span>     */<a name="line.622"></a>
<span class="sourceLineNo">623</span>    @Override<a name="line.623"></a>
<span class="sourceLineNo">624</span>    public void status(final String message) {<a name="line.624"></a>
<span class="sourceLineNo">625</span>        if (_statusBar != null) {<a name="line.625"></a>
<span class="sourceLineNo">626</span>            if (_statusMessageTimer == null) {<a name="line.626"></a>
<span class="sourceLineNo">627</span>                // Second argument makes this a daemon thread, so it won't block exiting Vergil.<a name="line.627"></a>
<span class="sourceLineNo">628</span>                _statusMessageTimer = new Timer("Status message timer", true);<a name="line.628"></a>
<span class="sourceLineNo">629</span>            }<a name="line.629"></a>
<span class="sourceLineNo">630</span>            // The status bar update has to be performed in the Swing event thread.<a name="line.630"></a>
<span class="sourceLineNo">631</span>            // NOTE: If this is called from outside the Swing event thread, then<a name="line.631"></a>
<span class="sourceLineNo">632</span>            // the order in which messages are reported gets messed up.<a name="line.632"></a>
<span class="sourceLineNo">633</span>            // The only simple solutions seems to be to call this from the Swing event thread.<a name="line.633"></a>
<span class="sourceLineNo">634</span>            deferIfNecessary(new Runnable() {<a name="line.634"></a>
<span class="sourceLineNo">635</span>                @Override<a name="line.635"></a>
<span class="sourceLineNo">636</span>                public void run() {<a name="line.636"></a>
<span class="sourceLineNo">637</span>                    if (_lastStatusMessageClearingTask != null) {<a name="line.637"></a>
<span class="sourceLineNo">638</span>                        _lastStatusMessageClearingTask.cancel();<a name="line.638"></a>
<span class="sourceLineNo">639</span>                    }<a name="line.639"></a>
<span class="sourceLineNo">640</span>                    _statusBar.setMessage(message);<a name="line.640"></a>
<span class="sourceLineNo">641</span><a name="line.641"></a>
<span class="sourceLineNo">642</span>                    // If the message is non-empty, schedule a clearing message.<a name="line.642"></a>
<span class="sourceLineNo">643</span>                    if (!message.trim().equals("")) {<a name="line.643"></a>
<span class="sourceLineNo">644</span>                        _lastStatusMessageClearingTask = new TimerTask() {<a name="line.644"></a>
<span class="sourceLineNo">645</span>                            @Override<a name="line.645"></a>
<span class="sourceLineNo">646</span>                            public void run() {<a name="line.646"></a>
<span class="sourceLineNo">647</span>                                status("");<a name="line.647"></a>
<span class="sourceLineNo">648</span>                                _lastStatusMessageClearingTask = null;<a name="line.648"></a>
<span class="sourceLineNo">649</span>                            }<a name="line.649"></a>
<span class="sourceLineNo">650</span>                        };<a name="line.650"></a>
<span class="sourceLineNo">651</span>                        _statusMessageTimer.schedule(<a name="line.651"></a>
<span class="sourceLineNo">652</span>                                _lastStatusMessageClearingTask,<a name="line.652"></a>
<span class="sourceLineNo">653</span>                                MAXIMUM_STATUS_MESSAGE_TIME);<a name="line.653"></a>
<span class="sourceLineNo">654</span>                    }<a name="line.654"></a>
<span class="sourceLineNo">655</span>                }<a name="line.655"></a>
<span class="sourceLineNo">656</span>            });<a name="line.656"></a>
<span class="sourceLineNo">657</span>        } else {<a name="line.657"></a>
<span class="sourceLineNo">658</span>            System.out.println(message);<a name="line.658"></a>
<span class="sourceLineNo">659</span>        }<a name="line.659"></a>
<span class="sourceLineNo">660</span>    }<a name="line.660"></a>
<span class="sourceLineNo">661</span><a name="line.661"></a>
<span class="sourceLineNo">662</span>    /** Register with the global message handler to receive status messages.<a name="line.662"></a>
<span class="sourceLineNo">663</span>     *  @see MessageHandler#status(String)<a name="line.663"></a>
<span class="sourceLineNo">664</span>     *  @param event The window event.<a name="line.664"></a>
<span class="sourceLineNo">665</span>     */<a name="line.665"></a>
<span class="sourceLineNo">666</span>    @Override<a name="line.666"></a>
<span class="sourceLineNo">667</span>    public void windowGainedFocus(WindowEvent event) {<a name="line.667"></a>
<span class="sourceLineNo">668</span>        MessageHandler.setStatusHandler(this);<a name="line.668"></a>
<span class="sourceLineNo">669</span>    }<a name="line.669"></a>
<span class="sourceLineNo">670</span><a name="line.670"></a>
<span class="sourceLineNo">671</span>    /** Unregister with the global message handler to receive status messages.<a name="line.671"></a>
<span class="sourceLineNo">672</span>     *  @see MessageHandler#status(String)<a name="line.672"></a>
<span class="sourceLineNo">673</span>     *  @param event The window event.<a name="line.673"></a>
<span class="sourceLineNo">674</span>     */<a name="line.674"></a>
<span class="sourceLineNo">675</span>    @Override<a name="line.675"></a>
<span class="sourceLineNo">676</span>    public void windowLostFocus(WindowEvent event) {<a name="line.676"></a>
<span class="sourceLineNo">677</span>        MessageHandler.setStatusHandler(null);<a name="line.677"></a>
<span class="sourceLineNo">678</span>    }<a name="line.678"></a>
<span class="sourceLineNo">679</span><a name="line.679"></a>
<span class="sourceLineNo">680</span>    ///////////////////////////////////////////////////////////////////<a name="line.680"></a>
<span class="sourceLineNo">681</span>    ////                         public fields                     ////<a name="line.681"></a>
<span class="sourceLineNo">682</span><a name="line.682"></a>
<span class="sourceLineNo">683</span>    /** Maximum amount of time that a status message is displayed in milliseconds. */<a name="line.683"></a>
<span class="sourceLineNo">684</span>    public static final long MAXIMUM_STATUS_MESSAGE_TIME = 30000;<a name="line.684"></a>
<span class="sourceLineNo">685</span><a name="line.685"></a>
<span class="sourceLineNo">686</span>    ///////////////////////////////////////////////////////////////////<a name="line.686"></a>
<span class="sourceLineNo">687</span>    ////                         protected methods                 ////<a name="line.687"></a>
<span class="sourceLineNo">688</span><a name="line.688"></a>
<span class="sourceLineNo">689</span>    /** Open a dialog with basic information about this window.<a name="line.689"></a>
<span class="sourceLineNo">690</span>     */<a name="line.690"></a>
<span class="sourceLineNo">691</span>    protected void _about() {<a name="line.691"></a>
<span class="sourceLineNo">692</span>        JOptionPane.showMessageDialog(this,<a name="line.692"></a>
<span class="sourceLineNo">693</span>                "Ptolemy II " + getClass().getName() + "\n"<a name="line.693"></a>
<span class="sourceLineNo">694</span>                        + "By: Claudius Ptolemaeus, ptolemy@eecs.berkeley.edu\n"<a name="line.694"></a>
<span class="sourceLineNo">695</span>                        + "For more information, see\n"<a name="line.695"></a>
<span class="sourceLineNo">696</span>                        + "http://ptolemy.eecs.berkeley.edu/ptolemyII\n\n"<a name="line.696"></a>
<span class="sourceLineNo">697</span>                        + "Copyright (c) 1997-2018, "<a name="line.697"></a>
<span class="sourceLineNo">698</span>                        + "The Regents of the University of California.",<a name="line.698"></a>
<span class="sourceLineNo">699</span>                "About Ptolemy II", JOptionPane.INFORMATION_MESSAGE);<a name="line.699"></a>
<span class="sourceLineNo">700</span>    }<a name="line.700"></a>
<span class="sourceLineNo">701</span><a name="line.701"></a>
<span class="sourceLineNo">702</span>    /** Add menus to the menu bar.  In this base class, this does nothing.<a name="line.702"></a>
<span class="sourceLineNo">703</span>     *  In derived classes, however, it will add items with commands like<a name="line.703"></a>
<span class="sourceLineNo">704</span>     *  &lt;pre&gt;<a name="line.704"></a>
<span class="sourceLineNo">705</span>     *      JMenu newMenu = new JMenu("My Menu");<a name="line.705"></a>
<span class="sourceLineNo">706</span>     *      _menubar.add(newMenu);<a name="line.706"></a>
<span class="sourceLineNo">707</span>     *  &lt;/pre&gt;<a name="line.707"></a>
<span class="sourceLineNo">708</span>     *  The reason for doing this in a protected method rather than<a name="line.708"></a>
<span class="sourceLineNo">709</span>     *  doing it directly in the constructor of the base class is subtle.<a name="line.709"></a>
<span class="sourceLineNo">710</span>     *  Unfortunately, at this time, Java provides no mechanism for<a name="line.710"></a>
<span class="sourceLineNo">711</span>     *  derived classes to insert menus at arbitrary points in the<a name="line.711"></a>
<span class="sourceLineNo">712</span>     *  menu bar.  Also, the menubar ignores the alignment property<a name="line.712"></a>
<span class="sourceLineNo">713</span>     *  of the JMenu.  By convention, however, we want the help menu to<a name="line.713"></a>
<span class="sourceLineNo">714</span>     *  be the rightmost menu.  Thus, we use a strategy pattern here,<a name="line.714"></a>
<span class="sourceLineNo">715</span>     *  and call a protected method that derived classes can use to<a name="line.715"></a>
<span class="sourceLineNo">716</span>     *  add menus.  Thus, this method is called before the Help menu<a name="line.716"></a>
<span class="sourceLineNo">717</span>     *  is added, and hence menus added in this method will appear to<a name="line.717"></a>
<span class="sourceLineNo">718</span>     *  the left of the Help menu.<a name="line.718"></a>
<span class="sourceLineNo">719</span>     */<a name="line.719"></a>
<span class="sourceLineNo">720</span>    protected void _addMenus() {<a name="line.720"></a>
<span class="sourceLineNo">721</span>    }<a name="line.721"></a>
<span class="sourceLineNo">722</span><a name="line.722"></a>
<span class="sourceLineNo">723</span>    /** Clear the current contents.  This base class checks to see whether<a name="line.723"></a>
<span class="sourceLineNo">724</span>     *  the contents have been modified, and if so, then prompts the user<a name="line.724"></a>
<span class="sourceLineNo">725</span>     *  to save them.  Derived classes should override this method to<a name="line.725"></a>
<span class="sourceLineNo">726</span>     *  first call this parent class method, then clear the data,<a name="line.726"></a>
<span class="sourceLineNo">727</span>     *  unless the return value is false.  A return value of false<a name="line.727"></a>
<span class="sourceLineNo">728</span>     *  indicates that the user has canceled the action.<a name="line.728"></a>
<span class="sourceLineNo">729</span>     *  @return True if the current contents are either saved or discarded<a name="line.729"></a>
<span class="sourceLineNo">730</span>     *   with permission from the user.<a name="line.730"></a>
<span class="sourceLineNo">731</span>     */<a name="line.731"></a>
<span class="sourceLineNo">732</span>    protected boolean _clear() {<a name="line.732"></a>
<span class="sourceLineNo">733</span>        int result = _queryForSave();<a name="line.733"></a>
<span class="sourceLineNo">734</span>        return result == _SAVED || result == _DISCARDED;<a name="line.734"></a>
<span class="sourceLineNo">735</span>    }<a name="line.735"></a>
<span class="sourceLineNo">736</span><a name="line.736"></a>
<span class="sourceLineNo">737</span>    /** Close the window.  Derived classes should override this to<a name="line.737"></a>
<span class="sourceLineNo">738</span>     *  release any resources or remove any listeners.  In this class,<a name="line.738"></a>
<span class="sourceLineNo">739</span>     *  if the data associated with this window has been modified, as<a name="line.739"></a>
<span class="sourceLineNo">740</span>     *  indicated by isModified(), then ask the user whether to save<a name="line.740"></a>
<span class="sourceLineNo">741</span>     *  the data before closing.<a name="line.741"></a>
<span class="sourceLineNo">742</span>     *  @return False if the user cancels on a save query.<a name="line.742"></a>
<span class="sourceLineNo">743</span>     */<a name="line.743"></a>
<span class="sourceLineNo">744</span>    protected boolean _close() {<a name="line.744"></a>
<span class="sourceLineNo">745</span>        if (_debugClosing) {<a name="line.745"></a>
<span class="sourceLineNo">746</span>            System.out.println("Top._close() : " + this.getName());<a name="line.746"></a>
<span class="sourceLineNo">747</span>        }<a name="line.747"></a>
<span class="sourceLineNo">748</span><a name="line.748"></a>
<span class="sourceLineNo">749</span>        // NOTE: We use dispose() here rather than just hiding the<a name="line.749"></a>
<span class="sourceLineNo">750</span>        // window.  This ensures that derived classes can react to<a name="line.750"></a>
<span class="sourceLineNo">751</span>        // windowClosed events rather than overriding the<a name="line.751"></a>
<span class="sourceLineNo">752</span>        // windowClosing behavior given here.<a name="line.752"></a>
<span class="sourceLineNo">753</span>        if (isModified()) {<a name="line.753"></a>
<span class="sourceLineNo">754</span>            int result = _queryForSave();<a name="line.754"></a>
<span class="sourceLineNo">755</span><a name="line.755"></a>
<span class="sourceLineNo">756</span>            if (result == _SAVED || result == _DISCARDED) {<a name="line.756"></a>
<span class="sourceLineNo">757</span>                dispose();<a name="line.757"></a>
<span class="sourceLineNo">758</span>                return true;<a name="line.758"></a>
<span class="sourceLineNo">759</span>            }<a name="line.759"></a>
<span class="sourceLineNo">760</span><a name="line.760"></a>
<span class="sourceLineNo">761</span>            return false;<a name="line.761"></a>
<span class="sourceLineNo">762</span>        } else {<a name="line.762"></a>
<span class="sourceLineNo">763</span>            // Window is not modified, so just dispose.<a name="line.763"></a>
<span class="sourceLineNo">764</span>            dispose();<a name="line.764"></a>
<span class="sourceLineNo">765</span>            return true;<a name="line.765"></a>
<span class="sourceLineNo">766</span>        }<a name="line.766"></a>
<span class="sourceLineNo">767</span>    }<a name="line.767"></a>
<span class="sourceLineNo">768</span><a name="line.768"></a>
<span class="sourceLineNo">769</span>    /** Create the items in the File menu. A null element in the array<a name="line.769"></a>
<span class="sourceLineNo">770</span>     *  represents a separator in the menu.<a name="line.770"></a>
<span class="sourceLineNo">771</span>     *<a name="line.771"></a>
<span class="sourceLineNo">772</span>     *  @return The items in the File menu.<a name="line.772"></a>
<span class="sourceLineNo">773</span>     */<a name="line.773"></a>
<span class="sourceLineNo">774</span>    @SuppressWarnings("deprecation") // Java 10, inanely, deprecated getMenuShortcutKeyMask and replaced it with getMenuShortcutKeyMaskEx, which has the same signature. This makes no sense and violates principles of OO design. They should have just fixed getMenuShortcutKeyMask.<a name="line.774"></a>
<span class="sourceLineNo">775</span>    protected JMenuItem[] _createFileMenuItems() {<a name="line.775"></a>
<span class="sourceLineNo">776</span>        JMenuItem[] fileMenuItems = new JMenuItem[13];<a name="line.776"></a>
<span class="sourceLineNo">777</span><a name="line.777"></a>
<span class="sourceLineNo">778</span>        fileMenuItems[0] = new JMenuItem("Open File", KeyEvent.VK_O);<a name="line.778"></a>
<span class="sourceLineNo">779</span>        fileMenuItems[1] = new JMenuItem("Open URL", KeyEvent.VK_U);<a name="line.779"></a>
<span class="sourceLineNo">780</span>        // The following assumes _NEW_MENU_INDEX = 2.<a name="line.780"></a>
<span class="sourceLineNo">781</span>        fileMenuItems[_NEW_MENU_INDEX] = new JMenu("New");<a name="line.781"></a>
<span class="sourceLineNo">782</span>        fileMenuItems[3] = new JMenuItem("Save", KeyEvent.VK_S);<a name="line.782"></a>
<span class="sourceLineNo">783</span>        fileMenuItems[4] = new JMenuItem("Save As", KeyEvent.VK_A);<a name="line.783"></a>
<span class="sourceLineNo">784</span>        // The following assumes _IMPORT_MENU_INDEX = 5.<a name="line.784"></a>
<span class="sourceLineNo">785</span>        fileMenuItems[_IMPORT_MENU_INDEX] = new JMenu("Import");<a name="line.785"></a>
<span class="sourceLineNo">786</span>        // The following assumes _EXPORT_MENU_INDEX = 6.<a name="line.786"></a>
<span class="sourceLineNo">787</span>        fileMenuItems[_EXPORT_MENU_INDEX] = new JMenu("Export");<a name="line.787"></a>
<span class="sourceLineNo">788</span>        fileMenuItems[7] = new JMenuItem("Print", KeyEvent.VK_P);<a name="line.788"></a>
<span class="sourceLineNo">789</span>        fileMenuItems[8] = new JMenuItem("Close", KeyEvent.VK_C);<a name="line.789"></a>
<span class="sourceLineNo">790</span><a name="line.790"></a>
<span class="sourceLineNo">791</span>        // Separators<a name="line.791"></a>
<span class="sourceLineNo">792</span>        fileMenuItems[9] = null;<a name="line.792"></a>
<span class="sourceLineNo">793</span>        fileMenuItems[11] = null;<a name="line.793"></a>
<span class="sourceLineNo">794</span><a name="line.794"></a>
<span class="sourceLineNo">795</span>        // History submenu<a name="line.795"></a>
<span class="sourceLineNo">796</span>        JMenu history = new JMenu("Recent Files");<a name="line.796"></a>
<span class="sourceLineNo">797</span>        fileMenuItems[10] = history;<a name="line.797"></a>
<span class="sourceLineNo">798</span><a name="line.798"></a>
<span class="sourceLineNo">799</span>        // Exit<a name="line.799"></a>
<span class="sourceLineNo">800</span>        fileMenuItems[12] = new JMenuItem("Exit", KeyEvent.VK_Q);<a name="line.800"></a>
<span class="sourceLineNo">801</span><a name="line.801"></a>
<span class="sourceLineNo">802</span>        if (StringUtilities.inApplet()) {<a name="line.802"></a>
<span class="sourceLineNo">803</span>            JMenuItem[] appletFileMenuItems = new JMenuItem[8];<a name="line.803"></a>
<span class="sourceLineNo">804</span>            System.arraycopy(fileMenuItems, 0, appletFileMenuItems, 0,<a name="line.804"></a>
<span class="sourceLineNo">805</span>                    appletFileMenuItems.length);<a name="line.805"></a>
<span class="sourceLineNo">806</span>            appletFileMenuItems[7] = fileMenuItems[10];<a name="line.806"></a>
<span class="sourceLineNo">807</span>            fileMenuItems = appletFileMenuItems;<a name="line.807"></a>
<span class="sourceLineNo">808</span>            // If we are in an applet, disable certain menu items.<a name="line.808"></a>
<span class="sourceLineNo">809</span>            fileMenuItems[0].setEnabled(false);<a name="line.809"></a>
<span class="sourceLineNo">810</span>            fileMenuItems[2].setEnabled(false);<a name="line.810"></a>
<span class="sourceLineNo">811</span>            fileMenuItems[3].setEnabled(false);<a name="line.811"></a>
<span class="sourceLineNo">812</span>            fileMenuItems[4].setEnabled(false);<a name="line.812"></a>
<span class="sourceLineNo">813</span>            fileMenuItems[_IMPORT_MENU_INDEX].setEnabled(false);<a name="line.813"></a>
<span class="sourceLineNo">814</span>            fileMenuItems[_EXPORT_MENU_INDEX].setEnabled(false);<a name="line.814"></a>
<span class="sourceLineNo">815</span>            return fileMenuItems;<a name="line.815"></a>
<span class="sourceLineNo">816</span>        }<a name="line.816"></a>
<span class="sourceLineNo">817</span><a name="line.817"></a>
<span class="sourceLineNo">818</span>        // Open button = ctrl-o.<a name="line.818"></a>
<span class="sourceLineNo">819</span>        fileMenuItems[0].setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_O,<a name="line.819"></a>
<span class="sourceLineNo">820</span>                Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));<a name="line.820"></a>
<span class="sourceLineNo">821</span><a name="line.821"></a>
<span class="sourceLineNo">822</span>        // The mnemonic isn't set in the static<a name="line.822"></a>
<span class="sourceLineNo">823</span>        // initializer because JMenu doesn't have an<a name="line.823"></a>
<span class="sourceLineNo">824</span>        // appropriate constructor.<a name="line.824"></a>
<span class="sourceLineNo">825</span>        fileMenuItems[2].setMnemonic(KeyEvent.VK_N);<a name="line.825"></a>
<span class="sourceLineNo">826</span>        fileMenuItems[_EXPORT_MENU_INDEX].setMnemonic(KeyEvent.VK_E);<a name="line.826"></a>
<span class="sourceLineNo">827</span><a name="line.827"></a>
<span class="sourceLineNo">828</span>        // New Import and Export buttons disabled by default.<a name="line.828"></a>
<span class="sourceLineNo">829</span>        fileMenuItems[2].setEnabled(false);<a name="line.829"></a>
<span class="sourceLineNo">830</span>        fileMenuItems[_IMPORT_MENU_INDEX].setEnabled(false);<a name="line.830"></a>
<span class="sourceLineNo">831</span>        fileMenuItems[_EXPORT_MENU_INDEX].setEnabled(false);<a name="line.831"></a>
<span class="sourceLineNo">832</span><a name="line.832"></a>
<span class="sourceLineNo">833</span>        // Save button = ctrl-s.<a name="line.833"></a>
<span class="sourceLineNo">834</span>        fileMenuItems[3].setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_S,<a name="line.834"></a>
<span class="sourceLineNo">835</span>                Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));<a name="line.835"></a>
<span class="sourceLineNo">836</span><a name="line.836"></a>
<span class="sourceLineNo">837</span>        // Print button = ctrl-p.<a name="line.837"></a>
<span class="sourceLineNo">838</span>        fileMenuItems[7].setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_P,<a name="line.838"></a>
<span class="sourceLineNo">839</span>                Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));<a name="line.839"></a>
<span class="sourceLineNo">840</span><a name="line.840"></a>
<span class="sourceLineNo">841</span>        // Print button disabled by default, unless this class implements<a name="line.841"></a>
<span class="sourceLineNo">842</span>        // one of the JDK1.2 printing interfaces.<a name="line.842"></a>
<span class="sourceLineNo">843</span>        if (Top.this instanceof Printable || Top.this instanceof Pageable) {<a name="line.843"></a>
<span class="sourceLineNo">844</span>            fileMenuItems[7].setEnabled(true);<a name="line.844"></a>
<span class="sourceLineNo">845</span>        } else {<a name="line.845"></a>
<span class="sourceLineNo">846</span>            fileMenuItems[7].setEnabled(false);<a name="line.846"></a>
<span class="sourceLineNo">847</span>        }<a name="line.847"></a>
<span class="sourceLineNo">848</span><a name="line.848"></a>
<span class="sourceLineNo">849</span>        // Close button = ctrl-w.<a name="line.849"></a>
<span class="sourceLineNo">850</span>        fileMenuItems[8].setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_W,<a name="line.850"></a>
<span class="sourceLineNo">851</span>                Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));<a name="line.851"></a>
<span class="sourceLineNo">852</span><a name="line.852"></a>
<span class="sourceLineNo">853</span>        // Close button = ctrl-q.<a name="line.853"></a>
<span class="sourceLineNo">854</span>        fileMenuItems[12].setAccelerator(KeyStroke.getKeyStroke(KeyEvent.VK_Q,<a name="line.854"></a>
<span class="sourceLineNo">855</span>                Toolkit.getDefaultToolkit().getMenuShortcutKeyMask()));<a name="line.855"></a>
<span class="sourceLineNo">856</span>        // Sadly, the above doesn't actually work. Command-Q is not caught.<a name="line.856"></a>
<span class="sourceLineNo">857</span><a name="line.857"></a>
<span class="sourceLineNo">858</span>        return fileMenuItems;<a name="line.858"></a>
<span class="sourceLineNo">859</span>    }<a name="line.859"></a>
<span class="sourceLineNo">860</span><a name="line.860"></a>
<span class="sourceLineNo">861</span>    /** Exit the application after querying the user to save data.<a name="line.861"></a>
<span class="sourceLineNo">862</span>     *  Derived classes should override this to do something more<a name="line.862"></a>
<span class="sourceLineNo">863</span>     *  reasonable, so that user data is not discarded.<a name="line.863"></a>
<span class="sourceLineNo">864</span>     */<a name="line.864"></a>
<span class="sourceLineNo">865</span>    protected void _exit() {<a name="line.865"></a>
<span class="sourceLineNo">866</span>        if (isModified()) {<a name="line.866"></a>
<span class="sourceLineNo">867</span>            int result = _queryForSave();<a name="line.867"></a>
<span class="sourceLineNo">868</span>            _exitResult = result;<a name="line.868"></a>
<span class="sourceLineNo">869</span>            if (result == _SAVED || result == _DISCARDED) {<a name="line.869"></a>
<span class="sourceLineNo">870</span>                StringUtilities.exit(0);<a name="line.870"></a>
<span class="sourceLineNo">871</span>            }<a name="line.871"></a>
<span class="sourceLineNo">872</span>        } else {<a name="line.872"></a>
<span class="sourceLineNo">873</span>            // Window is not modified, so just exit.<a name="line.873"></a>
<span class="sourceLineNo">874</span>            StringUtilities.exit(0);<a name="line.874"></a>
<span class="sourceLineNo">875</span>        }<a name="line.875"></a>
<span class="sourceLineNo">876</span>    }<a name="line.876"></a>
<span class="sourceLineNo">877</span><a name="line.877"></a>
<span class="sourceLineNo">878</span>    /** Return the current directory.<a name="line.878"></a>
<span class="sourceLineNo">879</span>     * If {@link #setDirectory(File)} or<a name="line.879"></a>
<span class="sourceLineNo">880</span>     * {@link #_open()}, then the value of the "user.dir"<a name="line.880"></a>
<span class="sourceLineNo">881</span>     * property is returned.<a name="line.881"></a>
<span class="sourceLineNo">882</span>     * @return The current directory.<a name="line.882"></a>
<span class="sourceLineNo">883</span>     */<a name="line.883"></a>
<span class="sourceLineNo">884</span>    protected File _getCurrentDirectory() {<a name="line.884"></a>
<span class="sourceLineNo">885</span>        if (_directory != null) {<a name="line.885"></a>
<span class="sourceLineNo">886</span>            return _directory;<a name="line.886"></a>
<span class="sourceLineNo">887</span>        } else {<a name="line.887"></a>
<span class="sourceLineNo">888</span>            // The default on Windows is to open at user.home, which is<a name="line.888"></a>
<span class="sourceLineNo">889</span>            // typically not what we want.<a name="line.889"></a>
<span class="sourceLineNo">890</span>            // So we use the current directory instead.<a name="line.890"></a>
<span class="sourceLineNo">891</span>            // This will fail with a security exception in applets.<a name="line.891"></a>
<span class="sourceLineNo">892</span>            String currentWorkingDirectory = StringUtilities<a name="line.892"></a>
<span class="sourceLineNo">893</span>                    .getProperty("user.dir");<a name="line.893"></a>
<span class="sourceLineNo">894</span>            if (currentWorkingDirectory == null) {<a name="line.894"></a>
<span class="sourceLineNo">895</span>                return null;<a name="line.895"></a>
<span class="sourceLineNo">896</span>            } else {<a name="line.896"></a>
<span class="sourceLineNo">897</span>                return new File(currentWorkingDirectory);<a name="line.897"></a>
<span class="sourceLineNo">898</span>            }<a name="line.898"></a>
<span class="sourceLineNo">899</span>        }<a name="line.899"></a>
<span class="sourceLineNo">900</span>    }<a name="line.900"></a>
<span class="sourceLineNo">901</span><a name="line.901"></a>
<span class="sourceLineNo">902</span>    /** Get the name of this object, which in this base class is<a name="line.902"></a>
<span class="sourceLineNo">903</span>     *  either the name of the file that has been associated with this<a name="line.903"></a>
<span class="sourceLineNo">904</span>     *  object, or the string "Unnamed" if none.<a name="line.904"></a>
<span class="sourceLineNo">905</span>     *  @return The name.<a name="line.905"></a>
<span class="sourceLineNo">906</span>     */<a name="line.906"></a>
<span class="sourceLineNo">907</span>    protected String _getName() {<a name="line.907"></a>
<span class="sourceLineNo">908</span>        if (_file == null) {<a name="line.908"></a>
<span class="sourceLineNo">909</span>            return "Unnamed";<a name="line.909"></a>
<span class="sourceLineNo">910</span>        }<a name="line.910"></a>
<span class="sourceLineNo">911</span><a name="line.911"></a>
<span class="sourceLineNo">912</span>        return _file.getName();<a name="line.912"></a>
<span class="sourceLineNo">913</span>    }<a name="line.913"></a>
<span class="sourceLineNo">914</span><a name="line.914"></a>
<span class="sourceLineNo">915</span>    /** Display the same information given by _about().<a name="line.915"></a>
<span class="sourceLineNo">916</span>     *  Derived classes should override this to give information<a name="line.916"></a>
<span class="sourceLineNo">917</span>     *  about the particular window and its role.<a name="line.917"></a>
<span class="sourceLineNo">918</span>     */<a name="line.918"></a>
<span class="sourceLineNo">919</span>    protected void _help() {<a name="line.919"></a>
<span class="sourceLineNo">920</span>        _about();<a name="line.920"></a>
<span class="sourceLineNo">921</span>    }<a name="line.921"></a>
<span class="sourceLineNo">922</span><a name="line.922"></a>
<span class="sourceLineNo">923</span>    /** Open a file dialog to identify a file to be opened, and then call<a name="line.923"></a>
<span class="sourceLineNo">924</span>     *  _read() to open the file.  If {@link ptolemy.gui.PtGUIUtilities#useFileDialog()}<a name="line.924"></a>
<span class="sourceLineNo">925</span>     *  return true, then java.awt.FileDialog is used.<a name="line.925"></a>
<span class="sourceLineNo">926</span>     *  Otherwise, javax.swing.JFileChooser is used.<a name="line.926"></a>
<span class="sourceLineNo">927</span>     */<a name="line.927"></a>
<span class="sourceLineNo">928</span>    protected void _open() {<a name="line.928"></a>
<span class="sourceLineNo">929</span>        if (PtGUIUtilities.useFileDialog()) {<a name="line.929"></a>
<span class="sourceLineNo">930</span>            _openFileDialog();<a name="line.930"></a>
<span class="sourceLineNo">931</span>        } else {<a name="line.931"></a>
<span class="sourceLineNo">932</span>            _openJFileChooser();<a name="line.932"></a>
<span class="sourceLineNo">933</span>        }<a name="line.933"></a>
<span class="sourceLineNo">934</span>    }<a name="line.934"></a>
<span class="sourceLineNo">935</span><a name="line.935"></a>
<span class="sourceLineNo">936</span>    /** Open a dialog to enter a URL, and then invoke<a name="line.936"></a>
<span class="sourceLineNo">937</span>     *  _read() to open the URL.<a name="line.937"></a>
<span class="sourceLineNo">938</span>     */<a name="line.938"></a>
<span class="sourceLineNo">939</span>    protected void _openURL() {<a name="line.939"></a>
<span class="sourceLineNo">940</span>        Query query = new Query();<a name="line.940"></a>
<span class="sourceLineNo">941</span>        query.setTextWidth(60);<a name="line.941"></a>
<span class="sourceLineNo">942</span>        query.addLine("url", "URL", _lastURL);<a name="line.942"></a>
<span class="sourceLineNo">943</span><a name="line.943"></a>
<span class="sourceLineNo">944</span>        ComponentDialog dialog = new ComponentDialog(this, "Open URL", query);<a name="line.944"></a>
<span class="sourceLineNo">945</span><a name="line.945"></a>
<span class="sourceLineNo">946</span>        if (dialog.buttonPressed().equals("OK")) {<a name="line.946"></a>
<span class="sourceLineNo">947</span>            _lastURL = query.getStringValue("url");<a name="line.947"></a>
<span class="sourceLineNo">948</span><a name="line.948"></a>
<span class="sourceLineNo">949</span>            try {<a name="line.949"></a>
<span class="sourceLineNo">950</span>                URL url = new URL(_lastURL);<a name="line.950"></a>
<span class="sourceLineNo">951</span>                _read(url);<a name="line.951"></a>
<span class="sourceLineNo">952</span>            } catch (Exception ex) {<a name="line.952"></a>
<span class="sourceLineNo">953</span>                report("Error reading URL:\n" + _lastURL, ex);<a name="line.953"></a>
<span class="sourceLineNo">954</span>            }<a name="line.954"></a>
<span class="sourceLineNo">955</span>        }<a name="line.955"></a>
<span class="sourceLineNo">956</span>    }<a name="line.956"></a>
<span class="sourceLineNo">957</span><a name="line.957"></a>
<span class="sourceLineNo">958</span>    /** Print the contents.  If this frame implements either the<a name="line.958"></a>
<span class="sourceLineNo">959</span>     *  Printable or Pageable then those interfaces are used to print<a name="line.959"></a>
<span class="sourceLineNo">960</span>     *  it.<a name="line.960"></a>
<span class="sourceLineNo">961</span>     */<a name="line.961"></a>
<span class="sourceLineNo">962</span>    protected void _print() {<a name="line.962"></a>
<span class="sourceLineNo">963</span>        // If you are using $PTII/bin/vergil, under bash, set this property:<a name="line.963"></a>
<span class="sourceLineNo">964</span>        // export JAVAFLAGS=-Dptolemy.ptII.print.platform=CrossPlatform<a name="line.964"></a>
<span class="sourceLineNo">965</span>        // and then run $PTII/bin/vergil<a name="line.965"></a>
<span class="sourceLineNo">966</span>        if (StringUtilities.getProperty("ptolemy.ptII.print.platform")<a name="line.966"></a>
<span class="sourceLineNo">967</span>                .equals("CrossPlatform")) {<a name="line.967"></a>
<span class="sourceLineNo">968</span>            _printCrossPlatform();<a name="line.968"></a>
<span class="sourceLineNo">969</span>        } else {<a name="line.969"></a>
<span class="sourceLineNo">970</span>            _printNative();<a name="line.970"></a>
<span class="sourceLineNo">971</span>        }<a name="line.971"></a>
<span class="sourceLineNo">972</span>    }<a name="line.972"></a>
<span class="sourceLineNo">973</span><a name="line.973"></a>
<span class="sourceLineNo">974</span>    /** Print using the cross platform dialog.<a name="line.974"></a>
<span class="sourceLineNo">975</span>     *  Note that in java 1.6.0_05, the properties button is disabled,<a name="line.975"></a>
<span class="sourceLineNo">976</span>     *  so using _printNative() is preferred.<a name="line.976"></a>
<span class="sourceLineNo">977</span>     */<a name="line.977"></a>
<span class="sourceLineNo">978</span>    protected void _printCrossPlatform() {<a name="line.978"></a>
<span class="sourceLineNo">979</span>        // FIXME: Code duplication with PlotBox and PlotFrame.<a name="line.979"></a>
<span class="sourceLineNo">980</span>        // See PlotFrame for notes.<a name="line.980"></a>
<span class="sourceLineNo">981</span><a name="line.981"></a>
<span class="sourceLineNo">982</span>        // Build a set of attributes<a name="line.982"></a>
<span class="sourceLineNo">983</span>        PrintRequestAttributeSet aset = new HashPrintRequestAttributeSet();<a name="line.983"></a>
<span class="sourceLineNo">984</span>        PrinterJob job = PrinterJob.getPrinterJob();<a name="line.984"></a>
<span class="sourceLineNo">985</span><a name="line.985"></a>
<span class="sourceLineNo">986</span>        _macCheck();<a name="line.986"></a>
<span class="sourceLineNo">987</span><a name="line.987"></a>
<span class="sourceLineNo">988</span>        if (this instanceof Pageable) {<a name="line.988"></a>
<span class="sourceLineNo">989</span>            job.setPageable((Pageable) this);<a name="line.989"></a>
<span class="sourceLineNo">990</span>        } else if (this instanceof Printable) {<a name="line.990"></a>
<span class="sourceLineNo">991</span>            //PageFormat format = job.pageDialog(job.defaultPage());<a name="line.991"></a>
<span class="sourceLineNo">992</span>            //job.setPrintable((Printable) this, format);<a name="line.992"></a>
<span class="sourceLineNo">993</span>            job.setPrintable((Printable) this);<a name="line.993"></a>
<span class="sourceLineNo">994</span>        } else {<a name="line.994"></a>
<span class="sourceLineNo">995</span>            // Can't print it.<a name="line.995"></a>
<span class="sourceLineNo">996</span>            return;<a name="line.996"></a>
<span class="sourceLineNo">997</span>        }<a name="line.997"></a>
<span class="sourceLineNo">998</span><a name="line.998"></a>
<span class="sourceLineNo">999</span>        if (job.printDialog(aset)) {<a name="line.999"></a>
<span class="sourceLineNo">1000</span>            try {<a name="line.1000"></a>
<span class="sourceLineNo">1001</span>                job.print(aset);<a name="line.1001"></a>
<span class="sourceLineNo">1002</span>            } catch (Exception ex) {<a name="line.1002"></a>
<span class="sourceLineNo">1003</span>                MessageHandler.error("Cross Platform Printing Failed", ex);<a name="line.1003"></a>
<span class="sourceLineNo">1004</span>            }<a name="line.1004"></a>
<span class="sourceLineNo">1005</span>        }<a name="line.1005"></a>
<span class="sourceLineNo">1006</span>    }<a name="line.1006"></a>
<span class="sourceLineNo">1007</span><a name="line.1007"></a>
<span class="sourceLineNo">1008</span>    /** If a PDF printer is available print to it.<a name="line.1008"></a>
<span class="sourceLineNo">1009</span>     *  @exception PrinterException If a printer with the string "PDF"<a name="line.1009"></a>
<span class="sourceLineNo">1010</span>     * cannot be found or if the job cannot be set to the PDF print<a name="line.1010"></a>
<span class="sourceLineNo">1011</span>     * service or if there is another problem printing.<a name="line.1011"></a>
<span class="sourceLineNo">1012</span>     */<a name="line.1012"></a>
<span class="sourceLineNo">1013</span>    protected void _printPDF() throws PrinterException {<a name="line.1013"></a>
<span class="sourceLineNo">1014</span>        // Find something that will print to PDF<a name="line.1014"></a>
<span class="sourceLineNo">1015</span>        boolean foundPDFPrinter = false;<a name="line.1015"></a>
<span class="sourceLineNo">1016</span><a name="line.1016"></a>
<span class="sourceLineNo">1017</span>        PrintService pdfPrintService = null;<a name="line.1017"></a>
<span class="sourceLineNo">1018</span>        PrintService printServices[] = PrinterJob.lookupPrintServices();<a name="line.1018"></a>
<span class="sourceLineNo">1019</span>        for (PrintService printService : printServices) {<a name="line.1019"></a>
<span class="sourceLineNo">1020</span>            if (printService.getName().indexOf("PDF") != -1) {<a name="line.1020"></a>
<span class="sourceLineNo">1021</span>                foundPDFPrinter = true;<a name="line.1021"></a>
<span class="sourceLineNo">1022</span>                pdfPrintService = printService;<a name="line.1022"></a>
<span class="sourceLineNo">1023</span>            }<a name="line.1023"></a>
<span class="sourceLineNo">1024</span>        }<a name="line.1024"></a>
<span class="sourceLineNo">1025</span><a name="line.1025"></a>
<span class="sourceLineNo">1026</span>        if (pdfPrintService == null || foundPDFPrinter == false) {<a name="line.1026"></a>
<span class="sourceLineNo">1027</span>            throw new PrinterException("Could not find a printer with the "<a name="line.1027"></a>
<span class="sourceLineNo">1028</span>                    + "string \"PDF\" in its name.  Currently, the -printPDF "<a name="line.1028"></a>
<span class="sourceLineNo">1029</span>                    + "facility requires a PDF printer such as the non-free "<a name="line.1029"></a>
<span class="sourceLineNo">1030</span>                    + "full version of Adobe Acrobat.");<a name="line.1030"></a>
<span class="sourceLineNo">1031</span>        }<a name="line.1031"></a>
<span class="sourceLineNo">1032</span><a name="line.1032"></a>
<span class="sourceLineNo">1033</span>        PrinterJob job = PrinterJob.getPrinterJob();<a name="line.1033"></a>
<span class="sourceLineNo">1034</span>        PageFormat pageFormat = job.defaultPage();<a name="line.1034"></a>
<span class="sourceLineNo">1035</span>        job.setPrintService(pdfPrintService);<a name="line.1035"></a>
<span class="sourceLineNo">1036</span><a name="line.1036"></a>
<span class="sourceLineNo">1037</span>        PrintRequestAttributeSet aset = new HashPrintRequestAttributeSet();<a name="line.1037"></a>
<span class="sourceLineNo">1038</span><a name="line.1038"></a>
<span class="sourceLineNo">1039</span>        _macCheck();<a name="line.1039"></a>
<span class="sourceLineNo">1040</span><a name="line.1040"></a>
<span class="sourceLineNo">1041</span>        if (this instanceof Pageable) {<a name="line.1041"></a>
<span class="sourceLineNo">1042</span>            // FIXME: what about the page format?<a name="line.1042"></a>
<span class="sourceLineNo">1043</span>            job.setPageable((Pageable) this);<a name="line.1043"></a>
<span class="sourceLineNo">1044</span>            job.validatePage(pageFormat);<a name="line.1044"></a>
<span class="sourceLineNo">1045</span>        } else if (this instanceof Printable) {<a name="line.1045"></a>
<span class="sourceLineNo">1046</span>            job.setPrintable((Printable) this, pageFormat);<a name="line.1046"></a>
<span class="sourceLineNo">1047</span>        } else {<a name="line.1047"></a>
<span class="sourceLineNo">1048</span>            System.out.println("Can't print a " + this<a name="line.1048"></a>
<span class="sourceLineNo">1049</span>                    + ", it must be either Pageable or Printable");<a name="line.1049"></a>
<span class="sourceLineNo">1050</span>            // Can't print it.<a name="line.1050"></a>
<span class="sourceLineNo">1051</span>            return;<a name="line.1051"></a>
<span class="sourceLineNo">1052</span>        }<a name="line.1052"></a>
<span class="sourceLineNo">1053</span>        if (foundPDFPrinter) {<a name="line.1053"></a>
<span class="sourceLineNo">1054</span>            // This gets ignored, but let's try it anyway<a name="line.1054"></a>
<span class="sourceLineNo">1055</span>            Destination destination = new Destination(<a name="line.1055"></a>
<span class="sourceLineNo">1056</span>                    new File("ptolemy.pdf").toURI());<a name="line.1056"></a>
<span class="sourceLineNo">1057</span>            aset.add(destination);<a name="line.1057"></a>
<span class="sourceLineNo">1058</span><a name="line.1058"></a>
<span class="sourceLineNo">1059</span>            // On the Mac, calling job.setJobName() will set the file name,<a name="line.1059"></a>
<span class="sourceLineNo">1060</span>            // but not the directory.<a name="line.1060"></a>
<span class="sourceLineNo">1061</span>            System.out.println(<a name="line.1061"></a>
<span class="sourceLineNo">1062</span>                    "Top._printPDF(): Print Job information, much of which is ignored?\n"<a name="line.1062"></a>
<span class="sourceLineNo">1063</span>                            + "JobName: " + job.getJobName() + "\nUserName: "<a name="line.1063"></a>
<span class="sourceLineNo">1064</span>                            + job.getUserName());<a name="line.1064"></a>
<span class="sourceLineNo">1065</span>            javax.print.attribute.Attribute[] attributes = aset.toArray();<a name="line.1065"></a>
<span class="sourceLineNo">1066</span>            for (Attribute attribute : attributes) {<a name="line.1066"></a>
<span class="sourceLineNo">1067</span>                System.out.println(attribute.getName() + " "<a name="line.1067"></a>
<span class="sourceLineNo">1068</span>                        + attribute.getCategory() + " " + attribute);<a name="line.1068"></a>
<span class="sourceLineNo">1069</span>            }<a name="line.1069"></a>
<span class="sourceLineNo">1070</span><a name="line.1070"></a>
<span class="sourceLineNo">1071</span>            job.print(aset);<a name="line.1071"></a>
<span class="sourceLineNo">1072</span>            System.out.println("Window printed from command line. "<a name="line.1072"></a>
<span class="sourceLineNo">1073</span>                    + "Under MacOSX, look for "<a name="line.1073"></a>
<span class="sourceLineNo">1074</span>                    + "~/Desktop/Java Printing.pdf");<a name="line.1074"></a>
<span class="sourceLineNo">1075</span>        }<a name="line.1075"></a>
<span class="sourceLineNo">1076</span>    }<a name="line.1076"></a>
<span class="sourceLineNo">1077</span><a name="line.1077"></a>
<span class="sourceLineNo">1078</span>    /** Print using the native dialog.<a name="line.1078"></a>
<span class="sourceLineNo">1079</span>     */<a name="line.1079"></a>
<span class="sourceLineNo">1080</span>    protected void _printNative() {<a name="line.1080"></a>
<span class="sourceLineNo">1081</span>        // FIXME: Code duplication with PlotBox and PlotFrame.<a name="line.1081"></a>
<span class="sourceLineNo">1082</span>        // See PlotFrame for notes.<a name="line.1082"></a>
<span class="sourceLineNo">1083</span><a name="line.1083"></a>
<span class="sourceLineNo">1084</span>        PrinterJob job = PrinterJob.getPrinterJob();<a name="line.1084"></a>
<span class="sourceLineNo">1085</span>        PageFormat defaultFormat = job.defaultPage();<a name="line.1085"></a>
<span class="sourceLineNo">1086</span>        PageFormat pageFormat = job.pageDialog(defaultFormat);<a name="line.1086"></a>
<span class="sourceLineNo">1087</span><a name="line.1087"></a>
<span class="sourceLineNo">1088</span>        // If the print dialog is cancelled, we do not handle the job any more.<a name="line.1088"></a>
<span class="sourceLineNo">1089</span>        // -- tfeng (12/12/2008)<a name="line.1089"></a>
<span class="sourceLineNo">1090</span>        if (defaultFormat == pageFormat) {<a name="line.1090"></a>
<span class="sourceLineNo">1091</span>            return;<a name="line.1091"></a>
<span class="sourceLineNo">1092</span>        }<a name="line.1092"></a>
<span class="sourceLineNo">1093</span><a name="line.1093"></a>
<span class="sourceLineNo">1094</span>        _macCheck();<a name="line.1094"></a>
<span class="sourceLineNo">1095</span><a name="line.1095"></a>
<span class="sourceLineNo">1096</span>        if (this instanceof Pageable) {<a name="line.1096"></a>
<span class="sourceLineNo">1097</span>            // FIXME: what about the page format?<a name="line.1097"></a>
<span class="sourceLineNo">1098</span>            job.setPageable((Pageable) this);<a name="line.1098"></a>
<span class="sourceLineNo">1099</span>            job.validatePage(pageFormat);<a name="line.1099"></a>
<span class="sourceLineNo">1100</span>        } else if (this instanceof Printable) {<a name="line.1100"></a>
<span class="sourceLineNo">1101</span>            job.setPrintable((Printable) this, pageFormat);<a name="line.1101"></a>
<span class="sourceLineNo">1102</span>        } else {<a name="line.1102"></a>
<span class="sourceLineNo">1103</span>            // Can't print it.<a name="line.1103"></a>
<span class="sourceLineNo">1104</span>            return;<a name="line.1104"></a>
<span class="sourceLineNo">1105</span>        }<a name="line.1105"></a>
<span class="sourceLineNo">1106</span><a name="line.1106"></a>
<span class="sourceLineNo">1107</span>        if (job.printDialog()) {<a name="line.1107"></a>
<span class="sourceLineNo">1108</span>            try {<a name="line.1108"></a>
<span class="sourceLineNo">1109</span>                job.print();<a name="line.1109"></a>
<span class="sourceLineNo">1110</span>            } catch (Exception ex) {<a name="line.1110"></a>
<span class="sourceLineNo">1111</span>                MessageHandler.error("Native Printing Failed", ex);<a name="line.1111"></a>
<span class="sourceLineNo">1112</span>            }<a name="line.1112"></a>
<span class="sourceLineNo">1113</span>        }<a name="line.1113"></a>
<span class="sourceLineNo">1114</span>    }<a name="line.1114"></a>
<span class="sourceLineNo">1115</span><a name="line.1115"></a>
<span class="sourceLineNo">1116</span>    /** Open a dialog to prompt the user to save the data.<a name="line.1116"></a>
<span class="sourceLineNo">1117</span>     *  Return false if the user clicks "cancel", and otherwise return true.<a name="line.1117"></a>
<span class="sourceLineNo">1118</span>     *  If the user clicks "Save", this also saves the data.<a name="line.1118"></a>
<span class="sourceLineNo">1119</span>     *  @return _SAVED if the file is saved, _DISCARDED if the modifications are<a name="line.1119"></a>
<span class="sourceLineNo">1120</span>     *   discarded, _CANCELED if the operation is canceled by the user, and<a name="line.1120"></a>
<span class="sourceLineNo">1121</span>     *   _FAILED if the user selects save and the save fails.<a name="line.1121"></a>
<span class="sourceLineNo">1122</span>     */<a name="line.1122"></a>
<span class="sourceLineNo">1123</span>    protected int _queryForSave() {<a name="line.1123"></a>
<span class="sourceLineNo">1124</span>        Object[] options = { "Save", "Discard changes", "Cancel" };<a name="line.1124"></a>
<span class="sourceLineNo">1125</span><a name="line.1125"></a>
<span class="sourceLineNo">1126</span>        String query = "Save changes to " + StringUtilities.split(_getName())<a name="line.1126"></a>
<span class="sourceLineNo">1127</span>                + "?";<a name="line.1127"></a>
<span class="sourceLineNo">1128</span><a name="line.1128"></a>
<span class="sourceLineNo">1129</span>        // Show the MODAL dialog<a name="line.1129"></a>
<span class="sourceLineNo">1130</span>        int selected = JOptionPane.showOptionDialog(this, query,<a name="line.1130"></a>
<span class="sourceLineNo">1131</span>                "Save Changes?", JOptionPane.YES_NO_CANCEL_OPTION,<a name="line.1131"></a>
<span class="sourceLineNo">1132</span>                JOptionPane.QUESTION_MESSAGE, null, options, options[0]);<a name="line.1132"></a>
<span class="sourceLineNo">1133</span><a name="line.1133"></a>
<span class="sourceLineNo">1134</span>        if (selected == 0) {<a name="line.1134"></a>
<span class="sourceLineNo">1135</span>            if (_save()) {<a name="line.1135"></a>
<span class="sourceLineNo">1136</span>                return _SAVED;<a name="line.1136"></a>
<span class="sourceLineNo">1137</span>            } else {<a name="line.1137"></a>
<span class="sourceLineNo">1138</span>                return _FAILED;<a name="line.1138"></a>
<span class="sourceLineNo">1139</span>            }<a name="line.1139"></a>
<span class="sourceLineNo">1140</span>        }<a name="line.1140"></a>
<span class="sourceLineNo">1141</span><a name="line.1141"></a>
<span class="sourceLineNo">1142</span>        if (selected == 1) {<a name="line.1142"></a>
<span class="sourceLineNo">1143</span>            // To prevent the user from being asked again:<a name="line.1143"></a>
<span class="sourceLineNo">1144</span>            setModified(false);<a name="line.1144"></a>
<span class="sourceLineNo">1145</span>            return _DISCARDED;<a name="line.1145"></a>
<span class="sourceLineNo">1146</span>        }<a name="line.1146"></a>
<span class="sourceLineNo">1147</span><a name="line.1147"></a>
<span class="sourceLineNo">1148</span>        return _CANCELED;<a name="line.1148"></a>
<span class="sourceLineNo">1149</span>    }<a name="line.1149"></a>
<span class="sourceLineNo">1150</span><a name="line.1150"></a>
<span class="sourceLineNo">1151</span>    /** Read the specified URL.<a name="line.1151"></a>
<span class="sourceLineNo">1152</span>     *  @param url The URL to read.<a name="line.1152"></a>
<span class="sourceLineNo">1153</span>     *  @exception Exception If the URL cannot be read.<a name="line.1153"></a>
<span class="sourceLineNo">1154</span>     */<a name="line.1154"></a>
<span class="sourceLineNo">1155</span>    protected abstract void _read(URL url) throws Exception;<a name="line.1155"></a>
<span class="sourceLineNo">1156</span><a name="line.1156"></a>
<span class="sourceLineNo">1157</span>    /** Save the model to the current file, if there is one, and otherwise<a name="line.1157"></a>
<span class="sourceLineNo">1158</span>     *  invoke _saveAs().  This calls _writeFile().<a name="line.1158"></a>
<span class="sourceLineNo">1159</span>     *  @return True if the save succeeds.<a name="line.1159"></a>
<span class="sourceLineNo">1160</span>     */<a name="line.1160"></a>
<span class="sourceLineNo">1161</span>    protected boolean _save() {<a name="line.1161"></a>
<span class="sourceLineNo">1162</span>        if (_file != null) {<a name="line.1162"></a>
<span class="sourceLineNo">1163</span>            try {<a name="line.1163"></a>
<span class="sourceLineNo">1164</span>                _writeFile(_file);<a name="line.1164"></a>
<span class="sourceLineNo">1165</span>                setModified(false);<a name="line.1165"></a>
<span class="sourceLineNo">1166</span>                return true;<a name="line.1166"></a>
<span class="sourceLineNo">1167</span>            } catch (IOException ex) {<a name="line.1167"></a>
<span class="sourceLineNo">1168</span>                report("Error writing file", ex);<a name="line.1168"></a>
<span class="sourceLineNo">1169</span>                return false;<a name="line.1169"></a>
<span class="sourceLineNo">1170</span>            }<a name="line.1170"></a>
<span class="sourceLineNo">1171</span>        } else {<a name="line.1171"></a>
<span class="sourceLineNo">1172</span>            return _saveAs();<a name="line.1172"></a>
<span class="sourceLineNo">1173</span>        }<a name="line.1173"></a>
<span class="sourceLineNo">1174</span>    }<a name="line.1174"></a>
<span class="sourceLineNo">1175</span><a name="line.1175"></a>
<span class="sourceLineNo">1176</span>    /** Query the user for a filename and save the model to that file.<a name="line.1176"></a>
<span class="sourceLineNo">1177</span>     *  If {@link ptolemy.gui.PtGUIUtilities#useFileDialog()}<a name="line.1177"></a>
<span class="sourceLineNo">1178</span>     *  return true, then java.awt.FileDialog is used.<a name="line.1178"></a>
<span class="sourceLineNo">1179</span>     *  Otherwise, javax.swing.JFileChooser is used.<a name="line.1179"></a>
<span class="sourceLineNo">1180</span>     *  @return True if the save succeeds.<a name="line.1180"></a>
<span class="sourceLineNo">1181</span>     */<a name="line.1181"></a>
<span class="sourceLineNo">1182</span>    protected boolean _saveAs() {<a name="line.1182"></a>
<span class="sourceLineNo">1183</span>        if (PtGUIUtilities.useFileDialog()) {<a name="line.1183"></a>
<span class="sourceLineNo">1184</span>            return _saveAsFileDialogImplementation();<a name="line.1184"></a>
<span class="sourceLineNo">1185</span>        } else {<a name="line.1185"></a>
<span class="sourceLineNo">1186</span>            return _saveAsJFileChooserImplementation();<a name="line.1186"></a>
<span class="sourceLineNo">1187</span>        }<a name="line.1187"></a>
<span class="sourceLineNo">1188</span>    }<a name="line.1188"></a>
<span class="sourceLineNo">1189</span><a name="line.1189"></a>
<span class="sourceLineNo">1190</span>    /** Create and return a file dialog for the "Save As" command.<a name="line.1190"></a>
<span class="sourceLineNo">1191</span>     *  @return A file dialog for save as.<a name="line.1191"></a>
<span class="sourceLineNo">1192</span>     *  @deprecated Use {@link #_saveAsJFileChooserComponent()}<a name="line.1192"></a>
<span class="sourceLineNo">1193</span>     */<a name="line.1193"></a>
<span class="sourceLineNo">1194</span>    @Deprecated<a name="line.1194"></a>
<span class="sourceLineNo">1195</span>    protected JFileChooser _saveAsFileDialog() {<a name="line.1195"></a>
<span class="sourceLineNo">1196</span>        // Too bad this method was incorrectly named.  This method<a name="line.1196"></a>
<span class="sourceLineNo">1197</span>        // returns a JFileChooser, why on earth would its name<a name="line.1197"></a>
<span class="sourceLineNo">1198</span>        // have "FileDialog" in it?<a name="line.1198"></a>
<span class="sourceLineNo">1199</span>        return _saveAsJFileChooserComponent();<a name="line.1199"></a>
<span class="sourceLineNo">1200</span>    }<a name="line.1200"></a>
<span class="sourceLineNo">1201</span><a name="line.1201"></a>
<span class="sourceLineNo">1202</span>    /** Create and return a FileDialog for the "Save As" command.<a name="line.1202"></a>
<span class="sourceLineNo">1203</span>     *  If {@link ptolemy.gui.PtGUIUtilities#useFileDialog()} returns true,<a name="line.1203"></a>
<span class="sourceLineNo">1204</span>     *  then {@link #_saveAs()} uses this method.  Otherwise,<a name="line.1204"></a>
<span class="sourceLineNo">1205</span>     *  {@link #_saveAsJFileChooserComponent()} is used.<a name="line.1205"></a>
<span class="sourceLineNo">1206</span>     *  @return A file dialog for save as.<a name="line.1206"></a>
<span class="sourceLineNo">1207</span>     */<a name="line.1207"></a>
<span class="sourceLineNo">1208</span>    protected FileDialog _saveAsFileDialogComponent() {<a name="line.1208"></a>
<span class="sourceLineNo">1209</span>        // The name of this method ends in "Component" because<a name="line.1209"></a>
<span class="sourceLineNo">1210</span>        // there already was a _saveAsFileDialog() method.<a name="line.1210"></a>
<span class="sourceLineNo">1211</span>        FileDialog fileDialog = new FileDialog(this, "Save as...",<a name="line.1211"></a>
<span class="sourceLineNo">1212</span>                FileDialog.SAVE);<a name="line.1212"></a>
<span class="sourceLineNo">1213</span><a name="line.1213"></a>
<span class="sourceLineNo">1214</span>        if (_filenameFilter != null) {<a name="line.1214"></a>
<span class="sourceLineNo">1215</span>            fileDialog.setFilenameFilter(_filenameFilter);<a name="line.1215"></a>
<span class="sourceLineNo">1216</span>        }<a name="line.1216"></a>
<span class="sourceLineNo">1217</span><a name="line.1217"></a>
<span class="sourceLineNo">1218</span>        fileDialog.setDirectory(_getCurrentDirectory().toString());<a name="line.1218"></a>
<span class="sourceLineNo">1219</span>        return fileDialog;<a name="line.1219"></a>
<span class="sourceLineNo">1220</span>    }<a name="line.1220"></a>
<span class="sourceLineNo">1221</span><a name="line.1221"></a>
<span class="sourceLineNo">1222</span>    /** Create and return a JFileChooser for the "Save As" command.<a name="line.1222"></a>
<span class="sourceLineNo">1223</span>     *  If {@link ptolemy.gui.PtGUIUtilities#useFileDialog()} returns false,<a name="line.1223"></a>
<span class="sourceLineNo">1224</span>     *  then {@link #_saveAs()} uses this method.  Otherwise,<a name="line.1224"></a>
<span class="sourceLineNo">1225</span>     *  {@link #_saveAsFileDialogComponent()} is used.<a name="line.1225"></a>
<span class="sourceLineNo">1226</span>     *  @return A JFileChooser for save as.<a name="line.1226"></a>
<span class="sourceLineNo">1227</span>     */<a name="line.1227"></a>
<span class="sourceLineNo">1228</span>    protected JFileChooser _saveAsJFileChooserComponent() {<a name="line.1228"></a>
<span class="sourceLineNo">1229</span>        JFileChooser fileDialog = new JFileChooser();<a name="line.1229"></a>
<span class="sourceLineNo">1230</span><a name="line.1230"></a>
<span class="sourceLineNo">1231</span>        if (_fileFilter != null) {<a name="line.1231"></a>
<span class="sourceLineNo">1232</span>            fileDialog.addChoosableFileFilter(_fileFilter);<a name="line.1232"></a>
<span class="sourceLineNo">1233</span>        }<a name="line.1233"></a>
<span class="sourceLineNo">1234</span><a name="line.1234"></a>
<span class="sourceLineNo">1235</span>        fileDialog.setDialogTitle("Save as...");<a name="line.1235"></a>
<span class="sourceLineNo">1236</span>        fileDialog.setCurrentDirectory(_getCurrentDirectory());<a name="line.1236"></a>
<span class="sourceLineNo">1237</span>        return fileDialog;<a name="line.1237"></a>
<span class="sourceLineNo">1238</span>    }<a name="line.1238"></a>
<span class="sourceLineNo">1239</span><a name="line.1239"></a>
<span class="sourceLineNo">1240</span>    /** Update the submenu with a history list<a name="line.1240"></a>
<span class="sourceLineNo">1241</span>     * and add a listener to each line.<a name="line.1241"></a>
<span class="sourceLineNo">1242</span>     * @param historyList The list of history items,<a name="line.1242"></a>
<span class="sourceLineNo">1243</span>     * where each element is a String is the name of the<a name="line.1243"></a>
<span class="sourceLineNo">1244</span>     * menu item.<a name="line.1244"></a>
<span class="sourceLineNo">1245</span>     */<a name="line.1245"></a>
<span class="sourceLineNo">1246</span>    protected void _populateHistory(List historyList) {<a name="line.1246"></a>
<span class="sourceLineNo">1247</span>        //System.out.println("_populateHistory("+historyList.size()+")");<a name="line.1247"></a>
<span class="sourceLineNo">1248</span><a name="line.1248"></a>
<span class="sourceLineNo">1249</span>        // Make sure we have a reference to the Recent Files menu<a name="line.1249"></a>
<span class="sourceLineNo">1250</span>        if (_historyMenu == null) {<a name="line.1250"></a>
<span class="sourceLineNo">1251</span>            Component[] components = _fileMenu.getMenuComponents();<a name="line.1251"></a>
<span class="sourceLineNo">1252</span>            for (Component component : components) {<a name="line.1252"></a>
<span class="sourceLineNo">1253</span>                if (component instanceof JMenu) {<a name="line.1253"></a>
<span class="sourceLineNo">1254</span>                    JMenu menu = (JMenu) component;<a name="line.1254"></a>
<span class="sourceLineNo">1255</span>                    String menuText = menu.getText();<a name="line.1255"></a>
<span class="sourceLineNo">1256</span>                    if (menuText.equals("Recent Files")) {<a name="line.1256"></a>
<span class="sourceLineNo">1257</span>                        _historyMenu = (JMenu) component;<a name="line.1257"></a>
<span class="sourceLineNo">1258</span>                    }<a name="line.1258"></a>
<span class="sourceLineNo">1259</span>                }<a name="line.1259"></a>
<span class="sourceLineNo">1260</span>            }<a name="line.1260"></a>
<span class="sourceLineNo">1261</span>            // If we found it, add to set of history menus<a name="line.1261"></a>
<span class="sourceLineNo">1262</span>            if (_historyMenu != null) {<a name="line.1262"></a>
<span class="sourceLineNo">1263</span>                _historyMenusAndListeners.put(_historyMenu,<a name="line.1263"></a>
<span class="sourceLineNo">1264</span>                        _historyMenuListener);<a name="line.1264"></a>
<span class="sourceLineNo">1265</span>            }<a name="line.1265"></a>
<span class="sourceLineNo">1266</span>        }<a name="line.1266"></a>
<span class="sourceLineNo">1267</span><a name="line.1267"></a>
<span class="sourceLineNo">1268</span>        //System.out.println("number of history menus: " + _historyMenus.size());<a name="line.1268"></a>
<span class="sourceLineNo">1269</span><a name="line.1269"></a>
<span class="sourceLineNo">1270</span>        // Update the history menu in each Top<a name="line.1270"></a>
<span class="sourceLineNo">1271</span>        for (Map.Entry&lt;JMenu, HistoryMenuListener&gt; entry : _historyMenusAndListeners<a name="line.1271"></a>
<span class="sourceLineNo">1272</span>                .entrySet()) {<a name="line.1272"></a>
<span class="sourceLineNo">1273</span>            //System.out.println("updating menu " + historyMenu);<a name="line.1273"></a>
<span class="sourceLineNo">1274</span><a name="line.1274"></a>
<span class="sourceLineNo">1275</span>            JMenu historyMenu = entry.getKey();<a name="line.1275"></a>
<span class="sourceLineNo">1276</span><a name="line.1276"></a>
<span class="sourceLineNo">1277</span>            /*int c =*/MemoryCleaner.removeActionListeners(historyMenu);<a name="line.1277"></a>
<span class="sourceLineNo">1278</span>            //System.out.println("_historyMenu: "+c);<a name="line.1278"></a>
<span class="sourceLineNo">1279</span><a name="line.1279"></a>
<span class="sourceLineNo">1280</span>            historyMenu.removeAll();<a name="line.1280"></a>
<span class="sourceLineNo">1281</span><a name="line.1281"></a>
<span class="sourceLineNo">1282</span>            for (int i = 0; i &lt; historyList.size(); i++) {<a name="line.1282"></a>
<span class="sourceLineNo">1283</span>                String recentFileString = (String) historyList.get(i);<a name="line.1283"></a>
<span class="sourceLineNo">1284</span>                JMenuItem item = new JMenuItem(recentFileString);<a name="line.1284"></a>
<span class="sourceLineNo">1285</span>                item.addActionListener(entry.getValue());<a name="line.1285"></a>
<span class="sourceLineNo">1286</span>                historyMenu.add(item);<a name="line.1286"></a>
<span class="sourceLineNo">1287</span>            }<a name="line.1287"></a>
<span class="sourceLineNo">1288</span>        }<a name="line.1288"></a>
<span class="sourceLineNo">1289</span>    }<a name="line.1289"></a>
<span class="sourceLineNo">1290</span><a name="line.1290"></a>
<span class="sourceLineNo">1291</span>    /** Add the name of the last file open or set the name to the<a name="line.1291"></a>
<span class="sourceLineNo">1292</span>     * first position if already in the list.<a name="line.1292"></a>
<span class="sourceLineNo">1293</span>     * @param file name of the file to add<a name="line.1293"></a>
<span class="sourceLineNo">1294</span>     * @param delete If true, remove from the history list, otherwise<a name="line.1294"></a>
<span class="sourceLineNo">1295</span>     * the file is added to the beginning.<a name="line.1295"></a>
<span class="sourceLineNo">1296</span>     * @exception IOException If the history file cannot be created, written to,<a name="line.1296"></a>
<span class="sourceLineNo">1297</span>     * or saved.<a name="line.1297"></a>
<span class="sourceLineNo">1298</span>     */<a name="line.1298"></a>
<span class="sourceLineNo">1299</span>    protected void _updateHistory(String file, boolean delete)<a name="line.1299"></a>
<span class="sourceLineNo">1300</span>            throws IOException {<a name="line.1300"></a>
<span class="sourceLineNo">1301</span>        List&lt;String&gt; historyList = _readHistory();<a name="line.1301"></a>
<span class="sourceLineNo">1302</span><a name="line.1302"></a>
<span class="sourceLineNo">1303</span>        // Remove if already present (then added to first position)<a name="line.1303"></a>
<span class="sourceLineNo">1304</span>        for (int i = 0; i &lt; historyList.size(); i++) {<a name="line.1304"></a>
<span class="sourceLineNo">1305</span>            if (historyList.get(i).equals(file)) {<a name="line.1305"></a>
<span class="sourceLineNo">1306</span>                historyList.remove(i);<a name="line.1306"></a>
<span class="sourceLineNo">1307</span>            }<a name="line.1307"></a>
<span class="sourceLineNo">1308</span>        }<a name="line.1308"></a>
<span class="sourceLineNo">1309</span><a name="line.1309"></a>
<span class="sourceLineNo">1310</span>        // Remove if depth &gt; limit<a name="line.1310"></a>
<span class="sourceLineNo">1311</span>        if (historyList.size() &gt;= _historyDepth) {<a name="line.1311"></a>
<span class="sourceLineNo">1312</span>            historyList.remove(historyList.size() - 1);<a name="line.1312"></a>
<span class="sourceLineNo">1313</span>        }<a name="line.1313"></a>
<span class="sourceLineNo">1314</span><a name="line.1314"></a>
<span class="sourceLineNo">1315</span>        // Add to fist position<a name="line.1315"></a>
<span class="sourceLineNo">1316</span>        if (!delete) {<a name="line.1316"></a>
<span class="sourceLineNo">1317</span>            historyList.add(0, file);<a name="line.1317"></a>
<span class="sourceLineNo">1318</span>        }<a name="line.1318"></a>
<span class="sourceLineNo">1319</span><a name="line.1319"></a>
<span class="sourceLineNo">1320</span>        // Serialize history<a name="line.1320"></a>
<span class="sourceLineNo">1321</span>        _writeHistory(historyList);<a name="line.1321"></a>
<span class="sourceLineNo">1322</span><a name="line.1322"></a>
<span class="sourceLineNo">1323</span>        // Update submenu<a name="line.1323"></a>
<span class="sourceLineNo">1324</span>        _populateHistory(historyList);<a name="line.1324"></a>
<span class="sourceLineNo">1325</span>    }<a name="line.1325"></a>
<span class="sourceLineNo">1326</span><a name="line.1326"></a>
<span class="sourceLineNo">1327</span>    ///////////////////////////////////////////////////////////////////<a name="line.1327"></a>
<span class="sourceLineNo">1328</span>    ////                         protected variables               ////<a name="line.1328"></a>
<span class="sourceLineNo">1329</span><a name="line.1329"></a>
<span class="sourceLineNo">1330</span>    /** Write the model to the specified file.<a name="line.1330"></a>
<span class="sourceLineNo">1331</span>     *  @param file The file to write to.<a name="line.1331"></a>
<span class="sourceLineNo">1332</span>     *  @exception IOException If the write fails.<a name="line.1332"></a>
<span class="sourceLineNo">1333</span>     */<a name="line.1333"></a>
<span class="sourceLineNo">1334</span>    protected abstract void _writeFile(File file) throws IOException;<a name="line.1334"></a>
<span class="sourceLineNo">1335</span><a name="line.1335"></a>
<span class="sourceLineNo">1336</span>    /** Indicator that a close operation is canceled. */<a name="line.1336"></a>
<span class="sourceLineNo">1337</span>    protected static final int _CANCELED = 2;<a name="line.1337"></a>
<span class="sourceLineNo">1338</span><a name="line.1338"></a>
<span class="sourceLineNo">1339</span>    /** Indicator that a file is discarded. */<a name="line.1339"></a>
<span class="sourceLineNo">1340</span>    protected static final int _DISCARDED = 1;<a name="line.1340"></a>
<span class="sourceLineNo">1341</span><a name="line.1341"></a>
<span class="sourceLineNo">1342</span>    /** Indicator that a file save failed. */<a name="line.1342"></a>
<span class="sourceLineNo">1343</span>    protected static final int _FAILED = 3;<a name="line.1343"></a>
<span class="sourceLineNo">1344</span><a name="line.1344"></a>
<span class="sourceLineNo">1345</span>    /** Indicator that a file is saved. */<a name="line.1345"></a>
<span class="sourceLineNo">1346</span>    protected static final int _SAVED = 0;<a name="line.1346"></a>
<span class="sourceLineNo">1347</span><a name="line.1347"></a>
<span class="sourceLineNo">1348</span>    /** The most recent directory used in a file dialog. */<a name="line.1348"></a>
<span class="sourceLineNo">1349</span>    protected static File _directory = null;<a name="line.1349"></a>
<span class="sourceLineNo">1350</span><a name="line.1350"></a>
<span class="sourceLineNo">1351</span>    /** The return value of the _exit() menu.<a name="line.1351"></a>
<span class="sourceLineNo">1352</span>     *  We use a separate variable here for backward compatibility.<a name="line.1352"></a>
<span class="sourceLineNo">1353</span>     *  The values of this variable are the values returned by _queryForSave.<a name="line.1353"></a>
<span class="sourceLineNo">1354</span>     */<a name="line.1354"></a>
<span class="sourceLineNo">1355</span>    protected int _exitResult = _CANCELED;<a name="line.1355"></a>
<span class="sourceLineNo">1356</span><a name="line.1356"></a>
<span class="sourceLineNo">1357</span>    /** The FileFilter that determines what files are displayed by<a name="line.1357"></a>
<span class="sourceLineNo">1358</span>     *  the Open dialog and the Save As dialog<a name="line.1358"></a>
<span class="sourceLineNo">1359</span>     *  The initial default is null, which causes no FileFilter to be<a name="line.1359"></a>
<span class="sourceLineNo">1360</span>     *  applied, which results in all files being displayed.<a name="line.1360"></a>
<span class="sourceLineNo">1361</span>     */<a name="line.1361"></a>
<span class="sourceLineNo">1362</span>    protected FileFilter _fileFilter = null;<a name="line.1362"></a>
<span class="sourceLineNo">1363</span><a name="line.1363"></a>
<span class="sourceLineNo">1364</span>    /** The FileFilter used by the java.awt.FileDialog that determines<a name="line.1364"></a>
<span class="sourceLineNo">1365</span>     *  what files are displayed by the Open dialog and the Save As<a name="line.1365"></a>
<span class="sourceLineNo">1366</span>     *  dialog The initial default is null, which causes no FileFilter<a name="line.1366"></a>
<span class="sourceLineNo">1367</span>     *  to be applied, which results in all files being displayed.<a name="line.1367"></a>
<span class="sourceLineNo">1368</span>     *<a name="line.1368"></a>
<span class="sourceLineNo">1369</span>     *  &lt;p&gt;Note that this class can use either java.awt.FileDialog<a name="line.1369"></a>
<span class="sourceLineNo">1370</span>     *  or javax.swing.JFileChooser, so classes should set<a name="line.1370"></a>
<span class="sourceLineNo">1371</span>     *  both _fileFilter and _filenameFilter. Note that it<a name="line.1371"></a>
<span class="sourceLineNo">1372</span>     *  possible to define an inner class that extends<a name="line.1372"></a>
<span class="sourceLineNo">1373</span>     *  javax.swing.filechooser.FileFilter and implements<a name="line.1373"></a>
<span class="sourceLineNo">1374</span>     *  java.io.FilenameFilter and that has two separate accept()<a name="line.1374"></a>
<span class="sourceLineNo">1375</span>     *  methods.  This inner class can then be set as the<a name="line.1375"></a>
<span class="sourceLineNo">1376</span>     *  value for both _fileFilter and _filenameFilter:<a name="line.1376"></a>
<span class="sourceLineNo">1377</span>     *  &lt;pre&gt;<a name="line.1377"></a>
<span class="sourceLineNo">1378</span>     *  ...<a name="line.1378"></a>
<span class="sourceLineNo">1379</span>     *      MyFileFilter myFileFilter = new MyFileFilter();<a name="line.1379"></a>
<span class="sourceLineNo">1380</span>     *      _fileFilter = myFileFilter;<a name="line.1380"></a>
<span class="sourceLineNo">1381</span>     *      _filenameFilter = myFileFilter;<a name="line.1381"></a>
<span class="sourceLineNo">1382</span>     *  ...<a name="line.1382"></a>
<span class="sourceLineNo">1383</span>     *  static MyFileFilter extends FileFilter implements FilenameFilter {<a name="line.1383"></a>
<span class="sourceLineNo">1384</span>     *      public boolean accept(File file) {<a name="line.1384"></a>
<span class="sourceLineNo">1385</span>     *         // For FileFilter<a name="line.1385"></a>
<span class="sourceLineNo">1386</span>     *         return true;<a name="line.1386"></a>
<span class="sourceLineNo">1387</span>     *      }<a name="line.1387"></a>
<span class="sourceLineNo">1388</span>     *<a name="line.1388"></a>
<span class="sourceLineNo">1389</span>     *      public boolean accept(File director, String name) {<a name="line.1389"></a>
<span class="sourceLineNo">1390</span>     *         // For FilenameFilter<a name="line.1390"></a>
<span class="sourceLineNo">1391</span>     *         return true;<a name="line.1391"></a>
<span class="sourceLineNo">1392</span>     *      }<a name="line.1392"></a>
<span class="sourceLineNo">1393</span>     *<a name="line.1393"></a>
<span class="sourceLineNo">1394</span>     *      public String getDescription() {<a name="line.1394"></a>
<span class="sourceLineNo">1395</span>     *         // For FileFilter<a name="line.1395"></a>
<span class="sourceLineNo">1396</span>     *         return "My filter description.";<a name="line.1396"></a>
<span class="sourceLineNo">1397</span>     *      }<a name="line.1397"></a>
<span class="sourceLineNo">1398</span>     *  }<a name="line.1398"></a>
<span class="sourceLineNo">1399</span>     *  &lt;/pre&gt;<a name="line.1399"></a>
<span class="sourceLineNo">1400</span>     */<a name="line.1400"></a>
<span class="sourceLineNo">1401</span>    protected FilenameFilter _filenameFilter = null;<a name="line.1401"></a>
<span class="sourceLineNo">1402</span><a name="line.1402"></a>
<span class="sourceLineNo">1403</span>    /** File menu for this frame. */<a name="line.1403"></a>
<span class="sourceLineNo">1404</span>    protected JMenu _fileMenu = new JMenu("File");<a name="line.1404"></a>
<span class="sourceLineNo">1405</span><a name="line.1405"></a>
<span class="sourceLineNo">1406</span>    /** Items in the file menu. A null element represents a separator. */<a name="line.1406"></a>
<span class="sourceLineNo">1407</span>    protected JMenuItem[] _fileMenuItems = _createFileMenuItems();<a name="line.1407"></a>
<span class="sourceLineNo">1408</span><a name="line.1408"></a>
<span class="sourceLineNo">1409</span>    /** Index in the _fileMenuItems array of the New item. */<a name="line.1409"></a>
<span class="sourceLineNo">1410</span>    protected static int _NEW_MENU_INDEX = 2;<a name="line.1410"></a>
<span class="sourceLineNo">1411</span><a name="line.1411"></a>
<span class="sourceLineNo">1412</span>    /** Index in the _fileMenuItems array of the Import item. */<a name="line.1412"></a>
<span class="sourceLineNo">1413</span>    protected static int _IMPORT_MENU_INDEX = 5;<a name="line.1413"></a>
<span class="sourceLineNo">1414</span><a name="line.1414"></a>
<span class="sourceLineNo">1415</span>    /** Index in the _fileMenuItems array of the Export item. */<a name="line.1415"></a>
<span class="sourceLineNo">1416</span>    protected static int _EXPORT_MENU_INDEX = 6;<a name="line.1416"></a>
<span class="sourceLineNo">1417</span><a name="line.1417"></a>
<span class="sourceLineNo">1418</span>    /** Help menu for this frame. */<a name="line.1418"></a>
<span class="sourceLineNo">1419</span>    protected JMenu _helpMenu = new JMenu("Help");<a name="line.1419"></a>
<span class="sourceLineNo">1420</span><a name="line.1420"></a>
<span class="sourceLineNo">1421</span>    /** Help menu items. */<a name="line.1421"></a>
<span class="sourceLineNo">1422</span>    protected JMenuItem[] _helpMenuItems = {<a name="line.1422"></a>
<span class="sourceLineNo">1423</span>            new JMenuItem("About", KeyEvent.VK_A),<a name="line.1423"></a>
<span class="sourceLineNo">1424</span>            new JMenuItem("Help", KeyEvent.VK_H), };<a name="line.1424"></a>
<span class="sourceLineNo">1425</span><a name="line.1425"></a>
<span class="sourceLineNo">1426</span>    /** Menubar for this frame. */<a name="line.1426"></a>
<span class="sourceLineNo">1427</span>    protected JMenuBar _menubar = new JMenuBar();<a name="line.1427"></a>
<span class="sourceLineNo">1428</span><a name="line.1428"></a>
<span class="sourceLineNo">1429</span>    /** The status bar. */<a name="line.1429"></a>
<span class="sourceLineNo">1430</span>    protected StatusBar _statusBar = null;<a name="line.1430"></a>
<span class="sourceLineNo">1431</span><a name="line.1431"></a>
<span class="sourceLineNo">1432</span>    /** Listener for file menu commands. */<a name="line.1432"></a>
<span class="sourceLineNo">1433</span>    class FileMenuListener implements ActionListener {<a name="line.1433"></a>
<span class="sourceLineNo">1434</span>        @Override<a name="line.1434"></a>
<span class="sourceLineNo">1435</span>        public void actionPerformed(ActionEvent e) {<a name="line.1435"></a>
<span class="sourceLineNo">1436</span>            // Make this the default context for modal messages.<a name="line.1436"></a>
<span class="sourceLineNo">1437</span>            UndeferredGraphicalMessageHandler.setContext(Top.this);<a name="line.1437"></a>
<span class="sourceLineNo">1438</span><a name="line.1438"></a>
<span class="sourceLineNo">1439</span>            JMenuItem target = (JMenuItem) e.getSource();<a name="line.1439"></a>
<span class="sourceLineNo">1440</span>            String actionCommand = target.getActionCommand();<a name="line.1440"></a>
<span class="sourceLineNo">1441</span><a name="line.1441"></a>
<span class="sourceLineNo">1442</span>            try {<a name="line.1442"></a>
<span class="sourceLineNo">1443</span>                if (actionCommand.equals("Open File")) {<a name="line.1443"></a>
<span class="sourceLineNo">1444</span>                    _open();<a name="line.1444"></a>
<span class="sourceLineNo">1445</span>                } else if (actionCommand.equals("Open URL")) {<a name="line.1445"></a>
<span class="sourceLineNo">1446</span>                    _openURL();<a name="line.1446"></a>
<span class="sourceLineNo">1447</span>                } else if (actionCommand.equals("Save")) {<a name="line.1447"></a>
<span class="sourceLineNo">1448</span>                    _save();<a name="line.1448"></a>
<span class="sourceLineNo">1449</span>                } else if (actionCommand.equals("Save As")) {<a name="line.1449"></a>
<span class="sourceLineNo">1450</span>                    _saveAs();<a name="line.1450"></a>
<span class="sourceLineNo">1451</span>                } else if (actionCommand.equals("Print")) {<a name="line.1451"></a>
<span class="sourceLineNo">1452</span>                    _print();<a name="line.1452"></a>
<span class="sourceLineNo">1453</span>                } else if (actionCommand.equals("Close")) {<a name="line.1453"></a>
<span class="sourceLineNo">1454</span>                    if (!isDisposed()) {<a name="line.1454"></a>
<span class="sourceLineNo">1455</span>                        Window thisWindow = Top.this;<a name="line.1455"></a>
<span class="sourceLineNo">1456</span>                        WindowEvent wev = new WindowEvent(thisWindow,<a name="line.1456"></a>
<span class="sourceLineNo">1457</span>                                WindowEvent.WINDOW_CLOSING);<a name="line.1457"></a>
<span class="sourceLineNo">1458</span>                        Toolkit toolkit = Toolkit.getDefaultToolkit();<a name="line.1458"></a>
<span class="sourceLineNo">1459</span>                        EventQueue queue = toolkit.getSystemEventQueue();<a name="line.1459"></a>
<span class="sourceLineNo">1460</span>                        queue.postEvent(wev);<a name="line.1460"></a>
<span class="sourceLineNo">1461</span>                    }<a name="line.1461"></a>
<span class="sourceLineNo">1462</span>                } else if (actionCommand.equals("Exit")) {<a name="line.1462"></a>
<span class="sourceLineNo">1463</span>                    _exit();<a name="line.1463"></a>
<span class="sourceLineNo">1464</span>                }<a name="line.1464"></a>
<span class="sourceLineNo">1465</span>            } catch (Throwable throwable) {<a name="line.1465"></a>
<span class="sourceLineNo">1466</span>                // If we do not catch exceptions here, then they<a name="line.1466"></a>
<span class="sourceLineNo">1467</span>                // disappear to stdout, which is bad if we launched<a name="line.1467"></a>
<span class="sourceLineNo">1468</span>                // where there is no stdout visible.<a name="line.1468"></a>
<span class="sourceLineNo">1469</span>                MessageHandler.error("File Menu Exception:", throwable);<a name="line.1469"></a>
<span class="sourceLineNo">1470</span>            }<a name="line.1470"></a>
<span class="sourceLineNo">1471</span><a name="line.1471"></a>
<span class="sourceLineNo">1472</span>            // NOTE: The following should not be needed, but jdk1.3beta<a name="line.1472"></a>
<span class="sourceLineNo">1473</span>            // appears to have a bug in swing where repainting doesn't<a name="line.1473"></a>
<span class="sourceLineNo">1474</span>            // properly occur.<a name="line.1474"></a>
<span class="sourceLineNo">1475</span>            repaint();<a name="line.1475"></a>
<span class="sourceLineNo">1476</span>        }<a name="line.1476"></a>
<span class="sourceLineNo">1477</span>    }<a name="line.1477"></a>
<span class="sourceLineNo">1478</span><a name="line.1478"></a>
<span class="sourceLineNo">1479</span>    /** Listener for help menu commands. */<a name="line.1479"></a>
<span class="sourceLineNo">1480</span>    class HelpMenuListener implements ActionListener {<a name="line.1480"></a>
<span class="sourceLineNo">1481</span>        @Override<a name="line.1481"></a>
<span class="sourceLineNo">1482</span>        public void actionPerformed(ActionEvent e) {<a name="line.1482"></a>
<span class="sourceLineNo">1483</span>            // Make this the default context for modal messages.<a name="line.1483"></a>
<span class="sourceLineNo">1484</span>            UndeferredGraphicalMessageHandler.setContext(Top.this);<a name="line.1484"></a>
<span class="sourceLineNo">1485</span><a name="line.1485"></a>
<span class="sourceLineNo">1486</span>            JMenuItem target = (JMenuItem) e.getSource();<a name="line.1486"></a>
<span class="sourceLineNo">1487</span>            String actionCommand = target.getActionCommand();<a name="line.1487"></a>
<span class="sourceLineNo">1488</span><a name="line.1488"></a>
<span class="sourceLineNo">1489</span>            try {<a name="line.1489"></a>
<span class="sourceLineNo">1490</span>                if (actionCommand.equals("About")) {<a name="line.1490"></a>
<span class="sourceLineNo">1491</span>                    _about();<a name="line.1491"></a>
<span class="sourceLineNo">1492</span>                } else if (actionCommand.equals("Help")) {<a name="line.1492"></a>
<span class="sourceLineNo">1493</span>                    _help();<a name="line.1493"></a>
<span class="sourceLineNo">1494</span>                }<a name="line.1494"></a>
<span class="sourceLineNo">1495</span>            } catch (Throwable throwable) {<a name="line.1495"></a>
<span class="sourceLineNo">1496</span>                // If we do not catch exceptions here, then they<a name="line.1496"></a>
<span class="sourceLineNo">1497</span>                // disappear to stdout, which is bad if we launched<a name="line.1497"></a>
<span class="sourceLineNo">1498</span>                // where there is no stdout visible.<a name="line.1498"></a>
<span class="sourceLineNo">1499</span>                MessageHandler.error("Help Menu Exception:", throwable);<a name="line.1499"></a>
<span class="sourceLineNo">1500</span>            }<a name="line.1500"></a>
<span class="sourceLineNo">1501</span><a name="line.1501"></a>
<span class="sourceLineNo">1502</span>            // NOTE: The following should not be needed, but there jdk1.3beta<a name="line.1502"></a>
<span class="sourceLineNo">1503</span>            // appears to have a bug in swing where repainting doesn't<a name="line.1503"></a>
<span class="sourceLineNo">1504</span>            // properly occur.<a name="line.1504"></a>
<span class="sourceLineNo">1505</span>            repaint();<a name="line.1505"></a>
<span class="sourceLineNo">1506</span>        }<a name="line.1506"></a>
<span class="sourceLineNo">1507</span>    }<a name="line.1507"></a>
<span class="sourceLineNo">1508</span><a name="line.1508"></a>
<span class="sourceLineNo">1509</span>    ///////////////////////////////////////////////////////////////////<a name="line.1509"></a>
<span class="sourceLineNo">1510</span>    ////                         private methods                   ////<a name="line.1510"></a>
<span class="sourceLineNo">1511</span><a name="line.1511"></a>
<span class="sourceLineNo">1512</span>    // Execute all actions pending on the deferred action list.<a name="line.1512"></a>
<span class="sourceLineNo">1513</span>    // The list is cleared and the _actionsDeferred variable is set<a name="line.1513"></a>
<span class="sourceLineNo">1514</span>    // to false, even if one of the deferred actions fails.<a name="line.1514"></a>
<span class="sourceLineNo">1515</span>    // This method should only be invoked in the event dispatch thread.<a name="line.1515"></a>
<span class="sourceLineNo">1516</span>    // It is synchronized on the _deferredActions list, so the integrity<a name="line.1516"></a>
<span class="sourceLineNo">1517</span>    // of that list is ensured, since modifications to that list occur<a name="line.1517"></a>
<span class="sourceLineNo">1518</span>    // only in other places that are also synchronized on the list.<a name="line.1518"></a>
<span class="sourceLineNo">1519</span>    private static void _executeDeferredActions() {<a name="line.1519"></a>
<span class="sourceLineNo">1520</span>        // Copy the list so that we do not hold the synchronization lock<a name="line.1520"></a>
<span class="sourceLineNo">1521</span>        // while executing the actions.<a name="line.1521"></a>
<span class="sourceLineNo">1522</span>        LinkedList actionsCopy = null;<a name="line.1522"></a>
<span class="sourceLineNo">1523</span>        synchronized (_deferredActions) {<a name="line.1523"></a>
<span class="sourceLineNo">1524</span>            actionsCopy = new LinkedList(_deferredActions);<a name="line.1524"></a>
<span class="sourceLineNo">1525</span>            _actionsDeferred = false;<a name="line.1525"></a>
<span class="sourceLineNo">1526</span>            _deferredActions.clear();<a name="line.1526"></a>
<span class="sourceLineNo">1527</span>        }<a name="line.1527"></a>
<span class="sourceLineNo">1528</span>        Iterator actions = actionsCopy.iterator();<a name="line.1528"></a>
<span class="sourceLineNo">1529</span><a name="line.1529"></a>
<span class="sourceLineNo">1530</span>        // Collect and report exceptions.<a name="line.1530"></a>
<span class="sourceLineNo">1531</span>        LinkedList&lt;Throwable&gt; exceptions = null;<a name="line.1531"></a>
<span class="sourceLineNo">1532</span>        while (actions.hasNext()) {<a name="line.1532"></a>
<span class="sourceLineNo">1533</span>            Runnable action = (Runnable) actions.next();<a name="line.1533"></a>
<span class="sourceLineNo">1534</span>            try {<a name="line.1534"></a>
<span class="sourceLineNo">1535</span>                action.run();<a name="line.1535"></a>
<span class="sourceLineNo">1536</span>            } catch (Throwable ex) {<a name="line.1536"></a>
<span class="sourceLineNo">1537</span>                if (exceptions == null) {<a name="line.1537"></a>
<span class="sourceLineNo">1538</span>                    exceptions = new LinkedList&lt;Throwable&gt;();<a name="line.1538"></a>
<span class="sourceLineNo">1539</span>                }<a name="line.1539"></a>
<span class="sourceLineNo">1540</span>                exceptions.add(ex);<a name="line.1540"></a>
<span class="sourceLineNo">1541</span>            }<a name="line.1541"></a>
<span class="sourceLineNo">1542</span>        }<a name="line.1542"></a>
<span class="sourceLineNo">1543</span>        if (exceptions != null) {<a name="line.1543"></a>
<span class="sourceLineNo">1544</span>            StringBuffer message = new StringBuffer(<a name="line.1544"></a>
<span class="sourceLineNo">1545</span>                    "Exceptions occurred in deferred actions:\n");<a name="line.1545"></a>
<span class="sourceLineNo">1546</span>            for (Throwable exception : exceptions) {<a name="line.1546"></a>
<span class="sourceLineNo">1547</span>                message.append(exception);<a name="line.1547"></a>
<span class="sourceLineNo">1548</span>                message.append("\n");<a name="line.1548"></a>
<span class="sourceLineNo">1549</span>            }<a name="line.1549"></a>
<span class="sourceLineNo">1550</span>            MessageHandler.error(message.toString(), exceptions.get(0));<a name="line.1550"></a>
<span class="sourceLineNo">1551</span>        }<a name="line.1551"></a>
<span class="sourceLineNo">1552</span>    }<a name="line.1552"></a>
<span class="sourceLineNo">1553</span><a name="line.1553"></a>
<span class="sourceLineNo">1554</span>    /** Return the value of the history file name.<a name="line.1554"></a>
<span class="sourceLineNo">1555</span>     *  @return The value of the history file name, which is usually in<a name="line.1555"></a>
<span class="sourceLineNo">1556</span>     *  the Ptolemy II preferences directory.  The value returned is usually.<a name="line.1556"></a>
<span class="sourceLineNo">1557</span>     *  "~/.ptolemyII/history.txt".<a name="line.1557"></a>
<span class="sourceLineNo">1558</span>     *  @exception IOException If thrown while reading the preferences directory.<a name="line.1558"></a>
<span class="sourceLineNo">1559</span>     */<a name="line.1559"></a>
<span class="sourceLineNo">1560</span>    private String _getHistoryFileName() throws IOException {<a name="line.1560"></a>
<span class="sourceLineNo">1561</span>        return StringUtilities.preferencesDirectory() + "history.txt";<a name="line.1561"></a>
<span class="sourceLineNo">1562</span>    }<a name="line.1562"></a>
<span class="sourceLineNo">1563</span><a name="line.1563"></a>
<span class="sourceLineNo">1564</span>    /** Open a file dialog using the java.awt.Dialog class to identify<a name="line.1564"></a>
<span class="sourceLineNo">1565</span>     *  a file to be opened, and then call _read() to open the file.<a name="line.1565"></a>
<span class="sourceLineNo">1566</span>     *  Under Mac OS X, this method is preferred over _openJFileChooser()<a name="line.1566"></a>
<span class="sourceLineNo">1567</span>     *  because this method uses java.awt.Dialog, whereas _openJFileChooser()<a name="line.1567"></a>
<span class="sourceLineNo">1568</span>     *  uses javax.swing.JFileChooser.<a name="line.1568"></a>
<span class="sourceLineNo">1569</span>     */<a name="line.1569"></a>
<span class="sourceLineNo">1570</span>    private void _openFileDialog() {<a name="line.1570"></a>
<span class="sourceLineNo">1571</span>        FileDialog fileDialog = new FileDialog(this, "Select a model file",<a name="line.1571"></a>
<span class="sourceLineNo">1572</span>                FileDialog.LOAD);<a name="line.1572"></a>
<span class="sourceLineNo">1573</span><a name="line.1573"></a>
<span class="sourceLineNo">1574</span>        if (_filenameFilter != null) {<a name="line.1574"></a>
<span class="sourceLineNo">1575</span>            fileDialog.setFilenameFilter(_filenameFilter);<a name="line.1575"></a>
<span class="sourceLineNo">1576</span>        }<a name="line.1576"></a>
<span class="sourceLineNo">1577</span>        boolean fail = false;<a name="line.1577"></a>
<span class="sourceLineNo">1578</span>        if (_directory != null) {<a name="line.1578"></a>
<span class="sourceLineNo">1579</span>            try {<a name="line.1579"></a>
<span class="sourceLineNo">1580</span>                fileDialog.setDirectory(_directory.getCanonicalPath());<a name="line.1580"></a>
<span class="sourceLineNo">1581</span>            } catch (IOException ex) {<a name="line.1581"></a>
<span class="sourceLineNo">1582</span>                fail = true;<a name="line.1582"></a>
<span class="sourceLineNo">1583</span>            }<a name="line.1583"></a>
<span class="sourceLineNo">1584</span>        }<a name="line.1584"></a>
<span class="sourceLineNo">1585</span>        if (fail || _directory == null) {<a name="line.1585"></a>
<span class="sourceLineNo">1586</span>            // The default on Windows is to open at user.home, which is<a name="line.1586"></a>
<span class="sourceLineNo">1587</span>            // typically an absurd directory inside the O/S installation.<a name="line.1587"></a>
<span class="sourceLineNo">1588</span>            // So we use the current directory instead.<a name="line.1588"></a>
<span class="sourceLineNo">1589</span>            // This will throw a security exception in an applet.<a name="line.1589"></a>
<span class="sourceLineNo">1590</span>            // FIXME: we should support users under applets opening files<a name="line.1590"></a>
<span class="sourceLineNo">1591</span>            // on the server.<a name="line.1591"></a>
<span class="sourceLineNo">1592</span>            String currentWorkingDirectory = StringUtilities<a name="line.1592"></a>
<span class="sourceLineNo">1593</span>                    .getProperty("user.dir");<a name="line.1593"></a>
<span class="sourceLineNo">1594</span><a name="line.1594"></a>
<span class="sourceLineNo">1595</span>            if (currentWorkingDirectory != null) {<a name="line.1595"></a>
<span class="sourceLineNo">1596</span>                fileDialog.setDirectory(currentWorkingDirectory);<a name="line.1596"></a>
<span class="sourceLineNo">1597</span>            }<a name="line.1597"></a>
<span class="sourceLineNo">1598</span>        }<a name="line.1598"></a>
<span class="sourceLineNo">1599</span><a name="line.1599"></a>
<span class="sourceLineNo">1600</span>        fileDialog.show();<a name="line.1600"></a>
<span class="sourceLineNo">1601</span><a name="line.1601"></a>
<span class="sourceLineNo">1602</span>        if (fileDialog.getDirectory() == null) {<a name="line.1602"></a>
<span class="sourceLineNo">1603</span>            _directory = new File("");<a name="line.1603"></a>
<span class="sourceLineNo">1604</span>        } else {<a name="line.1604"></a>
<span class="sourceLineNo">1605</span>            _directory = new File(fileDialog.getDirectory());<a name="line.1605"></a>
<span class="sourceLineNo">1606</span>        }<a name="line.1606"></a>
<span class="sourceLineNo">1607</span><a name="line.1607"></a>
<span class="sourceLineNo">1608</span>        try {<a name="line.1608"></a>
<span class="sourceLineNo">1609</span>            // NOTE: It would be nice if it were possible to enter<a name="line.1609"></a>
<span class="sourceLineNo">1610</span>            // a URL in the file chooser, but Java's file chooser does<a name="line.1610"></a>
<span class="sourceLineNo">1611</span>            // not permit this, regrettably.  So we have a separate<a name="line.1611"></a>
<span class="sourceLineNo">1612</span>            // menu item for this.<a name="line.1612"></a>
<span class="sourceLineNo">1613</span>            File file = new File(_directory, fileDialog.getFile());<a name="line.1613"></a>
<span class="sourceLineNo">1614</span>            // Report on the time it takes to open the model.<a name="line.1614"></a>
<span class="sourceLineNo">1615</span>            long startTime = System.currentTimeMillis();<a name="line.1615"></a>
<span class="sourceLineNo">1616</span>            _read(file.toURI().toURL());<a name="line.1616"></a>
<span class="sourceLineNo">1617</span>            long endTime = System.currentTimeMillis();<a name="line.1617"></a>
<span class="sourceLineNo">1618</span>            if (endTime &gt; startTime + 10000) {<a name="line.1618"></a>
<span class="sourceLineNo">1619</span>                // Only print the time if it is more than 10<a name="line.1619"></a>
<span class="sourceLineNo">1620</span>                // seconds See also PtolemyEffigy.  Perhaps<a name="line.1620"></a>
<span class="sourceLineNo">1621</span>                // this code should be in PtolemyEffigy, but<a name="line.1621"></a>
<span class="sourceLineNo">1622</span>                // if it is here, we get the time it takes to<a name="line.1622"></a>
<span class="sourceLineNo">1623</span>                // read any file, not just a Ptolemy model.<a name="line.1623"></a>
<span class="sourceLineNo">1624</span>                System.out.println("Opened " + file + " in "<a name="line.1624"></a>
<span class="sourceLineNo">1625</span>                        + (System.currentTimeMillis() - startTime) + " ms.");<a name="line.1625"></a>
<span class="sourceLineNo">1626</span>            }<a name="line.1626"></a>
<span class="sourceLineNo">1627</span>            // Only add file if no exception<a name="line.1627"></a>
<span class="sourceLineNo">1628</span>            _updateHistory(file.getAbsolutePath(), false);<a name="line.1628"></a>
<span class="sourceLineNo">1629</span><a name="line.1629"></a>
<span class="sourceLineNo">1630</span>        } catch (Error error) {<a name="line.1630"></a>
<span class="sourceLineNo">1631</span>            // Be sure to catch Error here so that if we throw an<a name="line.1631"></a>
<span class="sourceLineNo">1632</span>            // Error, then we will report it to with a window.<a name="line.1632"></a>
<span class="sourceLineNo">1633</span>            try {<a name="line.1633"></a>
<span class="sourceLineNo">1634</span>                throw new RuntimeException(error);<a name="line.1634"></a>
<span class="sourceLineNo">1635</span>            } catch (Exception ex2) {<a name="line.1635"></a>
<span class="sourceLineNo">1636</span>                report("Error while reading input:", ex2);<a name="line.1636"></a>
<span class="sourceLineNo">1637</span>            }<a name="line.1637"></a>
<span class="sourceLineNo">1638</span>        } catch (Exception ex) {<a name="line.1638"></a>
<span class="sourceLineNo">1639</span>            // NOTE: The XML parser can only throw an<a name="line.1639"></a>
<span class="sourceLineNo">1640</span>            // XmlException.  It signals that it is a user<a name="line.1640"></a>
<span class="sourceLineNo">1641</span>            // cancellation with the special string pattern<a name="line.1641"></a>
<span class="sourceLineNo">1642</span>            // "*** Canceled." in the message.<a name="line.1642"></a>
<span class="sourceLineNo">1643</span><a name="line.1643"></a>
<span class="sourceLineNo">1644</span>            if (ex.getMessage() != null<a name="line.1644"></a>
<span class="sourceLineNo">1645</span>                    &amp;&amp; !ex.getMessage().startsWith("*** Canceled.")) {<a name="line.1645"></a>
<span class="sourceLineNo">1646</span>                // No need to report a CancelException, since<a name="line.1646"></a>
<span class="sourceLineNo">1647</span>                // it results from the user clicking a<a name="line.1647"></a>
<span class="sourceLineNo">1648</span>                // "Cancel" button.<a name="line.1648"></a>
<span class="sourceLineNo">1649</span>                report("Error reading input", ex);<a name="line.1649"></a>
<span class="sourceLineNo">1650</span>            }<a name="line.1650"></a>
<span class="sourceLineNo">1651</span>        }<a name="line.1651"></a>
<span class="sourceLineNo">1652</span>    }<a name="line.1652"></a>
<span class="sourceLineNo">1653</span><a name="line.1653"></a>
<span class="sourceLineNo">1654</span>    /** Open a file dialog to identify a file to be opened, and then call<a name="line.1654"></a>
<span class="sourceLineNo">1655</span>     *  _read() to open the file.<a name="line.1655"></a>
<span class="sourceLineNo">1656</span>     */<a name="line.1656"></a>
<span class="sourceLineNo">1657</span>    private void _openJFileChooser() {<a name="line.1657"></a>
<span class="sourceLineNo">1658</span>        // Swap backgrounds and avoid white boxes in "common places" dialog<a name="line.1658"></a>
<span class="sourceLineNo">1659</span>        JFileChooserBugFix jFileChooserBugFix = new JFileChooserBugFix();<a name="line.1659"></a>
<span class="sourceLineNo">1660</span>        Color background = null;<a name="line.1660"></a>
<span class="sourceLineNo">1661</span>        try {<a name="line.1661"></a>
<span class="sourceLineNo">1662</span>            background = jFileChooserBugFix.saveBackground();<a name="line.1662"></a>
<span class="sourceLineNo">1663</span><a name="line.1663"></a>
<span class="sourceLineNo">1664</span>            JFileChooser fileDialog = new JFileChooser();<a name="line.1664"></a>
<span class="sourceLineNo">1665</span><a name="line.1665"></a>
<span class="sourceLineNo">1666</span>            // To disable the Windows places bar on the left, uncomment the<a name="line.1666"></a>
<span class="sourceLineNo">1667</span>            // line below.<a name="line.1667"></a>
<span class="sourceLineNo">1668</span>            // fileDialog.putClientProperty("FileChooser.useShellFolder", Boolean.FALSE);<a name="line.1668"></a>
<span class="sourceLineNo">1669</span>            if (_fileFilter != null) {<a name="line.1669"></a>
<span class="sourceLineNo">1670</span>                fileDialog.addChoosableFileFilter(_fileFilter);<a name="line.1670"></a>
<span class="sourceLineNo">1671</span>            }<a name="line.1671"></a>
<span class="sourceLineNo">1672</span><a name="line.1672"></a>
<span class="sourceLineNo">1673</span>            fileDialog.setDialogTitle("Select a model file.");<a name="line.1673"></a>
<span class="sourceLineNo">1674</span><a name="line.1674"></a>
<span class="sourceLineNo">1675</span>            if (_directory != null) {<a name="line.1675"></a>
<span class="sourceLineNo">1676</span>                fileDialog.setCurrentDirectory(_directory);<a name="line.1676"></a>
<span class="sourceLineNo">1677</span>            } else {<a name="line.1677"></a>
<span class="sourceLineNo">1678</span>                // The default on Windows is to open at user.home, which is<a name="line.1678"></a>
<span class="sourceLineNo">1679</span>                // typically an absurd directory inside the O/S installation.<a name="line.1679"></a>
<span class="sourceLineNo">1680</span>                // So we use the current directory instead.<a name="line.1680"></a>
<span class="sourceLineNo">1681</span>                // This will throw a security exception in an applet.<a name="line.1681"></a>
<span class="sourceLineNo">1682</span>                // FIXME: we should support users under applets opening files<a name="line.1682"></a>
<span class="sourceLineNo">1683</span>                // on the server.<a name="line.1683"></a>
<span class="sourceLineNo">1684</span>                String currentWorkingDirectory = StringUtilities<a name="line.1684"></a>
<span class="sourceLineNo">1685</span>                        .getProperty("user.dir");<a name="line.1685"></a>
<span class="sourceLineNo">1686</span><a name="line.1686"></a>
<span class="sourceLineNo">1687</span>                if (currentWorkingDirectory != null) {<a name="line.1687"></a>
<span class="sourceLineNo">1688</span>                    fileDialog.setCurrentDirectory(<a name="line.1688"></a>
<span class="sourceLineNo">1689</span>                            new File(currentWorkingDirectory));<a name="line.1689"></a>
<span class="sourceLineNo">1690</span>                }<a name="line.1690"></a>
<span class="sourceLineNo">1691</span>            }<a name="line.1691"></a>
<span class="sourceLineNo">1692</span><a name="line.1692"></a>
<span class="sourceLineNo">1693</span>            if (fileDialog<a name="line.1693"></a>
<span class="sourceLineNo">1694</span>                    .showOpenDialog(this) == JFileChooser.APPROVE_OPTION) {<a name="line.1694"></a>
<span class="sourceLineNo">1695</span>                _directory = fileDialog.getCurrentDirectory();<a name="line.1695"></a>
<span class="sourceLineNo">1696</span><a name="line.1696"></a>
<span class="sourceLineNo">1697</span>                try {<a name="line.1697"></a>
<span class="sourceLineNo">1698</span>                    // NOTE: It would be nice if it were possible to enter<a name="line.1698"></a>
<span class="sourceLineNo">1699</span>                    // a URL in the file chooser, but Java's file chooser does<a name="line.1699"></a>
<span class="sourceLineNo">1700</span>                    // not permit this, regrettably.  So we have a separate<a name="line.1700"></a>
<span class="sourceLineNo">1701</span>                    // menu item for this.<a name="line.1701"></a>
<span class="sourceLineNo">1702</span>                    File file = fileDialog.getSelectedFile().getCanonicalFile();<a name="line.1702"></a>
<span class="sourceLineNo">1703</span>                    // Report on the time it takes to open the model.<a name="line.1703"></a>
<span class="sourceLineNo">1704</span>                    long startTime = System.currentTimeMillis();<a name="line.1704"></a>
<span class="sourceLineNo">1705</span>                    _read(file.toURI().toURL());<a name="line.1705"></a>
<span class="sourceLineNo">1706</span>                    long endTime = System.currentTimeMillis();<a name="line.1706"></a>
<span class="sourceLineNo">1707</span>                    if (endTime &gt; startTime + 10000) {<a name="line.1707"></a>
<span class="sourceLineNo">1708</span>                        // Only print the time if it is more than 10<a name="line.1708"></a>
<span class="sourceLineNo">1709</span>                        // seconds See also PtolemyEffigy.  Perhaps<a name="line.1709"></a>
<span class="sourceLineNo">1710</span>                        // this code should be in PtolemyEffigy, but<a name="line.1710"></a>
<span class="sourceLineNo">1711</span>                        // if it is here, we get the time it takes to<a name="line.1711"></a>
<span class="sourceLineNo">1712</span>                        // read any file, not just a Ptolemy model.<a name="line.1712"></a>
<span class="sourceLineNo">1713</span>                        System.out.println("Opened " + file + " in "<a name="line.1713"></a>
<span class="sourceLineNo">1714</span>                                + (System.currentTimeMillis() - startTime)<a name="line.1714"></a>
<span class="sourceLineNo">1715</span>                                + " ms.");<a name="line.1715"></a>
<span class="sourceLineNo">1716</span>                    }<a name="line.1716"></a>
<span class="sourceLineNo">1717</span>                    // Only add file if no exception<a name="line.1717"></a>
<span class="sourceLineNo">1718</span>                    _updateHistory(file.getAbsolutePath(), false);<a name="line.1718"></a>
<span class="sourceLineNo">1719</span><a name="line.1719"></a>
<span class="sourceLineNo">1720</span>                } catch (Error error) {<a name="line.1720"></a>
<span class="sourceLineNo">1721</span>                    // Be sure to catch Error here so that if we throw an<a name="line.1721"></a>
<span class="sourceLineNo">1722</span>                    // Error, then we will report it to with a window.<a name="line.1722"></a>
<span class="sourceLineNo">1723</span>                    try {<a name="line.1723"></a>
<span class="sourceLineNo">1724</span>                        throw new RuntimeException(error);<a name="line.1724"></a>
<span class="sourceLineNo">1725</span>                    } catch (Exception ex2) {<a name="line.1725"></a>
<span class="sourceLineNo">1726</span>                        report("Error while reading input:", ex2);<a name="line.1726"></a>
<span class="sourceLineNo">1727</span>                    }<a name="line.1727"></a>
<span class="sourceLineNo">1728</span>                } catch (Exception ex) {<a name="line.1728"></a>
<span class="sourceLineNo">1729</span>                    // NOTE: The XML parser can only throw an<a name="line.1729"></a>
<span class="sourceLineNo">1730</span>                    // XmlException.  It signals that it is a user<a name="line.1730"></a>
<span class="sourceLineNo">1731</span>                    // cancellation with the special string pattern<a name="line.1731"></a>
<span class="sourceLineNo">1732</span>                    // "*** Canceled." in the message.<a name="line.1732"></a>
<span class="sourceLineNo">1733</span><a name="line.1733"></a>
<span class="sourceLineNo">1734</span>                    if (ex.getMessage() != null<a name="line.1734"></a>
<span class="sourceLineNo">1735</span>                            &amp;&amp; !ex.getMessage().startsWith("*** Canceled.")) {<a name="line.1735"></a>
<span class="sourceLineNo">1736</span>                        // No need to report a CancelException, since<a name="line.1736"></a>
<span class="sourceLineNo">1737</span>                        // it results from the user clicking a<a name="line.1737"></a>
<span class="sourceLineNo">1738</span>                        // "Cancel" button.<a name="line.1738"></a>
<span class="sourceLineNo">1739</span>                        report("Error reading input", ex);<a name="line.1739"></a>
<span class="sourceLineNo">1740</span>                    }<a name="line.1740"></a>
<span class="sourceLineNo">1741</span>                }<a name="line.1741"></a>
<span class="sourceLineNo">1742</span>            }<a name="line.1742"></a>
<span class="sourceLineNo">1743</span>        } finally {<a name="line.1743"></a>
<span class="sourceLineNo">1744</span>            jFileChooserBugFix.restoreBackground(background);<a name="line.1744"></a>
<span class="sourceLineNo">1745</span>        }<a name="line.1745"></a>
<span class="sourceLineNo">1746</span>    }<a name="line.1746"></a>
<span class="sourceLineNo">1747</span><a name="line.1747"></a>
<span class="sourceLineNo">1748</span>    /** If we are running under Mac OS X and Java 1.5, the print a<a name="line.1748"></a>
<span class="sourceLineNo">1749</span>     * message about printing problems.<a name="line.1749"></a>
<span class="sourceLineNo">1750</span>     */<a name="line.1750"></a>
<span class="sourceLineNo">1751</span>    private static void _macCheck() {<a name="line.1751"></a>
<span class="sourceLineNo">1752</span>        if (PtGUIUtilities.macOSLookAndFeel()<a name="line.1752"></a>
<span class="sourceLineNo">1753</span>                &amp;&amp; System.getProperty("java.version").startsWith("1.5")) {<a name="line.1753"></a>
<span class="sourceLineNo">1754</span>            System.out.println(<a name="line.1754"></a>
<span class="sourceLineNo">1755</span>                    "Warning, under Mac OS X with Java 1.5, printing might "<a name="line.1755"></a>
<span class="sourceLineNo">1756</span>                            + "not work.  Try recompiling with Java 1.6 or setting a property:\n"<a name="line.1756"></a>
<span class="sourceLineNo">1757</span>                            + "export JAVAFLAGS=-Dptolemy.ptII.print.platform=CrossPlatform\n"<a name="line.1757"></a>
<span class="sourceLineNo">1758</span>                            + "and restarting vergil: $PTII/bin/vergil");<a name="line.1758"></a>
<span class="sourceLineNo">1759</span>        }<a name="line.1759"></a>
<span class="sourceLineNo">1760</span>    }<a name="line.1760"></a>
<span class="sourceLineNo">1761</span><a name="line.1761"></a>
<span class="sourceLineNo">1762</span>    /** Initialize the menus and key bindings for Mac OS X. */<a name="line.1762"></a>
<span class="sourceLineNo">1763</span>    private void _macInitializer() {<a name="line.1763"></a>
<span class="sourceLineNo">1764</span>        // FIXME: This code causes a memory leak because<a name="line.1764"></a>
<span class="sourceLineNo">1765</span>        // MacOSXAdapter and JPopupMenu return retain references to<a name="line.1765"></a>
<span class="sourceLineNo">1766</span>        // ActorGraphFrame.  Also, MacOSXAdapter uses deprecated<a name="line.1766"></a>
<span class="sourceLineNo">1767</span>        // methods via reflection.<a name="line.1767"></a>
<span class="sourceLineNo">1768</span>        try {<a name="line.1768"></a>
<span class="sourceLineNo">1769</span>            // To set the about name, set the<a name="line.1769"></a>
<span class="sourceLineNo">1770</span>            // com.apple.mrj.application.apple.menu.about.name<a name="line.1770"></a>
<span class="sourceLineNo">1771</span>            // property in the main thread, not the event thread.  See<a name="line.1771"></a>
<span class="sourceLineNo">1772</span>            // VergilApplication.java<a name="line.1772"></a>
<span class="sourceLineNo">1773</span>            MacOSXAdapter.setAboutMethod(this,<a name="line.1773"></a>
<span class="sourceLineNo">1774</span>                    getClass().getMethod("about", (Class[]) null));<a name="line.1774"></a>
<span class="sourceLineNo">1775</span>            MacOSXAdapter.setQuitMethod(this,<a name="line.1775"></a>
<span class="sourceLineNo">1776</span>                    getClass().getMethod("exit", (Class[]) null));<a name="line.1776"></a>
<span class="sourceLineNo">1777</span>        } catch (NoSuchMethodException ex) {<a name="line.1777"></a>
<span class="sourceLineNo">1778</span>            report("Mac OS X specific initializations failed.", ex);<a name="line.1778"></a>
<span class="sourceLineNo">1779</span>        }<a name="line.1779"></a>
<span class="sourceLineNo">1780</span>    }<a name="line.1780"></a>
<span class="sourceLineNo">1781</span><a name="line.1781"></a>
<span class="sourceLineNo">1782</span>    /** Get the history from the file that contains names<a name="line.1782"></a>
<span class="sourceLineNo">1783</span>     * Always return a list, that can be empty<a name="line.1783"></a>
<span class="sourceLineNo">1784</span>     * @return list of file history<a name="line.1784"></a>
<span class="sourceLineNo">1785</span>     */<a name="line.1785"></a>
<span class="sourceLineNo">1786</span>    private List&lt;String&gt; _readHistory() throws IOException {<a name="line.1786"></a>
<span class="sourceLineNo">1787</span>        ArrayList&lt;String&gt; historyList = new ArrayList&lt;String&gt;();<a name="line.1787"></a>
<span class="sourceLineNo">1788</span>        String historyFileName = _getHistoryFileName();<a name="line.1788"></a>
<span class="sourceLineNo">1789</span>        if (!new File(historyFileName).exists()) {<a name="line.1789"></a>
<span class="sourceLineNo">1790</span>            // No history file, so just return<a name="line.1790"></a>
<span class="sourceLineNo">1791</span>            return historyList;<a name="line.1791"></a>
<span class="sourceLineNo">1792</span>        }<a name="line.1792"></a>
<span class="sourceLineNo">1793</span>        FileReader fileReader = null;<a name="line.1793"></a>
<span class="sourceLineNo">1794</span>        BufferedReader bufferedReader = null;<a name="line.1794"></a>
<span class="sourceLineNo">1795</span>        try {<a name="line.1795"></a>
<span class="sourceLineNo">1796</span>            fileReader = new FileReader(historyFileName);<a name="line.1796"></a>
<span class="sourceLineNo">1797</span>            bufferedReader = new BufferedReader(fileReader);<a name="line.1797"></a>
<span class="sourceLineNo">1798</span>            String line;<a name="line.1798"></a>
<span class="sourceLineNo">1799</span>            while ((line = bufferedReader.readLine()) != null) {<a name="line.1799"></a>
<span class="sourceLineNo">1800</span>                historyList.add(line);<a name="line.1800"></a>
<span class="sourceLineNo">1801</span>            }<a name="line.1801"></a>
<span class="sourceLineNo">1802</span>        } finally {<a name="line.1802"></a>
<span class="sourceLineNo">1803</span>            if (bufferedReader != null) {<a name="line.1803"></a>
<span class="sourceLineNo">1804</span>                bufferedReader.close();<a name="line.1804"></a>
<span class="sourceLineNo">1805</span>            }<a name="line.1805"></a>
<span class="sourceLineNo">1806</span>        }<a name="line.1806"></a>
<span class="sourceLineNo">1807</span><a name="line.1807"></a>
<span class="sourceLineNo">1808</span>        return historyList;<a name="line.1808"></a>
<span class="sourceLineNo">1809</span>    }<a name="line.1809"></a>
<span class="sourceLineNo">1810</span><a name="line.1810"></a>
<span class="sourceLineNo">1811</span>    /** Query the user for a filename and save the model to that file.<a name="line.1811"></a>
<span class="sourceLineNo">1812</span>     *  @return True if the save succeeds.<a name="line.1812"></a>
<span class="sourceLineNo">1813</span>     */<a name="line.1813"></a>
<span class="sourceLineNo">1814</span>    private boolean _saveAsFileDialogImplementation() {<a name="line.1814"></a>
<span class="sourceLineNo">1815</span>        // This method name ends with "Implementation" because there<a name="line.1815"></a>
<span class="sourceLineNo">1816</span>        // already was a _saveAsFileDialog() method<a name="line.1816"></a>
<span class="sourceLineNo">1817</span><a name="line.1817"></a>
<span class="sourceLineNo">1818</span>        // Use the strategy pattern here to create the actual<a name="line.1818"></a>
<span class="sourceLineNo">1819</span>        // dialog so that subclasses can customize this dialog.<a name="line.1819"></a>
<span class="sourceLineNo">1820</span>        FileDialog fileDialog = _saveAsFileDialogComponent();<a name="line.1820"></a>
<span class="sourceLineNo">1821</span><a name="line.1821"></a>
<span class="sourceLineNo">1822</span>        if (fileDialog == null) {<a name="line.1822"></a>
<span class="sourceLineNo">1823</span>            // Action was canceled.<a name="line.1823"></a>
<span class="sourceLineNo">1824</span>            return false;<a name="line.1824"></a>
<span class="sourceLineNo">1825</span>        }<a name="line.1825"></a>
<span class="sourceLineNo">1826</span><a name="line.1826"></a>
<span class="sourceLineNo">1827</span>        fileDialog.show();<a name="line.1827"></a>
<span class="sourceLineNo">1828</span><a name="line.1828"></a>
<span class="sourceLineNo">1829</span>        _directory = new File(fileDialog.getDirectory());<a name="line.1829"></a>
<span class="sourceLineNo">1830</span><a name="line.1830"></a>
<span class="sourceLineNo">1831</span>        _file = new File(_directory, fileDialog.getFile());<a name="line.1831"></a>
<span class="sourceLineNo">1832</span><a name="line.1832"></a>
<span class="sourceLineNo">1833</span>        // If the file exists, then FileDialog will prompt the user<a name="line.1833"></a>
<span class="sourceLineNo">1834</span>        // so we don't want to prompt them again.<a name="line.1834"></a>
<span class="sourceLineNo">1835</span>        // See "saving xml to existing file asks twice on mac"<a name="line.1835"></a>
<span class="sourceLineNo">1836</span>        // http://bugzilla.ecoinformatics.org/show_bug.cgi?id=5760<a name="line.1836"></a>
<span class="sourceLineNo">1837</span>        //         if (_file.exists()) {<a name="line.1837"></a>
<span class="sourceLineNo">1838</span>        //             // Ask for confirmation before overwriting a file.<a name="line.1838"></a>
<span class="sourceLineNo">1839</span>        //             String query = "Overwrite " + _file.getName() + "?";<a name="line.1839"></a>
<span class="sourceLineNo">1840</span>        //<a name="line.1840"></a>
<span class="sourceLineNo">1841</span>        //             // Show a MODAL dialog<a name="line.1841"></a>
<span class="sourceLineNo">1842</span>        //             int selected = JOptionPane.showOptionDialog(this, query,<a name="line.1842"></a>
<span class="sourceLineNo">1843</span>        //                     "Save Changes?", JOptionPane.YES_NO_OPTION,<a name="line.1843"></a>
<span class="sourceLineNo">1844</span>        //                     JOptionPane.QUESTION_MESSAGE, null, null, null);<a name="line.1844"></a>
<span class="sourceLineNo">1845</span>        //<a name="line.1845"></a>
<span class="sourceLineNo">1846</span>        //             if (selected == 1) {<a name="line.1846"></a>
<span class="sourceLineNo">1847</span>        //                 return false;<a name="line.1847"></a>
<span class="sourceLineNo">1848</span>        //             }<a name="line.1848"></a>
<span class="sourceLineNo">1849</span>        //         }<a name="line.1849"></a>
<span class="sourceLineNo">1850</span><a name="line.1850"></a>
<span class="sourceLineNo">1851</span>        // Truncate the name so that dialogs under Web Start on the Mac<a name="line.1851"></a>
<span class="sourceLineNo">1852</span>        // work better.<a name="line.1852"></a>
<span class="sourceLineNo">1853</span>        setTitle(StringUtilities.abbreviate(_getName()));<a name="line.1853"></a>
<span class="sourceLineNo">1854</span>        return _save();<a name="line.1854"></a>
<span class="sourceLineNo">1855</span>    }<a name="line.1855"></a>
<span class="sourceLineNo">1856</span><a name="line.1856"></a>
<span class="sourceLineNo">1857</span>    /** Query the user for a filename and save the model to that file.<a name="line.1857"></a>
<span class="sourceLineNo">1858</span>     *  @return True if the save succeeds.<a name="line.1858"></a>
<span class="sourceLineNo">1859</span>     */<a name="line.1859"></a>
<span class="sourceLineNo">1860</span>    private boolean _saveAsJFileChooserImplementation() {<a name="line.1860"></a>
<span class="sourceLineNo">1861</span>        // Swap backgrounds and avoid white boxes in "common places" dialog<a name="line.1861"></a>
<span class="sourceLineNo">1862</span>        JFileChooserBugFix jFileChooserBugFix = new JFileChooserBugFix();<a name="line.1862"></a>
<span class="sourceLineNo">1863</span>        Color background = null;<a name="line.1863"></a>
<span class="sourceLineNo">1864</span>        try {<a name="line.1864"></a>
<span class="sourceLineNo">1865</span>            background = jFileChooserBugFix.saveBackground();<a name="line.1865"></a>
<span class="sourceLineNo">1866</span><a name="line.1866"></a>
<span class="sourceLineNo">1867</span>            // Use the strategy pattern here to create the actual<a name="line.1867"></a>
<span class="sourceLineNo">1868</span>            // dialog so that subclasses can customize this dialog.<a name="line.1868"></a>
<span class="sourceLineNo">1869</span>            JFileChooser fileDialog = _saveAsFileDialog();<a name="line.1869"></a>
<span class="sourceLineNo">1870</span><a name="line.1870"></a>
<span class="sourceLineNo">1871</span>            // Under Java 1.6 and Mac OS X, showSaveDialog() ignores the filter.<a name="line.1871"></a>
<span class="sourceLineNo">1872</span>            if (fileDialog<a name="line.1872"></a>
<span class="sourceLineNo">1873</span>                    .showSaveDialog(this) == JFileChooser.APPROVE_OPTION) {<a name="line.1873"></a>
<span class="sourceLineNo">1874</span>                _file = fileDialog.getSelectedFile();<a name="line.1874"></a>
<span class="sourceLineNo">1875</span><a name="line.1875"></a>
<span class="sourceLineNo">1876</span>                if (_file.exists()) {<a name="line.1876"></a>
<span class="sourceLineNo">1877</span>                    // Ask for confirmation before overwriting a file.<a name="line.1877"></a>
<span class="sourceLineNo">1878</span>                    String query = "Overwrite " + _file.getName() + "?";<a name="line.1878"></a>
<span class="sourceLineNo">1879</span><a name="line.1879"></a>
<span class="sourceLineNo">1880</span>                    // Show a MODAL dialog<a name="line.1880"></a>
<span class="sourceLineNo">1881</span>                    int selected = JOptionPane.showOptionDialog(this, query,<a name="line.1881"></a>
<span class="sourceLineNo">1882</span>                            "Save Changes?", JOptionPane.YES_NO_OPTION,<a name="line.1882"></a>
<span class="sourceLineNo">1883</span>                            JOptionPane.QUESTION_MESSAGE, null, null, null);<a name="line.1883"></a>
<span class="sourceLineNo">1884</span><a name="line.1884"></a>
<span class="sourceLineNo">1885</span>                    if (selected == 1) {<a name="line.1885"></a>
<span class="sourceLineNo">1886</span>                        return false;<a name="line.1886"></a>
<span class="sourceLineNo">1887</span>                    }<a name="line.1887"></a>
<span class="sourceLineNo">1888</span>                }<a name="line.1888"></a>
<span class="sourceLineNo">1889</span><a name="line.1889"></a>
<span class="sourceLineNo">1890</span>                // Truncate the name so that dialogs under Web Start on the Mac<a name="line.1890"></a>
<span class="sourceLineNo">1891</span>                // work better.<a name="line.1891"></a>
<span class="sourceLineNo">1892</span>                setTitle(StringUtilities.abbreviate(_getName()));<a name="line.1892"></a>
<span class="sourceLineNo">1893</span>                _directory = fileDialog.getCurrentDirectory();<a name="line.1893"></a>
<span class="sourceLineNo">1894</span>                return _save();<a name="line.1894"></a>
<span class="sourceLineNo">1895</span>            }<a name="line.1895"></a>
<span class="sourceLineNo">1896</span><a name="line.1896"></a>
<span class="sourceLineNo">1897</span>            // Action was canceled.<a name="line.1897"></a>
<span class="sourceLineNo">1898</span>            return false;<a name="line.1898"></a>
<span class="sourceLineNo">1899</span>        } finally {<a name="line.1899"></a>
<span class="sourceLineNo">1900</span>            jFileChooserBugFix.restoreBackground(background);<a name="line.1900"></a>
<span class="sourceLineNo">1901</span>        }<a name="line.1901"></a>
<span class="sourceLineNo">1902</span>    }<a name="line.1902"></a>
<span class="sourceLineNo">1903</span><a name="line.1903"></a>
<span class="sourceLineNo">1904</span>    /** Write history to the file defined by _getHistoryFileName(). */<a name="line.1904"></a>
<span class="sourceLineNo">1905</span>    private void _writeHistory(List&lt;String&gt; historyList) throws IOException {<a name="line.1905"></a>
<span class="sourceLineNo">1906</span>        FileWriter fileWriter = null;<a name="line.1906"></a>
<span class="sourceLineNo">1907</span>        try {<a name="line.1907"></a>
<span class="sourceLineNo">1908</span>            fileWriter = new FileWriter(_getHistoryFileName());<a name="line.1908"></a>
<span class="sourceLineNo">1909</span>            for (String line : historyList) {<a name="line.1909"></a>
<span class="sourceLineNo">1910</span>                fileWriter.write(line + "\n");<a name="line.1910"></a>
<span class="sourceLineNo">1911</span>            }<a name="line.1911"></a>
<span class="sourceLineNo">1912</span>        } finally {<a name="line.1912"></a>
<span class="sourceLineNo">1913</span>            if (fileWriter != null) {<a name="line.1913"></a>
<span class="sourceLineNo">1914</span>                fileWriter.close();<a name="line.1914"></a>
<span class="sourceLineNo">1915</span>            }<a name="line.1915"></a>
<span class="sourceLineNo">1916</span>        }<a name="line.1916"></a>
<span class="sourceLineNo">1917</span>    }<a name="line.1917"></a>
<span class="sourceLineNo">1918</span><a name="line.1918"></a>
<span class="sourceLineNo">1919</span>    ///////////////////////////////////////////////////////////////////<a name="line.1919"></a>
<span class="sourceLineNo">1920</span>    ////                         protected variables               ////<a name="line.1920"></a>
<span class="sourceLineNo">1921</span><a name="line.1921"></a>
<span class="sourceLineNo">1922</span>    /** Set to true to print closing sequence information to standard<a name="line.1922"></a>
<span class="sourceLineNo">1923</span>     * out.<a name="line.1923"></a>
<span class="sourceLineNo">1924</span>     */<a name="line.1924"></a>
<span class="sourceLineNo">1925</span>    protected boolean _debugClosing = false;<a name="line.1925"></a>
<span class="sourceLineNo">1926</span><a name="line.1926"></a>
<span class="sourceLineNo">1927</span>    ///////////////////////////////////////////////////////////////////<a name="line.1927"></a>
<span class="sourceLineNo">1928</span>    ////                         inner classes                     ////<a name="line.1928"></a>
<span class="sourceLineNo">1929</span><a name="line.1929"></a>
<span class="sourceLineNo">1930</span>    /** A runnable for showing the window. */<a name="line.1930"></a>
<span class="sourceLineNo">1931</span>    class ShowWindowRunnable implements Runnable {<a name="line.1931"></a>
<span class="sourceLineNo">1932</span>        @Override<a name="line.1932"></a>
<span class="sourceLineNo">1933</span>        public void run() {<a name="line.1933"></a>
<span class="sourceLineNo">1934</span>            // NOTE: We used to call pack() here, but this would<a name="line.1934"></a>
<span class="sourceLineNo">1935</span>            // override any manual changes in sizing that had been<a name="line.1935"></a>
<span class="sourceLineNo">1936</span>            // made.<a name="line.1936"></a>
<span class="sourceLineNo">1937</span>            setState(Frame.NORMAL);<a name="line.1937"></a>
<span class="sourceLineNo">1938</span>            // FIXME: show() is deprecated, but calling setVisible()<a name="line.1938"></a>
<span class="sourceLineNo">1939</span>            // here results in a loop.<a name="line.1939"></a>
<span class="sourceLineNo">1940</span>            //Top.super.setVisible(true);<a name="line.1940"></a>
<span class="sourceLineNo">1941</span>            Top.super.show();<a name="line.1941"></a>
<span class="sourceLineNo">1942</span><a name="line.1942"></a>
<span class="sourceLineNo">1943</span>        }<a name="line.1943"></a>
<span class="sourceLineNo">1944</span>    }<a name="line.1944"></a>
<span class="sourceLineNo">1945</span><a name="line.1945"></a>
<span class="sourceLineNo">1946</span>    /** A runnable for setting the status bar message for a report. */<a name="line.1946"></a>
<span class="sourceLineNo">1947</span>    class StatusBarMessageReportRunnable implements Runnable {<a name="line.1947"></a>
<span class="sourceLineNo">1948</span>        public StatusBarMessageReportRunnable(String message,<a name="line.1948"></a>
<span class="sourceLineNo">1949</span>                Throwable throwable) {<a name="line.1949"></a>
<span class="sourceLineNo">1950</span>            _message = message;<a name="line.1950"></a>
<span class="sourceLineNo">1951</span>            _throwable = throwable;<a name="line.1951"></a>
<span class="sourceLineNo">1952</span>        }<a name="line.1952"></a>
<span class="sourceLineNo">1953</span><a name="line.1953"></a>
<span class="sourceLineNo">1954</span>        @Override<a name="line.1954"></a>
<span class="sourceLineNo">1955</span>        public void run() {<a name="line.1955"></a>
<span class="sourceLineNo">1956</span>            if (_statusBar != null) {<a name="line.1956"></a>
<span class="sourceLineNo">1957</span>                _statusBar<a name="line.1957"></a>
<span class="sourceLineNo">1958</span>                        .setMessage(MessageHandler.shortDescription(_throwable)<a name="line.1958"></a>
<span class="sourceLineNo">1959</span>                                + ". " + _message);<a name="line.1959"></a>
<span class="sourceLineNo">1960</span>            }<a name="line.1960"></a>
<span class="sourceLineNo">1961</span><a name="line.1961"></a>
<span class="sourceLineNo">1962</span>            MessageHandler.error(_message, _throwable);<a name="line.1962"></a>
<span class="sourceLineNo">1963</span>        }<a name="line.1963"></a>
<span class="sourceLineNo">1964</span><a name="line.1964"></a>
<span class="sourceLineNo">1965</span>        private String _message;<a name="line.1965"></a>
<span class="sourceLineNo">1966</span>        private Throwable _throwable;<a name="line.1966"></a>
<span class="sourceLineNo">1967</span>    }<a name="line.1967"></a>
<span class="sourceLineNo">1968</span><a name="line.1968"></a>
<span class="sourceLineNo">1969</span>    /** A runnable for setting the status bar message. */<a name="line.1969"></a>
<span class="sourceLineNo">1970</span>    class StatusBarMessageRunnable implements Runnable {<a name="line.1970"></a>
<span class="sourceLineNo">1971</span>        public StatusBarMessageRunnable(String message) {<a name="line.1971"></a>
<span class="sourceLineNo">1972</span>            _message = message;<a name="line.1972"></a>
<span class="sourceLineNo">1973</span>        }<a name="line.1973"></a>
<span class="sourceLineNo">1974</span><a name="line.1974"></a>
<span class="sourceLineNo">1975</span>        @Override<a name="line.1975"></a>
<span class="sourceLineNo">1976</span>        public void run() {<a name="line.1976"></a>
<span class="sourceLineNo">1977</span>            if (_statusBar != null) {<a name="line.1977"></a>
<span class="sourceLineNo">1978</span>                _statusBar.setMessage(_message);<a name="line.1978"></a>
<span class="sourceLineNo">1979</span>            }<a name="line.1979"></a>
<span class="sourceLineNo">1980</span>        }<a name="line.1980"></a>
<span class="sourceLineNo">1981</span><a name="line.1981"></a>
<span class="sourceLineNo">1982</span>        private String _message;<a name="line.1982"></a>
<span class="sourceLineNo">1983</span>    }<a name="line.1983"></a>
<span class="sourceLineNo">1984</span><a name="line.1984"></a>
<span class="sourceLineNo">1985</span>    /** A runnable for packing the Window. */<a name="line.1985"></a>
<span class="sourceLineNo">1986</span>    class DoPackRunnable implements Runnable {<a name="line.1986"></a>
<span class="sourceLineNo">1987</span>        @Override<a name="line.1987"></a>
<span class="sourceLineNo">1988</span>        public void run() {<a name="line.1988"></a>
<span class="sourceLineNo">1989</span>            // NOTE: This always runs in the swing thread,<a name="line.1989"></a>
<span class="sourceLineNo">1990</span>            // so there is no need to synchronize.<a name="line.1990"></a>
<span class="sourceLineNo">1991</span>            if (!_menuPopulated) {<a name="line.1991"></a>
<span class="sourceLineNo">1992</span>                // Set up the menus.<a name="line.1992"></a>
<span class="sourceLineNo">1993</span>                _fileMenu.setMnemonic(KeyEvent.VK_F);<a name="line.1993"></a>
<span class="sourceLineNo">1994</span>                _helpMenu.setMnemonic(KeyEvent.VK_H);<a name="line.1994"></a>
<span class="sourceLineNo">1995</span><a name="line.1995"></a>
<span class="sourceLineNo">1996</span>                // Construct the File menu by adding action commands<a name="line.1996"></a>
<span class="sourceLineNo">1997</span>                // and action listeners.<a name="line.1997"></a>
<span class="sourceLineNo">1998</span><a name="line.1998"></a>
<span class="sourceLineNo">1999</span>                // Set the action command and listener for each menu item.<a name="line.1999"></a>
<span class="sourceLineNo">2000</span>                for (JMenuItem _fileMenuItem : _fileMenuItems) {<a name="line.2000"></a>
<span class="sourceLineNo">2001</span>                    if (_fileMenuItem == null) {<a name="line.2001"></a>
<span class="sourceLineNo">2002</span>                        _fileMenu.addSeparator();<a name="line.2002"></a>
<span class="sourceLineNo">2003</span>                    } else {<a name="line.2003"></a>
<span class="sourceLineNo">2004</span>                        _fileMenuItem.setActionCommand(_fileMenuItem.getText());<a name="line.2004"></a>
<span class="sourceLineNo">2005</span>                        _fileMenuItem.addActionListener(_fileMenuListener);<a name="line.2005"></a>
<span class="sourceLineNo">2006</span>                        _fileMenu.add(_fileMenuItem);<a name="line.2006"></a>
<span class="sourceLineNo">2007</span>                    }<a name="line.2007"></a>
<span class="sourceLineNo">2008</span>                }<a name="line.2008"></a>
<span class="sourceLineNo">2009</span><a name="line.2009"></a>
<span class="sourceLineNo">2010</span>                _menubar.add(_fileMenu);<a name="line.2010"></a>
<span class="sourceLineNo">2011</span><a name="line.2011"></a>
<span class="sourceLineNo">2012</span>                // History fill<a name="line.2012"></a>
<span class="sourceLineNo">2013</span>                try {<a name="line.2013"></a>
<span class="sourceLineNo">2014</span>                    _populateHistory(_readHistory());<a name="line.2014"></a>
<span class="sourceLineNo">2015</span>                } catch (IOException ex) {<a name="line.2015"></a>
<span class="sourceLineNo">2016</span>                    // Ignore<a name="line.2016"></a>
<span class="sourceLineNo">2017</span>                } catch (SecurityException ex) {<a name="line.2017"></a>
<span class="sourceLineNo">2018</span>                    // Ignore<a name="line.2018"></a>
<span class="sourceLineNo">2019</span>                }<a name="line.2019"></a>
<span class="sourceLineNo">2020</span><a name="line.2020"></a>
<span class="sourceLineNo">2021</span>                // Construct the Help menu by adding action commands<a name="line.2021"></a>
<span class="sourceLineNo">2022</span>                // and action listeners.<a name="line.2022"></a>
<span class="sourceLineNo">2023</span><a name="line.2023"></a>
<span class="sourceLineNo">2024</span>                // Set the action command and listener for each menu item.<a name="line.2024"></a>
<span class="sourceLineNo">2025</span>                for (JMenuItem _helpMenuItem : _helpMenuItems) {<a name="line.2025"></a>
<span class="sourceLineNo">2026</span>                    _helpMenuItem.setActionCommand(_helpMenuItem.getText());<a name="line.2026"></a>
<span class="sourceLineNo">2027</span>                    _helpMenuItem.addActionListener(_helpMenuListener);<a name="line.2027"></a>
<span class="sourceLineNo">2028</span>                    _helpMenu.add(_helpMenuItem);<a name="line.2028"></a>
<span class="sourceLineNo">2029</span>                }<a name="line.2029"></a>
<span class="sourceLineNo">2030</span><a name="line.2030"></a>
<span class="sourceLineNo">2031</span>                // Unfortunately, at this time, Java provides no<a name="line.2031"></a>
<span class="sourceLineNo">2032</span>                // mechanism for derived classes to insert menus<a name="line.2032"></a>
<span class="sourceLineNo">2033</span>                // at arbitrary points in the menu bar.  Also, the<a name="line.2033"></a>
<span class="sourceLineNo">2034</span>                // menubar ignores the alignment property of the<a name="line.2034"></a>
<span class="sourceLineNo">2035</span>                // JMenu.  By convention, however, we want the<a name="line.2035"></a>
<span class="sourceLineNo">2036</span>                // help menu to be the rightmost menu.  Thus, we<a name="line.2036"></a>
<span class="sourceLineNo">2037</span>                // use a strategy pattern here, and call a<a name="line.2037"></a>
<span class="sourceLineNo">2038</span>                // protected method that derived classes can use<a name="line.2038"></a>
<span class="sourceLineNo">2039</span>                // to add menus.<a name="line.2039"></a>
<span class="sourceLineNo">2040</span>                _addMenus();<a name="line.2040"></a>
<span class="sourceLineNo">2041</span><a name="line.2041"></a>
<span class="sourceLineNo">2042</span>                _menubar.add(_helpMenu);<a name="line.2042"></a>
<span class="sourceLineNo">2043</span><a name="line.2043"></a>
<span class="sourceLineNo">2044</span>                if (!_hideMenuBar) {<a name="line.2044"></a>
<span class="sourceLineNo">2045</span>                    setJMenuBar(_menubar);<a name="line.2045"></a>
<span class="sourceLineNo">2046</span>                }<a name="line.2046"></a>
<span class="sourceLineNo">2047</span><a name="line.2047"></a>
<span class="sourceLineNo">2048</span>                // Add the status bar, if there is one.<a name="line.2048"></a>
<span class="sourceLineNo">2049</span>                if (_statusBar != null) {<a name="line.2049"></a>
<span class="sourceLineNo">2050</span>                    getContentPane().add(_statusBar, BorderLayout.SOUTH);<a name="line.2050"></a>
<span class="sourceLineNo">2051</span>                }<a name="line.2051"></a>
<span class="sourceLineNo">2052</span>            }<a name="line.2052"></a>
<span class="sourceLineNo">2053</span><a name="line.2053"></a>
<span class="sourceLineNo">2054</span>            Top.super.pack();<a name="line.2054"></a>
<span class="sourceLineNo">2055</span><a name="line.2055"></a>
<span class="sourceLineNo">2056</span>            if (_centering) {<a name="line.2056"></a>
<span class="sourceLineNo">2057</span>                centerOnScreen();<a name="line.2057"></a>
<span class="sourceLineNo">2058</span>            }<a name="line.2058"></a>
<span class="sourceLineNo">2059</span>            _menuPopulated = true;<a name="line.2059"></a>
<span class="sourceLineNo">2060</span>        }<a name="line.2060"></a>
<span class="sourceLineNo">2061</span>    }<a name="line.2061"></a>
<span class="sourceLineNo">2062</span><a name="line.2062"></a>
<span class="sourceLineNo">2063</span>    /** A runnable for executing deferred actions. */<a name="line.2063"></a>
<span class="sourceLineNo">2064</span>    static class DeferredActionsRunnable implements Runnable {<a name="line.2064"></a>
<span class="sourceLineNo">2065</span>        @Override<a name="line.2065"></a>
<span class="sourceLineNo">2066</span>        public void run() {<a name="line.2066"></a>
<span class="sourceLineNo">2067</span>            _executeDeferredActions();<a name="line.2067"></a>
<span class="sourceLineNo">2068</span>        }<a name="line.2068"></a>
<span class="sourceLineNo">2069</span>    }<a name="line.2069"></a>
<span class="sourceLineNo">2070</span><a name="line.2070"></a>
<span class="sourceLineNo">2071</span>    /** A runnable for closing the window. */<a name="line.2071"></a>
<span class="sourceLineNo">2072</span>    class CloseWindowRunnable implements Runnable {<a name="line.2072"></a>
<span class="sourceLineNo">2073</span>        @Override<a name="line.2073"></a>
<span class="sourceLineNo">2074</span>        public void run() {<a name="line.2074"></a>
<span class="sourceLineNo">2075</span>            _close();<a name="line.2075"></a>
<span class="sourceLineNo">2076</span>        }<a name="line.2076"></a>
<span class="sourceLineNo">2077</span>    }<a name="line.2077"></a>
<span class="sourceLineNo">2078</span><a name="line.2078"></a>
<span class="sourceLineNo">2079</span>    /** A runnable for centering the window on the screen. */<a name="line.2079"></a>
<span class="sourceLineNo">2080</span>    class CenterOnScreenRunnable implements Runnable {<a name="line.2080"></a>
<span class="sourceLineNo">2081</span>        @Override<a name="line.2081"></a>
<span class="sourceLineNo">2082</span>        public void run() {<a name="line.2082"></a>
<span class="sourceLineNo">2083</span>            Toolkit tk = Toolkit.getDefaultToolkit();<a name="line.2083"></a>
<span class="sourceLineNo">2084</span>            setLocation((tk.getScreenSize().width - getSize().width) / 2,<a name="line.2084"></a>
<span class="sourceLineNo">2085</span>                    (tk.getScreenSize().height - getSize().height) / 2);<a name="line.2085"></a>
<span class="sourceLineNo">2086</span><a name="line.2086"></a>
<span class="sourceLineNo">2087</span>            // Make this the default context for modal messages.<a name="line.2087"></a>
<span class="sourceLineNo">2088</span>            UndeferredGraphicalMessageHandler.setContext(Top.this);<a name="line.2088"></a>
<span class="sourceLineNo">2089</span>        }<a name="line.2089"></a>
<span class="sourceLineNo">2090</span>    }<a name="line.2090"></a>
<span class="sourceLineNo">2091</span><a name="line.2091"></a>
<span class="sourceLineNo">2092</span>    /** A runnable for setting the background color of the status bar. */<a name="line.2092"></a>
<span class="sourceLineNo">2093</span>    class SetBackgroundRunnable implements Runnable {<a name="line.2093"></a>
<span class="sourceLineNo">2094</span>        @Override<a name="line.2094"></a>
<span class="sourceLineNo">2095</span>        public void run() {<a name="line.2095"></a>
<span class="sourceLineNo">2096</span>            Top.super.setBackground(_statusBarBackground);<a name="line.2096"></a>
<span class="sourceLineNo">2097</span><a name="line.2097"></a>
<span class="sourceLineNo">2098</span>            // This seems to be called in a base class<a name="line.2098"></a>
<span class="sourceLineNo">2099</span>            // constructor, before this variable has been<a name="line.2099"></a>
<span class="sourceLineNo">2100</span>            // set. Hence the test against null.<a name="line.2100"></a>
<span class="sourceLineNo">2101</span>            if (_statusBar != null) {<a name="line.2101"></a>
<span class="sourceLineNo">2102</span>                _statusBar.setBackground(_statusBarBackground);<a name="line.2102"></a>
<span class="sourceLineNo">2103</span>            }<a name="line.2103"></a>
<span class="sourceLineNo">2104</span>        }<a name="line.2104"></a>
<span class="sourceLineNo">2105</span>    }<a name="line.2105"></a>
<span class="sourceLineNo">2106</span><a name="line.2106"></a>
<span class="sourceLineNo">2107</span>    /** Listener for windowClosing action. */<a name="line.2107"></a>
<span class="sourceLineNo">2108</span>    class CloseWindowAdapter extends WindowAdapter {<a name="line.2108"></a>
<span class="sourceLineNo">2109</span>        @Override<a name="line.2109"></a>
<span class="sourceLineNo">2110</span>        public void windowClosing(WindowEvent e) {<a name="line.2110"></a>
<span class="sourceLineNo">2111</span>            if (_debugClosing) {<a name="line.2111"></a>
<span class="sourceLineNo">2112</span>                System.out.println("Top$CloseWindowAdapter.windowClosing() : "<a name="line.2112"></a>
<span class="sourceLineNo">2113</span>                        + Top.this.getName());<a name="line.2113"></a>
<span class="sourceLineNo">2114</span>            }<a name="line.2114"></a>
<span class="sourceLineNo">2115</span><a name="line.2115"></a>
<span class="sourceLineNo">2116</span>            Window window = e.getWindow();<a name="line.2116"></a>
<span class="sourceLineNo">2117</span>            if (window instanceof Top) {<a name="line.2117"></a>
<span class="sourceLineNo">2118</span>                Top top = (Top) window;<a name="line.2118"></a>
<span class="sourceLineNo">2119</span>                if (!top.isDisposed()) {<a name="line.2119"></a>
<span class="sourceLineNo">2120</span>                    _close();<a name="line.2120"></a>
<span class="sourceLineNo">2121</span>                }<a name="line.2121"></a>
<span class="sourceLineNo">2122</span>            }<a name="line.2122"></a>
<span class="sourceLineNo">2123</span>        }<a name="line.2123"></a>
<span class="sourceLineNo">2124</span>    }<a name="line.2124"></a>
<span class="sourceLineNo">2125</span><a name="line.2125"></a>
<span class="sourceLineNo">2126</span>    /** Listener for history menu commands. */<a name="line.2126"></a>
<span class="sourceLineNo">2127</span>    class HistoryMenuListener implements ActionListener {<a name="line.2127"></a>
<span class="sourceLineNo">2128</span>        @Override<a name="line.2128"></a>
<span class="sourceLineNo">2129</span>        public void actionPerformed(ActionEvent event) {<a name="line.2129"></a>
<span class="sourceLineNo">2130</span>            // Make this the default context for modal messages.<a name="line.2130"></a>
<span class="sourceLineNo">2131</span>            UndeferredGraphicalMessageHandler.setContext(Top.this);<a name="line.2131"></a>
<span class="sourceLineNo">2132</span><a name="line.2132"></a>
<span class="sourceLineNo">2133</span>            JMenuItem target = (JMenuItem) event.getSource();<a name="line.2133"></a>
<span class="sourceLineNo">2134</span>            String path = target.getActionCommand();<a name="line.2134"></a>
<span class="sourceLineNo">2135</span><a name="line.2135"></a>
<span class="sourceLineNo">2136</span>            File file = new File(path);<a name="line.2136"></a>
<span class="sourceLineNo">2137</span><a name="line.2137"></a>
<span class="sourceLineNo">2138</span>            // See if the file is still there.<a name="line.2138"></a>
<span class="sourceLineNo">2139</span>            if (!file.exists()) {<a name="line.2139"></a>
<span class="sourceLineNo">2140</span>                MessageHandler.error("File no longer exists.");<a name="line.2140"></a>
<span class="sourceLineNo">2141</span>                try {<a name="line.2141"></a>
<span class="sourceLineNo">2142</span>                    _updateHistory(path, true);<a name="line.2142"></a>
<span class="sourceLineNo">2143</span>                } catch (IOException ex2) {<a name="line.2143"></a>
<span class="sourceLineNo">2144</span>                    // Ignore<a name="line.2144"></a>
<span class="sourceLineNo">2145</span>                }<a name="line.2145"></a>
<span class="sourceLineNo">2146</span>                return;<a name="line.2146"></a>
<span class="sourceLineNo">2147</span>            }<a name="line.2147"></a>
<span class="sourceLineNo">2148</span><a name="line.2148"></a>
<span class="sourceLineNo">2149</span>            // Try to read the file.<a name="line.2149"></a>
<span class="sourceLineNo">2150</span>            try {<a name="line.2150"></a>
<span class="sourceLineNo">2151</span>                _read(file.toURI().toURL());<a name="line.2151"></a>
<span class="sourceLineNo">2152</span>            } catch (Exception e) {<a name="line.2152"></a>
<span class="sourceLineNo">2153</span>                MessageHandler.error("Error reading " + file.getAbsolutePath(),<a name="line.2153"></a>
<span class="sourceLineNo">2154</span>                        e);<a name="line.2154"></a>
<span class="sourceLineNo">2155</span>                try {<a name="line.2155"></a>
<span class="sourceLineNo">2156</span>                    _updateHistory(path, true);<a name="line.2156"></a>
<span class="sourceLineNo">2157</span>                } catch (IOException ex2) {<a name="line.2157"></a>
<span class="sourceLineNo">2158</span>                    // Ignore<a name="line.2158"></a>
<span class="sourceLineNo">2159</span>                }<a name="line.2159"></a>
<span class="sourceLineNo">2160</span>                return;<a name="line.2160"></a>
<span class="sourceLineNo">2161</span>            }<a name="line.2161"></a>
<span class="sourceLineNo">2162</span><a name="line.2162"></a>
<span class="sourceLineNo">2163</span>            // Try to move the file to the top of the history menu.<a name="line.2163"></a>
<span class="sourceLineNo">2164</span>            try {<a name="line.2164"></a>
<span class="sourceLineNo">2165</span>                _updateHistory(path, false);<a name="line.2165"></a>
<span class="sourceLineNo">2166</span>            } catch (IOException e) {<a name="line.2166"></a>
<span class="sourceLineNo">2167</span>                MessageHandler.error("Error updating history file.", e);<a name="line.2167"></a>
<span class="sourceLineNo">2168</span>                return;<a name="line.2168"></a>
<span class="sourceLineNo">2169</span>            }<a name="line.2169"></a>
<span class="sourceLineNo">2170</span><a name="line.2170"></a>
<span class="sourceLineNo">2171</span>            setDirectory(file.getParentFile());<a name="line.2171"></a>
<span class="sourceLineNo">2172</span>        }<a name="line.2172"></a>
<span class="sourceLineNo">2173</span>    }<a name="line.2173"></a>
<span class="sourceLineNo">2174</span><a name="line.2174"></a>
<span class="sourceLineNo">2175</span>    ///////////////////////////////////////////////////////////////////<a name="line.2175"></a>
<span class="sourceLineNo">2176</span>    ////                         private variables                 ////<a name="line.2176"></a>
<span class="sourceLineNo">2177</span><a name="line.2177"></a>
<span class="sourceLineNo">2178</span>    /** An ActionListener for the menu items in the file menu. */<a name="line.2178"></a>
<span class="sourceLineNo">2179</span>    private FileMenuListener _fileMenuListener;<a name="line.2179"></a>
<span class="sourceLineNo">2180</span><a name="line.2180"></a>
<span class="sourceLineNo">2181</span>    /** An ActionListener for the menu items in the help menu. */<a name="line.2181"></a>
<span class="sourceLineNo">2182</span>    private HelpMenuListener _helpMenuListener;<a name="line.2182"></a>
<span class="sourceLineNo">2183</span><a name="line.2183"></a>
<span class="sourceLineNo">2184</span>    /** An ActionListener for the menu items in the history menu. */<a name="line.2184"></a>
<span class="sourceLineNo">2185</span>    private HistoryMenuListener _historyMenuListener;<a name="line.2185"></a>
<span class="sourceLineNo">2186</span><a name="line.2186"></a>
<span class="sourceLineNo">2187</span>    /** A reference to the history menu. */<a name="line.2187"></a>
<span class="sourceLineNo">2188</span>    private JMenu _historyMenu;<a name="line.2188"></a>
<span class="sourceLineNo">2189</span><a name="line.2189"></a>
<span class="sourceLineNo">2190</span>    /** A mapping of history menu to history menu listener for all open Top<a name="line.2190"></a>
<span class="sourceLineNo">2191</span>     *  windows.<a name="line.2191"></a>
<span class="sourceLineNo">2192</span>     */<a name="line.2192"></a>
<span class="sourceLineNo">2193</span>    private static Map&lt;JMenu, HistoryMenuListener&gt; _historyMenusAndListeners = Collections<a name="line.2193"></a>
<span class="sourceLineNo">2194</span>            .synchronizedMap(new WeakHashMap&lt;JMenu, HistoryMenuListener&gt;());<a name="line.2194"></a>
<span class="sourceLineNo">2195</span><a name="line.2195"></a>
<span class="sourceLineNo">2196</span>    /** The background color of the status bar */<a name="line.2196"></a>
<span class="sourceLineNo">2197</span>    private Color _statusBarBackground;<a name="line.2197"></a>
<span class="sourceLineNo">2198</span><a name="line.2198"></a>
<span class="sourceLineNo">2199</span>    /** Indicator of whether actions are deferred. */<a name="line.2199"></a>
<span class="sourceLineNo">2200</span>    private static boolean _actionsDeferred = false;<a name="line.2200"></a>
<span class="sourceLineNo">2201</span><a name="line.2201"></a>
<span class="sourceLineNo">2202</span>    // A flag indicating whether or not to center the window.<a name="line.2202"></a>
<span class="sourceLineNo">2203</span>    private boolean _centering = true;<a name="line.2203"></a>
<span class="sourceLineNo">2204</span><a name="line.2204"></a>
<span class="sourceLineNo">2205</span>    /** List of deferred actions. */<a name="line.2205"></a>
<span class="sourceLineNo">2206</span>    private static List _deferredActions = new LinkedList();<a name="line.2206"></a>
<span class="sourceLineNo">2207</span><a name="line.2207"></a>
<span class="sourceLineNo">2208</span>    /** True if this frame has been disposed. */<a name="line.2208"></a>
<span class="sourceLineNo">2209</span>    private boolean _disposed = false;<a name="line.2209"></a>
<span class="sourceLineNo">2210</span><a name="line.2210"></a>
<span class="sourceLineNo">2211</span>    /** The input file. */<a name="line.2211"></a>
<span class="sourceLineNo">2212</span>    private File _file = null;<a name="line.2212"></a>
<span class="sourceLineNo">2213</span><a name="line.2213"></a>
<span class="sourceLineNo">2214</span>    /** Flag to hide the menu bar. */<a name="line.2214"></a>
<span class="sourceLineNo">2215</span>    private boolean _hideMenuBar = false;<a name="line.2215"></a>
<span class="sourceLineNo">2216</span><a name="line.2216"></a>
<span class="sourceLineNo">2217</span>    /** History depth. */<a name="line.2217"></a>
<span class="sourceLineNo">2218</span>    private int _historyDepth = 10;<a name="line.2218"></a>
<span class="sourceLineNo">2219</span><a name="line.2219"></a>
<span class="sourceLineNo">2220</span>    /** The most recently entered URL in Open URL. */<a name="line.2220"></a>
<span class="sourceLineNo">2221</span>    private String _lastURL = "http://ptolemy.eecs.berkeley.edu/xml/models/";<a name="line.2221"></a>
<span class="sourceLineNo">2222</span><a name="line.2222"></a>
<span class="sourceLineNo">2223</span>    /** Last status message clearing task. */<a name="line.2223"></a>
<span class="sourceLineNo">2224</span>    private TimerTask _lastStatusMessageClearingTask = null;<a name="line.2224"></a>
<span class="sourceLineNo">2225</span><a name="line.2225"></a>
<span class="sourceLineNo">2226</span>    /** Indicator that the menu has been populated. */<a name="line.2226"></a>
<span class="sourceLineNo">2227</span>    private boolean _menuPopulated = false;<a name="line.2227"></a>
<span class="sourceLineNo">2228</span><a name="line.2228"></a>
<span class="sourceLineNo">2229</span>    /** Indicator that the data represented in the window has been modified. */<a name="line.2229"></a>
<span class="sourceLineNo">2230</span>    private boolean _modified = false;<a name="line.2230"></a>
<span class="sourceLineNo">2231</span><a name="line.2231"></a>
<span class="sourceLineNo">2232</span>    /** True if we have printed the securityException message. */<a name="line.2232"></a>
<span class="sourceLineNo">2233</span>    private static boolean _printedSecurityExceptionMessage = false;<a name="line.2233"></a>
<span class="sourceLineNo">2234</span><a name="line.2234"></a>
<span class="sourceLineNo">2235</span>    /** Timer used for status messages. */<a name="line.2235"></a>
<span class="sourceLineNo">2236</span>    private Timer _statusMessageTimer;<a name="line.2236"></a>
<span class="sourceLineNo">2237</span>}<a name="line.2237"></a>




























































</pre>
</div>
</body>
</html>
